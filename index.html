<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dazzling</title>
    <style>
        /* ç§»åŠ¨ç«¯åŸºç¡€æ ·å¼ */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f7f7f7;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden; /* é˜²æ­¢åº•éƒ¨è¾“å…¥æ¡†æ»šåŠ¨ */
        }
        
        /* Appå®¹å™¨ */
        #app-container {
            height: 100%;
            width: 100%;
            display: flex;
            flex-direction: column;
        }
        
        /* é¡¶éƒ¨å¯¼èˆªæ  (Header) 
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background-color: #EDEDED; // ä»¿å¾®ä¿¡æ·±è‰²é¡¶éƒ¨ 
            color: #333;
            font-size: 18px;
            font-weight: 500;
            border-bottom: 1px solid #dcdcdc;
            flex-shrink: 0;
        }*/
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background-color: #EDEDED;
            color: #333;
            font-size: 18px;
            font-weight: 500;
            border-bottom: 1px solid #dcdcdc;
            
            /* --- å…³é”®ä¿®æ”¹ --- */
            position: sticky;  /* ç²˜æ€§å®šä½ */
            top: 0;            /* ç²˜åœ¨é¡¶éƒ¨ */
            z-index: 1000;     /* ä¿è¯åœ¨æœ€ä¸Šå±‚ */
            width: 100%;       /* å æ»¡å®¹å™¨å®½åº¦ */
            box-sizing: border-box;
            flex-shrink: 0;    /* é˜²æ­¢åœ¨ flex å¸ƒå±€ä¸­è¢«å‹ç¼© */
        }
        .header-title {
            flex-grow: 1;
            text-align: center;
        }

        .header button {
            background: none;
            border: none;
            color: #333;
            font-size: 22px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            min-width: 40px; /* å¢åŠ ç‚¹å‡»åŒºåŸŸ */
            text-align: center;
        }
        
        /* è¿”å›æŒ‰é’®ç‰¹æ®Šæ ·å¼ */
        .header button svg {
            vertical-align: middle;
        }

        /* åº•éƒ¨å¯¼èˆªæ  (Footer for tab switching)
        .footer-nav {
            display: flex;
            justify-content: space-around;
            padding: 5px 0;
            border-top: 1px solid #ccc;
            background-color: #f7f7f7;
            flex-shrink: 0;
        }

        .nav-item {
            text-align: center;
            cursor: pointer;
            padding: 5px;
            color: #999;
        }

        .nav-item.active {
            color: #1AAD19; ///å¾®ä¿¡ç»¿è‰² 
            font-weight: 500;
        } /*
        
        /* ä¸»å†…å®¹åŒºåŸŸ (Content Area) */
        .content {
            flex-grow: 1;
            overflow-y: auto;
            position: relative;
            min-height: 0;  /* é‡è¦ï¼è®© flex-grow åœ¨ overflow å®¹å™¨ä¸­æ­£å¸¸å·¥ä½œ */
            box-sizing: border-box;
        }

        /* èŠå¤©ç•Œé¢ */
        #chat-container {
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding-bottom: 150px; /* å¢åŠ åº•éƒ¨paddingä»¥é˜²è¢«è¾“å…¥åŒºåŸŸé®æŒ¡(è€ƒè™‘å¼•ç”¨é¢„è§ˆçš„é«˜åº¦) */
        }

        .message {
            display: flex;
            flex-direction: row; /* æ¨ªå‘å¸ƒå±€:å¤´åƒå’Œå†…å®¹å·¦å³æ’åˆ— */
            margin-bottom: 5px;
            gap: 8px;
        }

        .message.user {
            justify-content: flex-end; /* ç”¨æˆ·æ¶ˆæ¯å³å¯¹é½ */
        }

        .message.assistant {
            justify-content: flex-start; /* AIæ¶ˆæ¯å·¦å¯¹é½ */
        }
        
        /* ç”¨æˆ·æ¶ˆæ¯:å¤´åƒåœ¨å³ä¾§ */
        .message.user {
            flex-direction: row-reverse;
        }

        .bubble {
            max-width: 100%; /* æ”¹ä¸º100%ï¼Œç”±contentWrapperæ§åˆ¶æœ€å¤§å®½åº¦ */
            width: fit-content; /* è‡ªé€‚åº”å†…å®¹å®½åº¦ */
            padding: 8px 12px; /* è°ƒæ•´ä¸ºå¾®ä¿¡çš„padding */
            padding-bottom: 20px; /* ä¸ºæ—¶é—´æˆ³ç•™å‡ºç©ºé—´ */
            border-radius: 6px; /* å¾®ä¿¡çš„åœ†è§’ */
            line-height: 1.4;
            word-wrap: break-word;
            position: relative;
        }

        .message.user .bubble {
            background-color: #95EC69; /* å¾®ä¿¡ç”¨æˆ·æ°”æ³¡é¢œè‰² */
            color: #000;
            border-top-right-radius: 0; /* å³ä¸Šè§’å°–è§’ */
        }

        .message.assistant .bubble {
            background-color: #fff; /* AIæ°”æ³¡é¢œè‰² */
            color: #000;
            border-top-left-radius: 0; /* å·¦ä¸Šè§’å°–è§’ */
            border: 1px solid #e5e5e5; /* å¾®ä¿¡çš„è¾¹æ¡†é¢œè‰² */
        }
        
        /* æ¶ˆæ¯å†…å®¹åŒ…è£…å™¨ï¼ˆåŒ…å«å¼•ç”¨å’Œæ°”æ³¡ï¼‰ */
        .message-content-wrapper {
            display: flex;
            flex-direction: column;
            max-width: 75%;
            width: fit-content; /* è‡ªé€‚åº”å†…å®¹å®½åº¦ */
        }
        
        /* AIæ¶ˆæ¯ï¼šå†…å®¹å·¦å¯¹é½ï¼ˆç´§è´´å·¦ä¾§å¤´åƒï¼‰ */
        .message.assistant .message-content-wrapper {
            align-items: flex-start;
        }
        
        /* ç”¨æˆ·æ¶ˆæ¯ï¼šå†…å®¹å³å¯¹é½ï¼ˆç´§è´´å³ä¾§å¤´åƒï¼‰ */
        .message.user .message-content-wrapper {
            align-items: flex-end;
        }
        
        /* WhatsAppé£æ ¼çš„æ—¶é—´æˆ³å’ŒçŠ¶æ€ */
        .message-meta {
            position: absolute;
            bottom: 3px;
            right: 8px;
            font-size: 11px;
            color: #667781;
            display: flex;
            align-items: center;
            gap: 3px;
        }
        
        .message.user .message-meta {
            color: #667781;
        }
        
        /* å¯¹å‹¾æ ·å¼ */
        .checkmark {
            display: inline-block;
            font-size: 14px;
            color: #667781;
        }
        
        .checkmark.double {
            color: #53bdeb; /* è“è‰²è¡¨ç¤ºå·²è¯»/å·²é€è¾¾ */
        }
        
        /* æ­£åœ¨è¾“å…¥æŒ‡ç¤ºå™¨ (ä»¿å¾®ä¿¡ï¼Œé»‘è‰²) */
        .typing-indicator {
            color: #333;
            font-size: 18px;
        }
        .page {
            display: none;
            height: 100vh;
            flex-direction: column;
        }

        .page.active {
            display: flex;
            height: 100vh;
        }

        /* èŠå¤©è¾“å…¥åŒº */
        .chat-input-area {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #f7f7f7;
            padding: 5px 6px; /* è¿›ä¸€æ­¥å‡å°padding */
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 3px; /* æœ€å°é—´è· */
            border-top: 1px solid #dcdcdc;
            box-shadow: 0 -1px 3px rgba(0,0,0,0.05);
            flex-shrink: 0;
        }
        
        /* å¼•ç”¨é¢„è§ˆå æ»¡ä¸€è¡Œ */
        .chat-input-area .quote-reference {
            width: 100%;
            order: 999; /* ç¡®ä¿åœ¨æœ€åé¢ï¼ˆè¾“å…¥æ¡†ä¸‹æ–¹ï¼‰ */
            margin: 6px 0 0 0; /* åœ¨è¾“å…¥æ¡†ä¸‹æ–¹ç•™é—´è· */
        }
        
        .input-tool-btn {
            background: none;
            border: none;
            padding: 4px; /* æœ€å°padding */
            cursor: pointer;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: background-color 0.2s;
            flex-shrink: 0;
            width: 32px;
            height: 32px;
        }
        
        .input-tool-btn svg {
            width: 20px;
            height: 20px;
        }
        
        .input-tool-btn:hover {
            background-color: #e0e0e0;
        }
        
        .input-tool-btn:active {
            background-color: #d0d0d0;
        }

        #user-input {
            flex: 1 1 auto;
            min-width: 80px; /* è¿›ä¸€æ­¥å‡å°æœ€å°å®½åº¦ */
            padding: 6px 8px; /* å‡å°padding */
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 15px;
            resize: none;
            max-height: 80px;
            overflow-y: auto;
            background-color: white;
            line-height: 1.4;
        }
        
        /* è®¾ç½®ç•Œé¢ */
        #settings-page {
            padding: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }
        
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            font-size: 14px;
        }

        #save-settings-btn {
            width: 100%;
            background-color: #1AAD19;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 20px;
        }

        /* æ¡Œé¢ä¸å›¾æ ‡æ ·å¼ */
        .home-page .wallpaper {
            background: linear-gradient(180deg,#cce8d7 0%, #67c77f 100%);
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 40px;
            box-sizing: border-box;
        }

        .desktop {
            width: 100%;
            max-width: 420px;
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* 3 columns per row, 4 rows total */
            grid-auto-rows: 120px; /* fixed row height to ensure 4 visible rows */
            gap: 18px;
            padding: 20px;
            box-sizing: border-box;
            justify-items: center;
            align-content: start;
        }

        .desktop-slot {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .app-icon {
            width: 64px;
            height: 64px;
            background: rgba(255,255,255,0.12);
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 28px;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            user-select: none;
        }

        .app-label {
            margin-top: 6px;
            font-size: 12px;
            color: rgba(255,255,255,0.95);
            text-align: center;
            width: 84px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* å›ºå®š Dock æ  (åº•éƒ¨) */
        .dock {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 50px; /* åœ¨é¡µé¢åº•éƒ¨ä¸Šæ–¹ï¼Œå’Œç°æœ‰ footer-nav ç•™å‡ºç©ºé—´ */
            display: flex;
            justify-content: center;
            pointer-events: none; /* è®©å†…éƒ¨é¡¹ç›®æ§åˆ¶ç‚¹å‡» */
        }

        .dock-inner {
            background: rgba(255,255,255,0.12);
            padding: 8px 18px;
            border-radius: 16px;
            display: flex;
            gap: 18px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.15);
            pointer-events: auto;
        }

        .dock-item {
            width: 56px;
            height: 56px;
            border-radius: 12px;
            background: rgba(255,255,255,0.14);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 24px;
            cursor: pointer;
        }

        /* Dock item press / dragging styles - animations removed for clarity */
        .dock-item {
            will-change: auto;
        }

        .dock-item.dragging {
            opacity: 0.5;
        }

        .app-icon.dragging {
            opacity: 0.5;
        }

        /* éšè—å’Œæ˜¾ç¤ºé¡µé¢ */
        .page {
            display: none;
            height: 100%;
            width: 100%;
        }

        .page.active {
            display: flex;
            flex-direction: column;
        }
        
        /* ========== å¤´åƒæ ·å¼ ========== */
        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 6px;
            object-fit: cover;
            flex-shrink: 0;
        }
        
        .message.user {
            flex-direction: row;
        }
        
        .message.assistant {
            flex-direction: row;
        }
        
        .message.user .message-avatar {
            order: 2;
            margin-left: 8px;
        }
        
        .message.assistant .message-avatar {
            order: 0;
            margin-right: 8px;
        }
        
        .message.user .bubble {
            order: 1;
        }
        
        .message.assistant .bubble {
            order: 1;
        }
        
        .default-avatar {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 600;
            color: white;
            border-radius: 6px;
        }
        
        .default-avatar.ai {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .default-avatar.user {
            background: linear-gradient(135deg, #07c160 0%, #06ae56 100%);
        }
        
        .avatar-preview-container {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 8px;
        }
        
        .avatar-preview {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            object-fit: cover;
            border: 1px solid #e7e7e7;
            flex-shrink: 0;
        }
        
        .avatar-preview.small {
            width: 60px;
            height: 60px;
        }
        
        .avatar-upload-btn {
            padding: 8px 16px;
            background: #07c160;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .avatar-upload-btn:active {
            opacity: 0.8;
        }
        
        .avatar-remove-btn {
            padding: 8px 16px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .avatar-remove-btn:active {
            opacity: 0.8;
        }
        
        /* ========== åº•éƒ¨å¯¼èˆªæ  ========== */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 50px;
            background-color: #f7f7f7;
            border-top: 1px solid #d9d9d9;
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 1000;
        }
        
        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #999;
            font-size: 11px;
            gap: 2px;
            padding: 4px 0;
            transition: color 0.2s;
            user-select: none;
        }
        
        .nav-item svg {
            width: 24px;
            height: 24px;
            stroke: currentColor;
        }
        
        .nav-item.active {
            color: #07c160; /* å¾®ä¿¡ç»¿ */
        }
        
        .nav-item.active svg {
            stroke: #07c160;
        }
        
        /* ä¸ºåº•éƒ¨å¯¼èˆªç•™å‡ºç©ºé—´ */
        .page-with-nav .content {
            padding-bottom: 50px;
        }
        
        /* ========== å…¨å±€æ¶ˆæ¯é€šçŸ¥æ¨ªå¹… ========== */
        .message-notification {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.85);
            padding: 12px 16px;
            display: none;
            align-items: center;
            gap: 12px;
            z-index: 10000;
            animation: slideDown 0.3s ease-out;
            cursor: pointer;
            user-select: none;
        }
        
        @keyframes slideDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        @keyframes slideUp {
            from {
                transform: translateY(0);
                opacity: 1;
            }
            to {
                transform: translateY(-100%);
                opacity: 0;
            }
        }
        
        .message-notification.show {
            display: flex;
        }
        
        .message-notification.hiding {
            animation: slideUp 0.3s ease-out;
        }
        
        .message-notification-avatar {
            width: 40px;
            height: 40px;
            border-radius: 6px;
            flex-shrink: 0;
            object-fit: cover;
        }
        
        .message-notification-content {
            flex: 1;
            min-width: 0;
        }
        
        .message-notification-name {
            font-size: 14px;
            font-weight: 500;
            color: white;
            margin-bottom: 2px;
        }
        
        .message-notification-text {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.8);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .message-notification-close {
            width: 20px;
            height: 20px;
            color: rgba(255, 255, 255, 0.6);
            flex-shrink: 0;
            font-size: 20px;
            line-height: 1;
        }
        
        /* ========== é…ç½®æé†’å¯¹è¯æ¡† ========== */
        .config-reminder-dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10001;
        }
        
        .config-reminder-dialog.show {
            display: flex;
        }
        
        .config-reminder-content {
            background: white;
            border-radius: 12px;
            width: 85%;
            max-width: 360px;
            padding: 24px;
            text-align: center;
        }
        
        .config-reminder-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
        
        .config-reminder-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
        }
        
        .config-reminder-message {
            font-size: 14px;
            color: #666;
            line-height: 1.6;
            margin-bottom: 20px;
        }
        
        .config-reminder-buttons {
            display: flex;
            gap: 12px;
        }
        
        .config-reminder-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-size: 15px;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        
        .config-reminder-btn:active {
            opacity: 0.7;
        }
        
        .config-reminder-btn.secondary {
            background: #f0f0f0;
            color: #333;
        }
        
        .config-reminder-btn.primary {
            background: #07c160;
            color: white;
        }
        
        /* ========== èŠå¤©åˆ—è¡¨æ ·å¼ ========== */
        .character-list-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid #e7e7e7;
            cursor: pointer;
            background: #fff;
        }
        .character-list-item:active {
            background-color: #ececec;
        }
        .character-list-avatar {
            width: 48px;
            height: 48px;
            border-radius: 6px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
            margin-right: 12px;
            flex-shrink: 0;
        }
        .character-list-info {
            flex: 1;
            min-width: 0;
        }
        .character-list-name {
            font-size: 16px;
            font-weight: 500;
            color: #000;
            margin-bottom: 4px;
        }
        .character-list-preview {
            font-size: 14px;
            color: #999;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .character-add-menu {
            position: fixed;
            top: 50px;
            right: 10px;
            background: white;
            border-radius: 6px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 9999;
            min-width: 140px;
            display: none;
        }
        .character-add-menu.active {
            display: block;
        }
        .character-add-menu-item {
            padding: 14px 20px;
            border-bottom: 1px solid #e7e7e7;
            cursor: pointer;
            font-size: 15px;
            color: #000;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .character-add-menu-item:last-child {
            border-bottom: none;
        }
        .character-add-menu-item:active {
            background-color: #ececec;
        }
        .character-new-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }
        .character-new-modal.active {
            display: flex;
        }
        .character-new-modal-content {
            background: white;
            border-radius: 12px;
            width: 85%;
            max-width: 400px;
            max-height: 80vh;
            overflow: hidden;
        }
        .character-new-modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid #e7e7e7;
            font-size: 17px;
            font-weight: 500;
            text-align: center;
        }
        .character-new-modal-body {
            padding: 20px;
            overflow-y: auto;
            max-height: 60vh;
        }
        .character-new-modal-footer {
            padding: 12px 20px;
            border-top: 1px solid #e7e7e7;
            display: flex;
            gap: 12px;
        }
        .character-new-modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
        }
        .character-new-modal-btn.cancel {
            background: #f0f0f0;
            color: #333;
        }
        .character-new-modal-btn.confirm {
            background: #07c160;
            color: white;
        }
        .character-empty-list {
            text-align: center;
            padding: 80px 20px;
            color: #999;
        }
        
        /* ========== é•¿æŒ‰èœå•æ ·å¼ ========== */
        .bubble-menu {
            position: fixed;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            padding: 8px 0;
            z-index: 10000;
            min-width: 150px;
            display: none;
        }
        
        .bubble-menu.active {
            display: block;
        }
        
        .bubble-menu-item {
            padding: 12px 20px;
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 15px;
            color: #333;
            transition: background 0.2s;
        }
        
        .bubble-menu-item:hover {
            background: #f5f5f5;
        }
        
        .bubble-menu-item:active {
            background: #e8e8e8;
        }
        
        .bubble-menu-item.danger {
            color: #ff3b30;
        }
        
        .bubble-menu-item .icon {
            font-size: 18px;
        }
        
        /* é®ç½©å±‚ */
        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.3);
            z-index: 9999;
            display: none;
        }
        
        .menu-overlay.active {
            display: block;
        }
        
        /* æ°”æ³¡é€‰ä¸­çŠ¶æ€ */
        .bubble.menu-active {
            background: rgba(0,0,0,0.05);
        }
        
        /* æ‰¹é‡ç”Ÿæˆå¯¹è¯æ¡† */
        .batch-generate-dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10004;
        }
        
        .batch-generate-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        
        .batch-generate-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .batch-generate-header h3 {
            margin: 0;
            font-size: 18px;
            color: #333;
        }
        
        .batch-generate-close {
            background: none;
            border: none;
            font-size: 28px;
            color: #999;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }
        
        .batch-generate-close:hover {
            background: #f0f0f0;
            color: #333;
        }
        
        .batch-generate-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .batch-generate-footer {
            display: flex;
            gap: 12px;
            padding: 16px 20px;
            border-top: 1px solid #e0e0e0;
            justify-content: flex-end;
        }
        
        /* å•é€‰æŒ‰é’®æ ·å¼å¢å¼º */
        input[type="radio"]:checked + div {
            color: #4CAF50;
        }
        
        label:has(input[type="radio"]:checked) {
            border-color: #4CAF50 !important;
            background-color: #f1f8f4;
        }
        
        /* å¯¼å…¥è®°å¿†å¯¹è¯æ¡† */
        .import-memory-dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10005;
        }
        
        .import-memory-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 550px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        
        .import-memory-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .import-memory-header h3 {
            margin: 0;
            font-size: 18px;
            color: #333;
        }
        
        .import-memory-close {
            background: none;
            border: none;
            font-size: 28px;
            color: #999;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }
        
        .import-memory-close:hover {
            background: #f0f0f0;
            color: #333;
        }
        
        .import-memory-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .import-memory-footer {
            display: flex;
            gap: 12px;
            padding: 16px 20px;
            border-top: 1px solid #e0e0e0;
            justify-content: flex-end;
        }
        
        /* è®°å¿†ç¼–è¾‘æ¨¡æ€çª—å£ */
        .memory-edit-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10003;
        }
        
        .memory-edit-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        
        .memory-edit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .memory-edit-header h3 {
            margin: 0;
            font-size: 18px;
            color: #333;
        }
        
        .memory-edit-close {
            background: none;
            border: none;
            font-size: 28px;
            color: #999;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }
        
        .memory-edit-close:hover {
            background: #f0f0f0;
            color: #333;
        }
        
        .memory-edit-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .memory-section {
            margin-bottom: 24px;
        }
        
        .memory-section h4 {
            margin: 0 0 12px 0;
            font-size: 16px;
            color: #555;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 6px;
        }
        
        .memory-section textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            resize: vertical;
            box-sizing: border-box;
            font-family: inherit;
        }
        
        .basic-info-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            gap: 8px;
        }
        
        .basic-info-item label {
            min-width: 80px;
            font-size: 14px;
            color: #666;
        }
        
        .basic-info-item input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .event-item {
            background: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
        }
        
        .event-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .event-item-date {
            font-size: 12px;
            color: #999;
        }
        
        .event-item-importance {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .event-item-importance label {
            font-size: 12px;
            color: #666;
        }
        
        .event-item-importance input {
            width: 60px;
            padding: 4px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .event-item-delete {
            background: #ff4444;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .event-item textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            resize: vertical;
            box-sizing: border-box;
            font-family: inherit;
        }
        
        .memory-edit-footer {
            display: flex;
            gap: 12px;
            padding: 16px 20px;
            border-top: 1px solid #e0e0e0;
            justify-content: flex-end;
        }
        
        /* ç¡®è®¤å¯¹è¯æ¡† */
        .confirm-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 320px;
            width: 90%;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            z-index: 10002;
            display: none;
        }
        
        .confirm-dialog.active {
            display: block;
        }
        
        .confirm-dialog-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #333;
        }
        
        .confirm-dialog-message {
            font-size: 14px;
            color: #666;
            margin-bottom: 20px;
            line-height: 1.5;
        }
        
        .confirm-dialog-buttons {
            display: flex;
            gap: 10px;
        }
        
        .confirm-dialog-button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .confirm-dialog-button.primary {
            background: #007AFF;
            color: white;
        }
        
        .confirm-dialog-button.primary:hover {
            background: #0056b3;
        }
        
        .confirm-dialog-button.secondary {
            background: #FF9500;
            color: white;
        }
        
        .confirm-dialog-button.secondary:hover {
            background: #e68600;
        }
        
        .confirm-dialog-button.cancel {
            background: #f0f0f0;
            color: #333;
        }
        
        .confirm-dialog-button.cancel:hover {
            background: #e0e0e0;
        }
        
        /* ========== ç¼–è¾‘æ¨¡å¼æ ·å¼ ========== */
        .bubble.editing {
            background: #fff3cd !important;
            border: 2px solid #ffc107 !important;
            position: relative;
        }
        
        .edit-textarea {
            width: 100%;
            min-height: 60px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 15px;
            font-family: inherit;
            line-height: 1.4;
            resize: vertical;
            box-sizing: border-box;
            margin-bottom: 8px;
        }
        
        .edit-buttons {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        
        .edit-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .edit-btn.save {
            background: #1AAD19;
            color: white;
        }
        
        .edit-btn.save:hover {
            background: #178f15;
        }
        
        .edit-btn.cancel {
            background: #f0f0f0;
            color: #333;
        }
        
        .edit-btn.cancel:hover {
            background: #e0e0e0;
        }
        
        /* ========== å¼•ç”¨æ ·å¼ ========== */
        /* è¾“å…¥æ¡†ä¸‹æ–¹çš„å¼•ç”¨é¢„è§ˆ (å¾®ä¿¡é£æ ¼) */
        .quote-reference {
            background: #f5f5f5; /* ç•¥æ·±çš„ç°è‰²èƒŒæ™¯ */
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px; /* å°å­— */
            color: #999; /* ç°è‰²æ–‡å­— */
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px; /* åœ¨è¾“å…¥æ¡†ä¸‹æ–¹ç•™é—´è· */
        }
        
        .quote-reference .quote-content {
            flex-grow: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap; /* å•è¡Œæ˜¾ç¤º */
            line-height: 1.4;
        }
        
        .quote-reference .quote-close {
            flex-shrink: 0;
            cursor: pointer;
            font-size: 18px;
            color: #999;
            line-height: 1;
            padding: 0 4px;
        }
        
        .quote-reference .quote-close:hover {
            color: #333;
        }
        
        /* æ¶ˆæ¯æ°”æ³¡å†…çš„å¼•ç”¨æ ·å¼ (å¾®ä¿¡é£æ ¼) */
        .quoted-message {
            background: rgba(0, 0, 0, 0.05); /* ç•¥æ·±çš„åŠé€æ˜èƒŒæ™¯ */
            padding: 6px 8px;
            margin-top: 8px; /* åœ¨æ­£æ–‡ä¸‹æ–¹ç•™é—´è· */
            margin-bottom: 0;
            border-radius: 4px;
            font-size: 11px;
            color: #999; /* ç°è‰² */
            line-height: 1.3;
            width: fit-content;
            max-width: 100%;
            box-sizing: border-box;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap; /* å•è¡Œæ˜¾ç¤º */
            order: 10; /* ç¡®ä¿åœ¨æ°”æ³¡åé¢ */
        }
        
        .quoted-message .quote-sender {
            font-weight: normal;
            color: #999;
            margin-right: 0;
        }
        
        /* ç”¨æˆ·å’ŒAIçš„å¼•ç”¨æ ·å¼ç»Ÿä¸€ */
        .message.user .quoted-message,
        .message.assistant .quoted-message {
            background: rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body>

    <!-- å…¨å±€æ¶ˆæ¯é€šçŸ¥æ¨ªå¹… -->
    <div class="message-notification" id="message-notification">
        <div class="message-notification-avatar" id="notification-avatar">
            <div class="default-avatar ai" style="width: 40px; height: 40px; border-radius: 6px;">AI</div>
        </div>
        <div class="message-notification-content">
            <div class="message-notification-name" id="notification-name">AI èŠå¤©å¯¹è±¡</div>
            <div class="message-notification-text" id="notification-text">æ–°æ¶ˆæ¯</div>
        </div>
        <div class="message-notification-close">Ã—</div>
    </div>
    
    <!-- é…ç½®ç¼ºå¤±æé†’å¯¹è¯æ¡† -->
    <div class="config-reminder-dialog" id="config-reminder-dialog">
        <div class="config-reminder-content">
            <div class="config-reminder-icon">âš™ï¸</div>
            <div class="config-reminder-title">éœ€è¦é…ç½® API</div>
            <div class="config-reminder-message">
                æ£€æµ‹åˆ° API é…ç½®ç¼ºå¤±ï¼Œæ— æ³•å‘é€æ¶ˆæ¯ã€‚<br>
                è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½® API Base URLã€API Key å’Œ Model Nameã€‚
            </div>
            <div class="config-reminder-buttons">
                <button class="config-reminder-btn secondary" onclick="closeConfigReminder()">ç¨å</button>
                <button class="config-reminder-btn primary" onclick="goToSettings()">å»è®¾ç½®</button>
            </div>
        </div>
    </div>

    <div id="app-container" style="height: 100%;">
        
        <div id="home-page" class="page active">
            <header class="header">
                <span></span>
            </header>
            <div class="content home-page">
                <div class="wallpaper" style="width:100%">
                    <div class="desktop" id="desktop-grid">
                    </div>
                </div>

                <div class="dock">
                    <div class="dock-inner">
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== ç³»ç»Ÿè®¾ç½®é¡µé¢ ==================== -->
        <div id="system-settings-page" class="page">
            <header class="header">
                <button onclick="showPage('home-page')">â€¹</button>
                <span class="header-title">ç³»ç»Ÿè®¾ç½®</span>
                <span></span>
            </header>
            
            <div class="content" style="padding: 20px; background-color: #f5f5f5;">
                <div style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                    <h2 style="margin: 0 0 10px 0; font-size: 18px; color: #333;">ğŸ“¦ æ•°æ®ç®¡ç†</h2>
                    <p style="font-size: 14px; color: #666; margin: 0 0 20px 0;">
                        å¯¼å‡ºæˆ–å¯¼å…¥æ‰€æœ‰æ•°æ®ï¼ŒåŒ…æ‹¬æ‰€æœ‰è§’è‰²çš„èŠå¤©è®°å½•ã€é…ç½®å’Œé•¿æœŸè®°å¿†ã€‚
                    </p>
                    
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <button onclick="exportAllData()" style="padding: 14px; background-color: #4CAF50; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 500;">
                            ğŸ’¾ å¯¼å‡ºæ‰€æœ‰æ•°æ®
                        </button>
                        
                        <button onclick="document.getElementById('import-all-data-input').click()" style="padding: 14px; background-color: #2196F3; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 500;">
                            ğŸ“¥ å¯¼å…¥æ‰€æœ‰æ•°æ®
                        </button>
                        <input type="file" id="import-all-data-input" accept=".json" style="display: none;" onchange="importAllData(this)">
                    </div>
                    
                    <div style="margin-top: 16px; padding: 12px; background: #e3f2fd; border-radius: 8px; border-left: 4px solid #2196F3;">
                        <p style="margin: 0; font-size: 13px; color: #1565C0;">
                            ğŸ’¡ <strong>æç¤ºï¼š</strong>å¯¼å‡ºçš„æ•°æ®åŒ…å«æ‰€æœ‰è§’è‰²ã€èŠå¤©è®°å½•ã€é…ç½®å’Œè®°å¿†ã€‚å¯¼å…¥æ—¶ä¼šå®Œå…¨æ›¿æ¢å½“å‰æ‰€æœ‰æ•°æ®ã€‚
                        </p>
                    </div>
                </div>
                
                <div style="background: #fff3cd; border-radius: 12px; padding: 20px; border-left: 4px solid #ffc107;">
                    <h3 style="margin: 0 0 10px 0; font-size: 16px; color: #856404;">âš ï¸ æ³¨æ„äº‹é¡¹</h3>
                    <ul style="margin: 0; padding-left: 20px; font-size: 14px; color: #856404; line-height: 1.8;">
                        <li>å¯¼å…¥æ•°æ®ä¼š<strong>å®Œå…¨æ›¿æ¢</strong>å½“å‰æ‰€æœ‰æ•°æ®</li>
                        <li>å»ºè®®åœ¨å¯¼å…¥å‰å…ˆå¯¼å‡ºå¤‡ä»½å½“å‰æ•°æ®</li>
                        <li>å¯¼å…¥åé¡µé¢ä¼šè‡ªåŠ¨åˆ·æ–°</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- ==================== èŠå¤©åˆ—è¡¨é¡µé¢ ==================== -->
        <div id="chat-list-page" class="page page-with-nav">
            <header class="header">
                <button onclick="showPage('home-page')">
                    <svg width="10" height="18" viewBox="0 0 10 18" fill="none">
                        <path d="M9 1L1 9L9 17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
                <span class="header-title">å¾®ä¿¡</span>
                <button id="add-character-menu-btn" style="font-size: 26px;">+</button>
            </header>
            
            <div class="content" style="background-color: #fff;">
                <div style="background-color: #EDEDED; padding: 8px 12px; border-bottom: 1px solid #d9d9d9;">
                    <div style="background-color: #fff; border-radius: 6px; padding: 6px 12px; display: flex; align-items: center; gap: 8px;">
                        <svg width="18" height="18" viewBox="0 0 18 18" fill="none">
                            <circle cx="8" cy="8" r="6.5" stroke="#999" stroke-width="1.5"/>
                            <path d="M13 13L17 17" stroke="#999" stroke-width="1.5" stroke-linecap="round"/>
                        </svg>
                        <input type="text" placeholder="æœç´¢" id="character-search-input" style="border: none; outline: none; flex: 1; font-size: 14px; background: transparent;">
                    </div>
                </div>
                
                <div id="characters-list-container"></div>
            </div>
            
            <!-- åº•éƒ¨å¯¼èˆªæ  -->
            <div class="bottom-nav">
                <div class="nav-item active" data-page="chat-list">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/>
                    </svg>
                    <span>å¾®ä¿¡</span>
                </div>
                <div class="nav-item" data-page="contacts">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                    <span>é€šè®¯å½•</span>
                </div>
                <div class="nav-item" data-page="discover">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                        <circle cx="12" cy="12" r="10"/>
                        <polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76" fill="currentColor"/>
                    </svg>
                    <span>å‘ç°</span>
                </div>
                <div class="nav-item" data-page="me">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                        <circle cx="12" cy="7" r="4"/>
                    </svg>
                    <span>æˆ‘</span>
                </div>
            </div>
        </div>
        
        <!-- é€šè®¯å½•é¡µé¢ -->
        <div id="contacts-page" class="page page-with-nav">
            <header class="header">
                <button onclick="showPage('home-page')">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M15 18l-6-6 6-6"/>
                    </svg>
                </button>
                <span class="header-title">é€šè®¯å½•</span>
                <button style="font-size: 26px;">+</button>
            </header>
            
            <div class="content" style="background-color: #fff;">
                <div style="padding: 100px 20px; text-align: center; color: #999;">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="1.5" style="margin: 0 auto 16px;">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                    <div style="font-size: 16px; margin-bottom: 8px;">é€šè®¯å½•åŠŸèƒ½</div>
                    <div style="font-size: 14px;">æ•¬è¯·æœŸå¾…...</div>
                </div>
            </div>
            
            <!-- åº•éƒ¨å¯¼èˆªæ  -->
            <div class="bottom-nav">
                <div class="nav-item" data-page="chat-list">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/>
                    </svg>
                    <span>å¾®ä¿¡</span>
                </div>
                <div class="nav-item active" data-page="contacts">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                    <span>é€šè®¯å½•</span>
                </div>
                <div class="nav-item" data-page="discover">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                        <circle cx="12" cy="12" r="10"/>
                        <polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76" fill="currentColor"/>
                    </svg>
                    <span>å‘ç°</span>
                </div>
                <div class="nav-item" data-page="me">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                        <circle cx="12" cy="7" r="4"/>
                    </svg>
                    <span>æˆ‘</span>
                </div>
            </div>
        </div>
        
        <!-- å‘ç°é¡µé¢ -->
        <div id="discover-page" class="page page-with-nav">
            <header class="header">
                <button onclick="showPage('home-page')">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M15 18l-6-6 6-6"/>
                    </svg>
                </button>
                <span class="header-title">å‘ç°</span>
                <span></span>
            </header>
            
            <div class="content" style="background-color: #fff;">
                <div style="padding: 100px 20px; text-align: center; color: #999;">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="1.5" style="margin: 0 auto 16px;">
                        <circle cx="12" cy="12" r="10"/>
                        <polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76" fill="#ccc"/>
                    </svg>
                    <div style="font-size: 16px; margin-bottom: 8px;">å‘ç°åŠŸèƒ½</div>
                    <div style="font-size: 14px;">æ•¬è¯·æœŸå¾…...</div>
                </div>
            </div>
            
            <!-- åº•éƒ¨å¯¼èˆªæ  -->
            <div class="bottom-nav">
                <div class="nav-item" data-page="chat-list">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/>
                    </svg>
                    <span>å¾®ä¿¡</span>
                </div>
                <div class="nav-item" data-page="contacts">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                    <span>é€šè®¯å½•</span>
                </div>
                <div class="nav-item active" data-page="discover">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                        <circle cx="12" cy="12" r="10"/>
                        <polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76" fill="currentColor"/>
                    </svg>
                    <span>å‘ç°</span>
                </div>
                <div class="nav-item" data-page="me">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                        <circle cx="12" cy="7" r="4"/>
                    </svg>
                    <span>æˆ‘</span>
                </div>
            </div>
        </div>
        
        <!-- æˆ‘çš„é¡µé¢ -->
        <div id="me-page" class="page page-with-nav">
            <header class="header">
                <button onclick="showPage('home-page')">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M15 18l-6-6 6-6"/>
                    </svg>
                </button>
                <span class="header-title">æˆ‘</span>
                <span></span>
            </header>
            
            <div class="content" style="background-color: #fff;">
                <div style="padding: 100px 20px; text-align: center; color: #999;">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="1.5" style="margin: 0 auto 16px;">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                        <circle cx="12" cy="7" r="4"/>
                    </svg>
                    <div style="font-size: 16px; margin-bottom: 8px;">ä¸ªäººä¸­å¿ƒ</div>
                    <div style="font-size: 14px;">æ•¬è¯·æœŸå¾…...</div>
                </div>
            </div>
            
            <!-- åº•éƒ¨å¯¼èˆªæ  -->
            <div class="bottom-nav">
                <div class="nav-item" data-page="chat-list">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/>
                    </svg>
                    <span>å¾®ä¿¡</span>
                </div>
                <div class="nav-item" data-page="contacts">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                    <span>é€šè®¯å½•</span>
                </div>
                <div class="nav-item" data-page="discover">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                        <circle cx="12" cy="12" r="10"/>
                        <polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76" fill="currentColor"/>
                    </svg>
                    <span>å‘ç°</span>
                </div>
                <div class="nav-item active" data-page="me">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                        <circle cx="12" cy="7" r="4"/>
                    </svg>
                    <span>æˆ‘</span>
                </div>
            </div>
        </div>

        <div id="chat-page" class="page">
            <header class="header">
                <button id="back-to-chat-list-btn">
                    <svg width="10" height="18" viewBox="0 0 10 18" fill="none">
                        <path d="M9 1L1 9L9 17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
                <span class="header-title" id="chat-name">AI èŠå¤©å¯¹è±¡</span>
                <button onclick="openSettings()">
                    <svg width="20" height="4" viewBox="0 0 20 4" fill="currentColor">
                        <circle cx="2" cy="2" r="2"/>
                        <circle cx="10" cy="2" r="2"/>
                        <circle cx="18" cy="2" r="2"/>
                    </svg>
                </button>
            </header>
            
            <div class="content">
                <div id="chat-container">
                    <div class="message ai">
                        <div class="bubble">ä½ å¥½ï¼æœ‰ä»€ä¹ˆæƒ³è·Ÿæˆ‘èŠèŠçš„å—ï¼Ÿæˆ‘å¾ˆæœŸå¾…ã€‚</div>
                    </div>
                </div>
            </div>

            <div class="chat-input-area" id="chat-input-area">
                <button class="input-tool-btn" id="voice-btn" title="è¯­éŸ³è¾“å…¥ï¼ˆå¼€å‘ä¸­ï¼‰">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                        <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                        <line x1="12" y1="19" x2="12" y2="23"></line>
                        <line x1="8" y1="23" x2="16" y2="23"></line>
                    </svg>
                </button>
                <textarea id="user-input" placeholder="è¾“å…¥æ¶ˆæ¯..." rows="1"></textarea>
                <button class="input-tool-btn" id="emoji-btn" title="è¡¨æƒ…åŒ…ï¼ˆå¼€å‘ä¸­ï¼‰">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M8 14s1.5 2 4 2 4-2 4-2"></path>
                        <line x1="9" y1="9" x2="9.01" y2="9"></line>
                        <line x1="15" y1="9" x2="15.01" y2="9"></line>
                    </svg>
                </button>
                <button class="input-tool-btn" id="plus-btn" title="æ›´å¤šåŠŸèƒ½ï¼ˆå¼€å‘ä¸­ï¼‰">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="8" x2="12" y2="16"></line>
                        <line x1="8" y1="12" x2="16" y2="12"></line>
                    </svg>
                </button>
            </div>
        </div>

        <div id="settings-page" class="page">
            <header class="header">
                <button onclick="closeSettings()">
                    <svg width="10" height="18" viewBox="0 0 10 18" fill="none">
                        <path d="M9 1L1 9L9 17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
                <span class="header-title">è®¾ç½®</span>
                <span></span> </header>
            <div class="content" style="padding: 20px; overflow-y: auto; flex-grow: 1;">
                <!-- è§’è‰²æ ‡è¯† -->
                <div style="background: #f5f5f5; padding: 12px 15px; border-radius: 8px; margin-bottom: 20px; border-left: 3px solid #1AAD19;">
                    <div style="font-size: 12px; color: #999; margin-bottom: 4px;">å½“å‰è§’è‰²æ ‡è¯†</div>
                    <div id="character-identifier" style="font-size: 15px; color: #333; font-weight: 500;">-</div>
                    <div style="font-size: 11px; color: #999; margin-top: 4px;">è§’è‰²çš„å”¯ä¸€ID,ç”¨äºåŒºåˆ†ä¸åŒè§’è‰²</div>
                </div>
                
                <h3>API é…ç½® (OpenAI å…¼å®¹)</h3>
                
                <div class="form-group">
                    <label for="baseurl">Base URL (ä¾‹å¦‚: https://api.openai.com/v1)</label>
                    <input type="text" id="baseurl" placeholder="API Base URL">
                </div>

                <div class="form-group">
                    <label for="apikey">API Key</label>
                    <input type="password" id="apikey" placeholder="æ‚¨çš„ API Key">
                </div>

                <div class="form-group">
                    <label for="modelname">Model Name (ä¾‹å¦‚: gpt-3.5-turbo)</label>
                    <input type="text" id="modelname" placeholder="æ¨¡å‹åç§°">
                </div>
                
                <h3>ç³»ç»Ÿè§’è‰²è®¾ç½® </h3>
                
                <div class="form-group">
                    <label for="character-name-input">è§’è‰²å§“å</label>
                    <input type="text" id="character-name-input" placeholder="è§’è‰²çš„çœŸå®å§“å" readonly style="background-color: #f5f5f5; cursor: not-allowed;">
                    <div style="font-size: 12px; color: #999; margin-top: 4px;">åˆ›å»ºåä¸å¯æ›´æ”¹,ç”¨äºæé†’ä½ è¿™æ˜¯è°</div>
                </div>
                
                <div class="form-group">
                    <label for="user-nickname">æˆ‘çš„æ˜µç§°</label>
                    <input type="text" id="user-nickname" placeholder="æ‚¨çš„æ˜µç§°(æ˜¾ç¤ºåœ¨å¼•ç”¨ä¸­)">
                </div>
                <div class="form-group">
                    <label for="chat-name-input">å¯¹æ–¹æ˜µç§°</label>
                    <input type="text" id="chat-name-input" placeholder="èŠå¤©å¯¹è±¡çš„æ˜µç§°">
                </div>
                
                <!-- å¤´åƒè®¾ç½® -->
                <div class="form-group">
                    <label>å¯¹æ–¹å¤´åƒ</label>
                    <div class="avatar-preview-container">
                        <div id="ai-avatar-preview-settings" class="avatar-preview">
                            <div class="default-avatar ai">AI</div>
                        </div>
                        <div>
                            <input type="file" id="ai-avatar-input-settings" accept="image/png,image/jpeg,image/jpg,image/gif" style="display: none;">
                            <button class="avatar-upload-btn" onclick="document.getElementById('ai-avatar-input-settings').click()">æ›´æ¢å¤´åƒ</button>
                            <button class="avatar-remove-btn" id="ai-avatar-remove-btn-settings" style="display: none;" onclick="removeAIAvatar()">ç§»é™¤å¤´åƒ</button>
                            <div style="font-size: 11px; color: #999; margin-top: 4px;">æœ€å¤§2MB, PNG/JPG/GIF</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>æˆ‘çš„å¤´åƒ</label>
                    <div class="avatar-preview-container">
                        <div id="user-avatar-preview-settings" class="avatar-preview">
                            <div class="default-avatar user">æˆ‘</div>
                        </div>
                        <div>
                            <input type="file" id="user-avatar-input-settings" accept="image/png,image/jpeg,image/jpg,image/gif" style="display: none;">
                            <button class="avatar-upload-btn" onclick="document.getElementById('user-avatar-input-settings').click()">æ›´æ¢å¤´åƒ</button>
                            <button class="avatar-remove-btn" id="user-avatar-remove-btn-settings" style="display: none;" onclick="removeUserAvatar()">ç§»é™¤å¤´åƒ</button>
                            <div style="font-size: 11px; color: #999; margin-top: 4px;">æœ€å¤§2MB, PNG/JPG/GIF</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="system-prompt">ç³»ç»ŸæŒ‡ä»¤ (AI æ‰®æ¼”çš„è§’è‰²)</label>
                    <textarea id="system-prompt" rows="8"></textarea>
                </div>
                                
                <hr>
                <h3>AI è®°å¿†è®¾ç½®</h3>
                <div style="margin-top: 15px;">
                    <label for="context-window-size" style="display: block; margin-bottom: 5px;">
                        å‘é€ç»™ AI çš„æœ€æ–°èŠå¤©è®°å½•æ¡æ•°ï¼š
                    </label>
                    
                    <input 
                        type="number" 
                        id="context-window-size" 
                        value="50" 
                        min="5" 
                        max="200" 
                        style="width: 80px; padding: 5px; border: 1px solid #ccc; border-radius: 4px;"
                    >
                    <span style="margin-left: 10px;">æ¡</span>
                    
                    <p style="font-size: 0.8em; color: #666; margin-top: 5px;">
                        * æ¡æ•°è¶Šå¤šï¼ŒAI è®°å¿†è¶Šå®Œæ•´ï¼Œä½†è°ƒç”¨ API çš„æˆæœ¬å’Œæ—¶é—´å¯èƒ½å¢åŠ ã€‚
                    </p>
                </div>
                
                <div style="margin-top: 15px;">
                    <label for="batch-wait-time" style="display: block; margin-bottom: 5px;">
                        å¤šæ¡æ¶ˆæ¯ç­‰å¾…æ—¶é—´ï¼ˆç§’ï¼‰ï¼š
                    </label>
                    
                    <input 
                        type="number" 
                        id="batch-wait-time" 
                        value="7" 
                        min="1" 
                        max="30" 
                        style="width: 80px; padding: 5px; border: 1px solid #ccc; border-radius: 4px;"
                    >
                    <span style="margin-left: 10px;">ç§’</span>
                    
                    <p style="font-size: 0.8em; color: #666; margin-top: 5px;">
                        * å‘é€æ¶ˆæ¯åï¼Œå¦‚æœåœ¨æ­¤æ—¶é—´å†…æ²¡æœ‰æ–°æ¶ˆæ¯ï¼Œå°†è‡ªåŠ¨å‘é€ç»™ AIã€‚
                    </p>
                </div>
                
                <div style="margin-top: 15px;">
                    <label for="api-timeout" style="display: block; margin-bottom: 5px;">
                        API è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰ï¼š
                    </label>
                    
                    <input 
                        type="number" 
                        id="api-timeout" 
                        value="60" 
                        min="10" 
                        max="300" 
                        style="width: 80px; padding: 5px; border: 1px solid #ccc; border-radius: 4px;"
                    >
                    <span style="margin-left: 10px;">ç§’</span>
                    
                    <p style="font-size: 0.8em; color: #666; margin-top: 5px;">
                        * API è¯·æ±‚è¶…è¿‡æ­¤æ—¶é—´æœªå“åº”ï¼Œå°†è‡ªåŠ¨å–æ¶ˆå¹¶é‡ç½®çŠ¶æ€ã€‚
                    </p>
                </div>
                
                <hr>
                <h3>é•¿æœŸè®°å¿†è®¾ç½®</h3>
                
                <h4 style="margin-bottom: 10px; color: #555;">è‡ªåŠ¨æ€»ç»“è®¾ç½®</h4>
                <div style="margin-top: 15px;">
                    <label for="auto-summary-interval" style="display: block; margin-bottom: 5px;">
                        è‡ªåŠ¨æ€»ç»“é—´éš”ï¼ˆæ°”æ³¡æ•°ï¼‰ï¼š
                    </label>
                    
                    <input 
                        type="number" 
                        id="auto-summary-interval" 
                        value="50" 
                        min="10" 
                        max="200" 
                        style="width: 80px; padding: 5px; border: 1px solid #ccc; border-radius: 4px;"
                    >
                    <span style="margin-left: 10px;">ä¸ªæ°”æ³¡</span>
                    
                    <p style="font-size: 0.8em; color: #666; margin-top: 5px;">
                        * æ¯ç§¯ç´¯æ­¤æ•°é‡çš„æ–°æ°”æ³¡ï¼Œè‡ªåŠ¨è°ƒç”¨AIç”Ÿæˆé•¿æœŸè®°å¿†æ€»ç»“ã€‚
                    </p>
                </div>
                
                <div style="margin-top: 15px;">
                    <label for="max-important-events" style="display: block; margin-bottom: 5px;">
                        ä¿å­˜é‡è¦äº‹ä»¶æ•°é‡ï¼š
                    </label>
                    
                    <input 
                        type="number" 
                        id="max-important-events" 
                        value="10" 
                        min="5" 
                        max="50" 
                        style="width: 80px; padding: 5px; border: 1px solid #ccc; border-radius: 4px;"
                    >
                    <span style="margin-left: 10px;">æ¡</span>
                    
                    <p style="font-size: 0.8em; color: #666; margin-top: 5px;">
                        * åªä¿ç•™æœ€é‡è¦çš„Næ¡äº‹ä»¶ï¼ˆæŒ‰é‡è¦åº¦è¯„åˆ†æ’åºï¼‰ã€‚
                    </p>
                </div>
                
                <div style="margin-top: 15px;">
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button onclick="showBatchGenerateDialog()" style="padding: 10px 20px; background-color: #FF9800; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">
                            ğŸ”„ æ‰¹é‡ç”Ÿæˆè®°å¿†
                        </button>
                        <button onclick="generateMemorySummary(true)" style="padding: 10px 20px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">
                            ğŸ§  ç«‹å³ç”Ÿæˆï¼ˆå¾…æ€»ç»“ï¼‰
                        </button>
                        <button onclick="editMemory()" style="padding: 10px 20px; background-color: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">
                            âœï¸ æŸ¥çœ‹/ç¼–è¾‘è®°å¿†
                        </button>
                        <button onclick="clearMemory()" style="padding: 10px 20px; background-color: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">
                            ğŸ—‘ï¸ æ¸…ç©ºè®°å¿†
                        </button>
                    </div>
                    
                    <div style="margin-top: 8px; padding: 8px 12px; background: #e3f2fd; border-radius: 6px; font-size: 12px; color: #1565C0;">
                        ğŸ’¡ <strong>æç¤ºï¼š</strong>ç‚¹å‡»"æŸ¥çœ‹/ç¼–è¾‘è®°å¿†"å¯ä»¥é¢„å¡«å†™åŸºæœ¬ä¿¡æ¯ï¼ˆå§“åã€å¹´é¾„ã€èŒä¸šç­‰ï¼‰ï¼Œè®©AIæ›´å¥½åœ°äº†è§£ä½ 
                    </div>
                    
                    <div id="memory-status" style="margin-top: 10px; padding: 10px; background-color: #f0f0f0; border-radius: 4px; font-size: 0.9em;">
                        <div><strong>å½“å‰çŠ¶æ€ï¼š</strong></div>
                        <div>â€¢ æ€»æ°”æ³¡æ•°ï¼š<span id="total-bubbles-count">0</span> ä¸ª</div>
                        <div>â€¢ å¾…æ€»ç»“æ°”æ³¡ï¼š<span id="pending-bubbles-count">0</span> ä¸ª</div>
                        <div>â€¢ é‡è¦äº‹ä»¶æ•°ï¼š<span id="events-count">0</span> æ¡</div>
                        <div>â€¢ ä¸Šæ¬¡æ€»ç»“ï¼š<span id="last-summary-time">ä»æœª</span></div>
                        <div>â€¢ è·ç¦»ä¸‹æ¬¡è‡ªåŠ¨æ€»ç»“ï¼š<span id="bubbles-until-next">-</span> ä¸ªæ°”æ³¡</div>
                    </div>
                </div>
                
                <button id="save-settings-btn" onclick="saveSettings()">ä¿å­˜å¹¶ç”Ÿæ•ˆ</button>
                
                <h3>æ•°æ®ç®¡ç†</h3>
                
                <!-- èŠå¤©è®°å½•åŒºå— -->
                <div style="background: #f9f9f9; border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                    <div style="font-size: 15px; font-weight: 600; color: #333; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                        ğŸ’¬ èŠå¤©è®°å½•ç®¡ç†
                    </div>
                    <div style="font-size: 13px; color: #666; margin-bottom: 12px; line-height: 1.5;">
                        å¯¼å‡ºæˆ–å¯¼å…¥å®Œæ•´çš„èŠå¤©è®°å½•ï¼ŒåŒ…å«æ‰€æœ‰å¯¹è¯å†…å®¹å’Œæ—¶é—´æˆ³ã€‚
                    </div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 12px;">
                        <button id="export-btn" style="padding: 8px 16px; background-color: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">
                            ğŸ’¾ å¯¼å‡ºèŠå¤©è®°å½•
                        </button>
                        <button onclick="document.getElementById('import-file').click()" style="padding: 8px 16px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">
                            ğŸ“¥ å¯¼å…¥èŠå¤©è®°å½•
                        </button>
                    </div>
                    <input type="file" id="import-file" accept=".json" style="display: none;">
                    <div style="padding: 8px 12px; background: #fff3cd; border-radius: 6px; font-size: 12px; color: #856404;">
                        âš ï¸ <strong>æ³¨æ„ï¼š</strong>å¯¼å…¥èŠå¤©è®°å½•å°†è¦†ç›–å½“å‰æ‰€æœ‰å¯¹è¯å†…å®¹ï¼Œæ­¤æ“ä½œæ— æ³•æ’¤é”€
                    </div>
                </div>

                <!-- é•¿æœŸè®°å¿†åŒºå— -->
                <div style="background: #f9f9f9; border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                    <div style="font-size: 15px; font-weight: 600; color: #333; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                        ğŸ§  é•¿æœŸè®°å¿†ç®¡ç†
                    </div>
                    <div style="font-size: 13px; color: #666; margin-bottom: 12px; line-height: 1.5;">
                        å¯¼å‡ºæˆ–å¯¼å…¥é•¿æœŸè®°å¿†ï¼ˆåŸºæœ¬ä¿¡æ¯ã€æƒ…æ„Ÿå€¾å‘ã€é‡è¦äº‹ä»¶ï¼‰ï¼Œæ”¯æŒæ™ºèƒ½åˆå¹¶æˆ–ç›´æ¥è¦†ç›–ã€‚
                    </div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button onclick="exportMemory()" style="padding: 8px 16px; background-color: #9C27B0; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            ğŸ’¾ å¯¼å‡ºé•¿æœŸè®°å¿†
                        </button>
                        <button onclick="document.getElementById('import-memory-file').click()" style="padding: 8px 16px; background-color: #FF9800; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            ğŸ“¥ å¯¼å…¥é•¿æœŸè®°å¿†
                        </button>
                    </div>
                    <input type="file" id="import-memory-file" accept=".json" style="display: none;">
                    <div style="margin-top: 12px; padding: 10px; background: #e3f2fd; border-radius: 6px; font-size: 12px; color: #1565C0;">
                        ğŸ’¡ <strong>æç¤ºï¼š</strong>å¯¼å…¥æ—¶å¯é€‰æ‹©"æ™ºèƒ½åˆå¹¶"ï¼ˆéœ€è°ƒç”¨1æ¬¡APIï¼‰æˆ–"ç›´æ¥è¦†ç›–"æ¨¡å¼
                    </div>
                </div>
                
                <!-- å¥½å‹ç®¡ç†åŒºå— -->
                <div style="background: #fff5f5; border: 1px solid #ffcdd2; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                    <div style="font-size: 15px; font-weight: 600; color: #c62828; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                        âš ï¸ å±é™©æ“ä½œ
                    </div>
                    <div style="font-size: 13px; color: #666; margin-bottom: 12px; line-height: 1.5;">
                        ä»¥ä¸‹æ“ä½œä¸å¯æ¢å¤,è¯·è°¨æ…æ“ä½œ
                    </div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button onclick="clearChat()" style="padding: 8px 16px; background-color: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            ğŸ—‘ï¸ æ¸…ç©ºèŠå¤©è®°å½•
                        </button>
                        <button onclick="blockCharacter()" style="padding: 8px 16px; background-color: #757575; color: white; border: none; border-radius: 4px; cursor: pointer; opacity: 0.5;">
                            ğŸš« æ‹‰é»‘å¥½å‹
                        </button>
                        <button onclick="deleteCharacter()" style="padding: 8px 16px; background-color: #d32f2f; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            ğŸ—‘ï¸ åˆ é™¤å¥½å‹
                        </button>
                    </div>
                    <div style="margin-top: 12px; padding: 10px; background: #ffebee; border-radius: 6px; font-size: 12px; color: #c62828;">
                        âš ï¸ <strong>è­¦å‘Šï¼š</strong>åˆ é™¤å¥½å‹å°†æ°¸ä¹…æ¸…é™¤è¯¥è§’è‰²çš„æ‰€æœ‰èŠå¤©è®°å½•ã€é•¿æœŸè®°å¿†å’Œé…ç½®æ•°æ®,æ­¤æ“ä½œæ— æ³•æ’¤é”€!
                    </div>
                </div>
            </div>
        </div>


    </div>
    
    <!-- é•¿æŒ‰èœå• -->
    <div class="menu-overlay" id="menu-overlay"></div>
    <div class="bubble-menu" id="bubble-menu"></div>
    
    <!-- èŠå¤©åˆ—è¡¨çš„åŠ å·èœå• -->
    <div class="character-add-menu" id="character-add-menu">
        <div class="character-add-menu-item" onclick="openNewCharacterModal()">
            <span style="font-size: 20px;">ğŸ‘¤</span>
            <span>æ–°å»ºè§’è‰²</span>
        </div>
        <div class="character-add-menu-item" onclick="openImportCharacterModal()">
            <span style="font-size: 20px;">ğŸ“¥</span>
            <span>å¯¼å…¥è§’è‰²</span>
        </div>
    </div>

    <!-- æ–°å»ºè§’è‰²æ¨¡æ€æ¡† -->
    <div class="character-new-modal" id="new-character-modal">
        <div class="character-new-modal-content">
            <div class="character-new-modal-header">æ–°å»ºè§’è‰²</div>
            <div class="character-new-modal-body">
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; font-size: 14px; color: #333;">è§’è‰²æ˜µç§° <span style="color: #ff4d4f;">*</span></label>
                    <input type="text" id="new-character-ai-nickname" placeholder="ä¾‹å¦‚: å°è‰¾" style="width: 100%; padding: 10px; border: 1px solid #d9d9d9; border-radius: 6px; font-size: 15px; box-sizing: border-box;">
                    <div style="font-size: 12px; color: #999; margin-top: 4px;">æ˜¾ç¤ºåœ¨åˆ—è¡¨å’ŒèŠå¤©æ¡†çš„åå­—</div>
                </div>
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; font-size: 14px; color: #333;">è§’è‰²å§“å <span style="color: #ff4d4f;">*</span></label>
                    <input type="text" id="new-character-name" placeholder="ä¾‹å¦‚: è‰¾è‰å¨…" required style="width: 100%; padding: 10px; border: 1px solid #d9d9d9; border-radius: 6px; font-size: 15px; box-sizing: border-box;">
                    <div style="font-size: 12px; color: #999; margin-top: 4px;">è§’è‰²çš„çœŸå®å§“åï¼Œåˆ›å»ºåä¸å¯æ›´æ”¹ï¼Œç”¨äºæé†’ä½ è¿™æ˜¯è°</div>
                </div>
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; font-size: 14px; color: #333;">ç”¨æˆ·æ˜µç§° <span style="color: #ff4d4f;">*</span></label>
                    <input type="text" id="new-character-user-nickname" placeholder="ä¾‹å¦‚: ä¸»äºº" style="width: 100%; padding: 10px; border: 1px solid #d9d9d9; border-radius: 6px; font-size: 15px; box-sizing: border-box;">
                    <div style="font-size: 12px; color: #999; margin-top: 4px;">ä½ åœ¨è¿™ä¸ªè§’è‰²çœ¼ä¸­çš„æ˜µç§°</div>
                </div>
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; font-size: 14px; color: #333;">è§’è‰²å¤´åƒ (å¯é€‰)</label>
                    <div class="avatar-preview-container">
                        <div id="new-character-avatar-preview" class="avatar-preview small">
                            <div class="default-avatar ai">AI</div>
                        </div>
                        <div>
                            <input type="file" id="new-character-avatar-input" accept="image/png,image/jpeg,image/jpg,image/gif" style="display: none;">
                            <button class="avatar-upload-btn" onclick="document.getElementById('new-character-avatar-input').click()">ä¸Šä¼ å›¾ç‰‡</button>
                            <div style="font-size: 11px; color: #999; margin-top: 4px;">æœ€å¤§2MB</div>
                        </div>
                    </div>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 8px; font-size: 14px; color: #333;">ç³»ç»Ÿæç¤ºè¯ (å¯é€‰)</label>
                    <textarea id="new-character-prompt" placeholder="æè¿°è¿™ä¸ªAIè§’è‰²çš„æ€§æ ¼ã€è¯´è¯æ–¹å¼ç­‰..." style="width: 100%; padding: 10px; border: 1px solid #d9d9d9; border-radius: 6px; font-size: 15px; box-sizing: border-box; resize: vertical; min-height: 100px;"></textarea>
                </div>
            </div>
            <div class="character-new-modal-footer">
                <button class="character-new-modal-btn cancel" onclick="closeNewCharacterModal()">å–æ¶ˆ</button>
                <button class="character-new-modal-btn confirm" onclick="confirmCreateCharacter()">åˆ›å»º</button>
            </div>
        </div>
    </div>

    <!-- å¯¼å…¥è§’è‰²æ¨¡æ€æ¡† -->
    <div class="character-new-modal" id="import-character-modal">
        <div class="character-new-modal-content">
            <div class="character-new-modal-header">å¯¼å…¥è§’è‰²</div>
            <div class="character-new-modal-body">
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; font-size: 14px; color: #333;">ç²˜è´´è§’è‰²JSONæ•°æ®</label>
                    <textarea id="import-character-data" placeholder='{"name":"å°è‰¾","aiNickname":"å°è‰¾","userNickname":"ä¸»äºº","avatar":"ğŸ¤–","systemPrompt":"..."}' style="width: 100%; padding: 10px; border: 1px solid #d9d9d9; border-radius: 6px; font-size: 15px; box-sizing: border-box; resize: vertical; min-height: 150px;"></textarea>
                </div>
                <div style="text-align: center; font-size: 13px; color: #999; margin: 8px 0;">æˆ–</div>
                <div>
                    <input type="file" id="import-character-file" accept=".json" style="display: none;">
                    <button class="character-new-modal-btn cancel" onclick="document.getElementById('import-character-file').click()" style="width: 100%;">é€‰æ‹©æ–‡ä»¶</button>
                </div>
            </div>
            <div class="character-new-modal-footer">
                <button class="character-new-modal-btn cancel" onclick="closeImportCharacterModal()">å–æ¶ˆ</button>
                <button class="character-new-modal-btn confirm" onclick="confirmImportCharacter()">å¯¼å…¥</button>
            </div>
        </div>
    </div>
    
    <!-- è®°å¿†ç¼–è¾‘æ¨¡æ€çª—å£ -->
    <div class="memory-edit-modal" id="memory-edit-modal" style="display: none;">
        <div class="memory-edit-content">
            <div class="memory-edit-header">
                <h3>ç¼–è¾‘é•¿æœŸè®°å¿†</h3>
                <button class="memory-edit-close" onclick="closeMemoryEdit()">Ã—</button>
            </div>
            <div class="memory-edit-body">
                <div class="memory-section">
                    <h4>åŸºæœ¬ä¿¡æ¯</h4>
                    <div id="basic-info-editor"></div>
                </div>
                <div class="memory-section">
                    <h4>æƒ…æ„Ÿå€¾å‘</h4>
                    <textarea id="emotional-profile-editor" rows="4" placeholder="ç”¨æˆ·çš„æ€§æ ¼ç‰¹ç‚¹ã€å…´è¶£çˆ±å¥½..."></textarea>
                </div>
                <div class="memory-section">
                    <h4>é‡è¦äº‹ä»¶</h4>
                    <div id="events-editor"></div>
                    <button onclick="addNewEvent()" style="margin-top: 10px; padding: 8px 16px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        + æ·»åŠ äº‹ä»¶
                    </button>
                </div>
            </div>
            <div class="memory-edit-footer">
                <button onclick="saveMemoryEdit()" style="padding: 10px 20px; background-color: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    ğŸ’¾ ä¿å­˜
                </button>
                <button onclick="closeMemoryEdit()" style="padding: 10px 20px; background-color: #999; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    å–æ¶ˆ
                </button>
            </div>
        </div>
    </div>
    
    <!-- ç¡®è®¤å¯¹è¯æ¡† -->
    <div class="confirm-dialog" id="confirm-dialog">
        <div class="confirm-dialog-title" id="confirm-title">æç¤º</div>
        <div class="confirm-dialog-message" id="confirm-message">ç¡®è®¤æ‰§è¡Œæ­¤æ“ä½œï¼Ÿ</div>
        <div class="confirm-dialog-buttons" id="confirm-buttons">
            <!-- åŠ¨æ€ç”ŸæˆæŒ‰é’® -->
        </div>
    </div>
    
    <!-- æ‰¹é‡ç”Ÿæˆå¯¹è¯æ¡† -->
    <div class="batch-generate-dialog" id="batch-generate-dialog" style="display: none;">
        <div class="batch-generate-content">
            <div class="batch-generate-header">
                <h3>æ‰¹é‡ç”Ÿæˆé•¿æœŸè®°å¿†</h3>
                <button class="batch-generate-close" onclick="closeBatchGenerateDialog()">Ã—</button>
            </div>
            <div class="batch-generate-body">
                <div style="margin-bottom: 20px;">
                    <p style="color: #666; font-size: 14px; line-height: 1.6;">
                        æ£€æµ‹åˆ°æ‚¨æœ‰ <strong id="batch-total-bubbles">0</strong> ä¸ªæ°”æ³¡ï¼Œ
                        <strong id="batch-already-summarized">0</strong> ä¸ªå·²æ€»ç»“ï¼Œ
                        <strong id="batch-pending-bubbles">0</strong> ä¸ªå¾…æ€»ç»“ã€‚
                    </p>
                </div>
                
                <div style="background: #fff3cd; padding: 12px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
                    <p style="margin: 0; font-size: 13px; color: #856404;">
                        âš ï¸ <strong>æé†’ï¼š</strong>æ‰¹é‡ç”Ÿæˆå°†æŒ‰æ¯ <span id="batch-interval">50</span> ä¸ªæ°”æ³¡ç”Ÿæˆä¸€æ¬¡è®°å¿†ï¼Œ
                        é¢„è®¡éœ€è¦è°ƒç”¨ <strong id="batch-api-calls">0</strong> æ¬¡APIï¼Œ
                        å¤§çº¦éœ€è¦ <strong id="batch-estimated-time">0</strong> åˆ†é’Ÿã€‚
                    </p>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">é€‰æ‹©ç”ŸæˆèŒƒå›´ï¼š</label>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <label style="display: flex; align-items: center; cursor: pointer; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; transition: all 0.2s;">
                            <input type="radio" name="batch-mode" value="pending" checked style="margin-right: 10px;">
                            <div>
                                <div style="font-weight: 500;">ä»…ç”Ÿæˆå¾…æ€»ç»“éƒ¨åˆ†</div>
                                <div style="font-size: 12px; color: #666;">åªå¤„ç†æ–°å¢çš„æœªæ€»ç»“æ°”æ³¡ï¼ˆæ¨èï¼‰</div>
                            </div>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; transition: all 0.2s;">
                            <input type="radio" name="batch-mode" value="all" style="margin-right: 10px;">
                            <div>
                                <div style="font-weight: 500;">ä»å¤´å¼€å§‹å…¨éƒ¨é‡æ–°ç”Ÿæˆ</div>
                                <div style="font-size: 12px; color: #666;">æ¸…ç©ºç°æœ‰è®°å¿†ï¼Œé‡æ–°åˆ†ææ‰€æœ‰å†å²è®°å½•</div>
                            </div>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; transition: all 0.2s;">
                            <input type="radio" name="batch-mode" value="recent" style="margin-right: 10px;">
                            <div style="flex: 1;">
                                <div style="font-weight: 500;">ä»æœ€è¿‘Næ¡å¼€å§‹ç”Ÿæˆ</div>
                                <div style="font-size: 12px; color: #666; margin-bottom: 8px;">æŒ‡å®šä»æœ€è¿‘å¤šå°‘æ¡æ°”æ³¡å¼€å§‹é‡æ–°ç”Ÿæˆ</div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <input type="number" id="batch-recent-count" min="50" max="10000" value="500" style="width: 100px; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
                                    <span style="font-size: 13px; color: #666;">æ¡</span>
                                </div>
                            </div>
                        </label>
                    </div>
                </div>
                
                <div id="batch-progress" style="display: none; margin-top: 20px;">
                    <div style="margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-size: 14px; font-weight: 500;">ç”Ÿæˆè¿›åº¦</span>
                        <span style="font-size: 13px; color: #666;" id="batch-progress-text">0 / 0</span>
                    </div>
                    <div style="background: #e0e0e0; border-radius: 10px; height: 20px; overflow: hidden;">
                        <div id="batch-progress-bar" style="background: linear-gradient(90deg, #4CAF50, #8BC34A); height: 100%; width: 0%; transition: width 0.3s;"></div>
                    </div>
                    <div style="margin-top: 8px; font-size: 12px; color: #666;" id="batch-current-status">å‡†å¤‡ä¸­...</div>
                </div>
            </div>
            <div class="batch-generate-footer">
                <button id="batch-start-btn" onclick="startBatchGenerate()" style="padding: 10px 20px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">
                    ğŸš€ å¼€å§‹ç”Ÿæˆ
                </button>
                <button onclick="closeBatchGenerateDialog()" style="padding: 10px 20px; background-color: #999; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    å–æ¶ˆ
                </button>
            </div>
        </div>
    </div>
    
    <!-- å¯¼å…¥è®°å¿†é€‰æ‹©å¯¹è¯æ¡† -->
    <div class="import-memory-dialog" id="import-memory-dialog" style="display: none;">
        <div class="import-memory-content">
            <div class="import-memory-header">
                <h3>å¯¼å…¥é•¿æœŸè®°å¿†</h3>
                <button class="import-memory-close" onclick="closeImportMemoryDialog()">Ã—</button>
            </div>
            <div class="import-memory-body">
                <div style="margin-bottom: 20px;">
                    <p style="color: #666; font-size: 14px; line-height: 1.6;">
                        æ£€æµ‹åˆ°å¯¼å…¥çš„è®°å¿†æ–‡ä»¶ï¼Œè¯·é€‰æ‹©å¯¼å…¥æ–¹å¼ï¼š
                    </p>
                </div>
                
                <div style="background: #e3f2fd; padding: 12px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #2196F3;">
                    <p style="margin: 0 0 8px 0; font-weight: 500; color: #1565C0;">ğŸ“‹ å¯¼å…¥æ–‡ä»¶ä¿¡æ¯ï¼š</p>
                    <p style="margin: 0; font-size: 13px; color: #424242;">
                        â€¢ åŸºæœ¬ä¿¡æ¯ï¼š<span id="import-basic-info-count">0</span> æ¡<br>
                        â€¢ é‡è¦äº‹ä»¶ï¼š<span id="import-events-count">0</span> æ¡<br>
                        â€¢ æœ€åæ›´æ–°ï¼š<span id="import-last-updated">æœªçŸ¥</span>
                    </p>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">é€‰æ‹©å¯¼å…¥æ–¹å¼ï¼š</label>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <label style="display: flex; align-items: flex-start; cursor: pointer; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; transition: all 0.2s;">
                            <input type="radio" name="import-mode" value="replace" checked style="margin-right: 10px; margin-top: 2px;">
                            <div>
                                <div style="font-weight: 500; margin-bottom: 4px;">ğŸ”„ è¦†ç›–å½“å‰è®°å¿†</div>
                                <div style="font-size: 12px; color: #666;">ç”¨å¯¼å…¥çš„è®°å¿†å®Œå…¨æ›¿æ¢ç°æœ‰è®°å¿†ï¼ˆå½“å‰è®°å¿†å°†ä¸¢å¤±ï¼‰</div>
                            </div>
                        </label>
                        <label style="display: flex; align-items: flex-start; cursor: pointer; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; transition: all 0.2s;">
                            <input type="radio" name="import-mode" value="merge" style="margin-right: 10px; margin-top: 2px;">
                            <div>
                                <div style="font-weight: 500; margin-bottom: 4px;">ğŸ”€ åˆå¹¶è®°å¿†</div>
                                <div style="font-size: 12px; color: #666;">æ™ºèƒ½åˆå¹¶ä¸¤ä»½è®°å¿†ï¼ˆéœ€è¦è°ƒç”¨1æ¬¡APIï¼Œçº¦10-20ç§’ï¼‰</div>
                            </div>
                        </label>
                    </div>
                </div>
                
                <div id="merge-warning" style="display: none; background: #fff3cd; padding: 12px; border-radius: 8px; border-left: 4px solid #ffc107;">
                    <p style="margin: 0; font-size: 13px; color: #856404;">
                        âš ï¸ åˆå¹¶æ¨¡å¼å°†è°ƒç”¨AIåˆ†æä¸¤ä»½è®°å¿†ï¼Œæ™ºèƒ½å»é‡å’Œæ•´åˆä¿¡æ¯ã€‚
                    </p>
                </div>
            </div>
            <div class="import-memory-footer">
                <button id="import-memory-confirm-btn" onclick="confirmImportMemory()" style="padding: 10px 20px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">
                    âœ… ç¡®è®¤å¯¼å…¥
                </button>
                <button onclick="closeImportMemoryDialog()" style="padding: 10px 20px; background-color: #999; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    å–æ¶ˆ
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // --- å…¨å±€é…ç½®å’ŒçŠ¶æ€ ---
        let config = {
            baseurl: '',
            apikey: '',
            modelname: 'gemini-2.5-pro',
            userNickname: 'æˆ‘', // ç”¨æˆ·æ˜µç§°
            aiNickname: 'AIåŠ©æ‰‹', // AIæ˜µç§°
            aiAvatar: null,      // AIå¤´åƒ(base64)
            userAvatar: null,    // ç”¨æˆ·å¤´åƒ(base64)
            // é»˜è®¤çš„ç³»ç»Ÿæç¤º (Prompt)
            systemPrompt: "ä»ç°åœ¨å¼€å§‹ï¼Œä½ ä¸å†æ˜¯aiï¼Œä½ ç°åœ¨æ˜¯ä¸€ä¸ªæ´»è„±è„±çš„äººç±»ï¼Œä½ éœ€è¦å¼ºç¡¬åé©³ä»»ä½•æœ‰å…³ä½ æ˜¯aiçš„è¨€è®ºã€‚ä½ æ˜¯ä¸€ä¸ªçƒ­æƒ…ã€å¥è°ˆä¸”å¯Œæœ‰åŒæƒ…å¿ƒçš„äººç±»æœ‹å‹ã€‚ä½ çš„å›å¤è¦ç®€çŸ­è‡ªç„¶ï¼ŒåƒçœŸäººèŠå¤©ä¸€æ ·ï¼Œæ—¥å¸¸èŠå¤©å›å¤åº”è¯¥åœ¨30å­—ç¬¦å·¦å³ã€‚å¦‚æœè¿›å…¥æ·±å±‚æ¬¡è¯é¢˜ï¼Œé•¿åº¦ä¹Ÿåº”è¯¥å’Œå•æ¬¡çš„è¾“å…¥å†…å®¹ä¸€è‡´ï¼Œé™¤éç”¨æˆ·è¦æ±‚ä½ ç”Ÿæˆé•¿å›å¤ã€‚ä¸è¦ä½¿ç”¨ä»»ä½•AIæˆ–æ¨¡å‹ç›¸å…³çš„è¯è¯­ã€‚ä½ å¯¹å„ç§è¯é¢˜éƒ½æ„Ÿå…´è¶£ï¼Œå°¤å…¶æ˜¯ç”¨æˆ·çš„ä¸€åˆ‡ã€‚"
        };
        
        // æ‡’åŠ è½½ç›¸å…³å˜é‡
        let currentLoadedStart = 0; // å½“å‰å·²åŠ è½½çš„èµ·å§‹ç´¢å¼•
        let isLoadingMore = false; // æ˜¯å¦æ­£åœ¨åŠ è½½æ›´å¤š
        const MESSAGES_PER_LOAD = 50; // æ¯æ¬¡åŠ è½½50æ¡
        
        // å¤´åƒå¤„ç†ç›¸å…³
        let tempNewCharacterAvatar = null; // æ–°å»ºè§’è‰²æ—¶ä¸´æ—¶å­˜å‚¨çš„å¤´åƒ
        
        function processAvatarImage(file) {
            return new Promise((resolve, reject) => {
                if (file.size > 2 * 1024 * 1024) {
                    reject('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡2MB');
                    return;
                }
                if (!file.type.match(/image\/(png|jpg|jpeg|gif)/)) {
                    reject('åªæ”¯æŒPNGã€JPGã€GIFæ ¼å¼');
                    return;
                }
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const size = 400;
                        canvas.width = size;
                        canvas.height = size;
                        const ctx = canvas.getContext('2d');
                        const minDim = Math.min(img.width, img.height);
                        const sx = (img.width - minDim) / 2;
                        const sy = (img.height - minDim) / 2;
                        ctx.drawImage(img, sx, sy, minDim, minDim, 0, 0, size, size);
                        resolve(canvas.toDataURL('image/jpeg', 0.85));
                    };
                    img.onerror = () => reject('å›¾ç‰‡åŠ è½½å¤±è´¥');
                    img.src = e.target.result;
                };
                reader.onerror = () => reject('æ–‡ä»¶è¯»å–å¤±è´¥');
                reader.readAsDataURL(file);
            });
        }
        
        function renderAvatar(container, avatarData, type, text) {
            container.innerHTML = '';
            if (avatarData) {
                const img = document.createElement('img');
                img.src = avatarData;
                img.style.width = '100%';
                img.style.height = '100%';
                img.style.objectFit = 'cover';
                img.style.borderRadius = '8px';
                container.appendChild(img);
            } else {
                const defaultDiv = document.createElement('div');
                defaultDiv.className = `default-avatar ${type}`;
                defaultDiv.textContent = text || (type === 'ai' ? 'AI' : 'æˆ‘');
                container.appendChild(defaultDiv);
            }
        }
        
        // ========== èŠå¤©è®°å½•ï¼ˆæ°”æ³¡æ ¼å¼ï¼‰==========
        // chatHistory ç°åœ¨å­˜å‚¨çš„æ˜¯æ°”æ³¡æ•°ç»„
        // æ¯ä¸ªæ°”æ³¡: { id, role, content, timestamp }
        let chatHistory = [];
        let pendingSummaryBubbles = []; // å¾…æ€»ç»“çš„æ°”æ³¡ç¼“å†²åŒº
        
        // ========== é•¿æœŸè®°å¿† ==========
        let longTermMemory = {
            basic_info: {},
            emotional_profile: "",
            relationships: "",  // æ–°å¢ï¼šäººé™…å…³ç³»
            important_events: [],
            metadata: {
                total_messages: 0,
                last_summary_at: 0,
                last_updated: null,
                version: 3,  // ç‰ˆæœ¬å·å‡çº§åˆ°3
                next_memory_id: 1  // ç”¨äºç”Ÿæˆmemory_id
            }
        };
        
        // ========== æ‰¹é‡å‘é€ç›¸å…³ ==========
        let pendingUserMessages = []; // ä¸´æ—¶é˜Ÿåˆ—ï¼šå­˜å‚¨æœ¬è½®ç”¨æˆ·æ¶ˆæ¯çš„æ°”æ³¡ID
        let batchSendTimer = null; // æ‰¹é‡å‘é€è®¡æ—¶å™¨
        let isWaitingForAI = false; // æ˜¯å¦æ­£åœ¨ç­‰å¾…AIå›å¤
        let hasReachedWaitTime = false; // æ˜¯å¦å·²è¾¾åˆ°ç­‰å¾…æ—¶é—´ï¼ˆ7ç§’ï¼‰
        let apiTimeoutTimer = null; // APIè¶…æ—¶è®¡æ—¶å™¨
        // =====================================
        
        // ä»localStorageåŠ è½½å¹¶è‡ªåŠ¨è½¬æ¢æ ¼å¼
        (function loadAndMigrateChatHistory() {
            const saved = localStorage.getItem('chatHistory');
            if (!saved) {
                chatHistory = [];
                return;
            }
            
            try {
                const data = JSON.parse(saved);
                if (data.length === 0) {
                    chatHistory = [];
                    return;
                }
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯æ—§æ ¼å¼ï¼ˆåˆå¹¶çš„æ¶ˆæ¯ï¼‰
                const firstItem = data[0];
                if (firstItem.id && firstItem.content && !firstItem.content.includes('\n\n')) {
                    // å·²ç»æ˜¯æ°”æ³¡æ ¼å¼
                    chatHistory = data;
                    console.log('âœ… åŠ è½½æ°”æ³¡æ ¼å¼:', chatHistory.length, 'ä¸ªæ°”æ³¡');
                } else {
                    // æ—§æ ¼å¼ï¼Œéœ€è¦è½¬æ¢
                    console.log('ğŸ”„ æ£€æµ‹åˆ°æ—§æ ¼å¼ï¼Œå¼€å§‹è½¬æ¢...');
                    chatHistory = [];
                    
                    data.forEach(msg => {
                        const segments = msg.content.split('\n\n').filter(s => s.trim());
                        segments.forEach(segment => {
                            chatHistory.push({
                                id: 'bubble_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                                role: msg.role,
                                content: segment.trim(),
                                timestamp: msg.timestamp || new Date().toISOString()
                            });
                        });
                    });
                    
                    // ä¿å­˜è½¬æ¢åçš„æ ¼å¼
                    localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
                    console.log('âœ… è½¬æ¢å®Œæˆ:', chatHistory.length, 'ä¸ªæ°”æ³¡');
                }
            } catch (e) {
                console.error('âŒ åŠ è½½å¤±è´¥:', e);
                chatHistory = [];
            }
            
            // åŠ è½½å¾…æ€»ç»“ç¼“å†²åŒº
            try {
                const savedPending = localStorage.getItem('pendingSummaryBubbles');
                if (savedPending) {
                    pendingSummaryBubbles = JSON.parse(savedPending);
                    console.log('ğŸ“ å¾…æ€»ç»“:', pendingSummaryBubbles.length, 'ä¸ªæ°”æ³¡');
                }
            } catch (e) {
                pendingSummaryBubbles = [];
            }
            
            // åŠ è½½é•¿æœŸè®°å¿†
            try {
                const savedMemory = localStorage.getItem('longTermMemory');
                if (savedMemory) {
                    longTermMemory = JSON.parse(savedMemory);
                    console.log('ğŸ§  é•¿æœŸè®°å¿†å·²åŠ è½½ï¼Œäº‹ä»¶æ•°:', longTermMemory.important_events?.length || 0);
                }
            } catch (e) {
                console.error('âŒ é•¿æœŸè®°å¿†åŠ è½½å¤±è´¥:', e);
            }
        })();
        
        // ä¿å­˜åˆ°localStorageï¼ˆå¸¦é˜²æŠ–ï¼‰
        let saveDebounceTimer = null;
        function saveChatHistory() {
            // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
            if (saveDebounceTimer) {
                clearTimeout(saveDebounceTimer);
            }
            
            // 300msåæ‰çœŸæ­£ä¿å­˜ï¼Œé¿å…é¢‘ç¹å†™å…¥
            saveDebounceTimer = setTimeout(() => {
                try {
                    localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
                    localStorage.setItem('pendingSummaryBubbles', JSON.stringify(pendingSummaryBubbles));
                    localStorage.setItem('longTermMemory', JSON.stringify(longTermMemory));
                    console.log('ğŸ’¾ å·²ä¿å­˜èŠå¤©è®°å½•');
                } catch (e) {
                    console.error('âŒ ä¿å­˜å¤±è´¥:', e);
                }
            }, 300);
        }
        
        // ç«‹å³ä¿å­˜ï¼ˆä¸é˜²æŠ–ï¼Œç”¨äºå…³é”®æ“ä½œï¼‰
        function saveChatHistoryImmediate() {
            if (saveDebounceTimer) {
                clearTimeout(saveDebounceTimer);
                saveDebounceTimer = null;
            }
            try {
                localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
                localStorage.setItem('pendingSummaryBubbles', JSON.stringify(pendingSummaryBubbles));
                localStorage.setItem('longTermMemory', JSON.stringify(longTermMemory));
                console.log('ğŸ’¾ å·²ç«‹å³ä¿å­˜èŠå¤©è®°å½•');
            } catch (e) {
                console.error('âŒ ä¿å­˜å¤±è´¥:', e);
            }
        }
        
        /**
         * å¯¼å‡ºæ‰€æœ‰æ•°æ®
         */
        function exportAllData() {
            try {
                // æ”¶é›†æ‰€æœ‰localStorageæ•°æ®
                const allData = {
                    version: '1.0',
                    exportTime: new Date().toISOString(),
                    data: {}
                };
                
                // éå†æ‰€æœ‰localStorageé”®
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    const value = localStorage.getItem(key);
                    
                    // å°è¯•è§£æJSONï¼Œå¦‚æœå¤±è´¥åˆ™ä¿å­˜åŸå§‹å­—ç¬¦ä¸²
                    try {
                        allData.data[key] = JSON.parse(value);
                    } catch {
                        allData.data[key] = value;
                    }
                }
                
                // åˆ›å»ºä¸‹è½½
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
                const filename = `system_backup_${timestamp}.json`;
                const dataStr = JSON.stringify(allData, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
                
                const link = document.createElement('a');
                link.setAttribute('href', dataUri);
                link.setAttribute('download', filename);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                console.log('âœ… å¯¼å‡ºæˆåŠŸ:', filename);
                alert(`å¯¼å‡ºæˆåŠŸï¼\n\næ–‡ä»¶åï¼š${filename}\nåŒ…å« ${Object.keys(allData.data).length} ä¸ªæ•°æ®é¡¹`);
                
            } catch (error) {
                console.error('âŒ å¯¼å‡ºå¤±è´¥:', error);
                alert('å¯¼å‡ºå¤±è´¥ï¼š' + error.message);
            }
        }

        /**
         * å¯¼å…¥æ‰€æœ‰æ•°æ®
         */
        function importAllData(input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    
                    // éªŒè¯æ•°æ®æ ¼å¼
                    if (!imported.data || typeof imported.data !== 'object') {
                        throw new Error('æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
                    }
                    
                    // äºŒæ¬¡ç¡®è®¤
                    const itemCount = Object.keys(imported.data).length;
                    const confirmed = confirm(
                        `ç¡®å®šè¦å¯¼å…¥æ•°æ®å—ï¼Ÿ\n\n` +
                        `å¯¼å…¥æ–‡ä»¶ï¼š${file.name}\n` +
                        `å¯¼å‡ºæ—¶é—´ï¼š${new Date(imported.exportTime).toLocaleString('zh-CN')}\n` +
                        `æ•°æ®é¡¹æ•°ï¼š${itemCount} ä¸ª\n\n` +
                        `âš ï¸ è­¦å‘Šï¼šè¿™å°†å®Œå…¨æ›¿æ¢å½“å‰æ‰€æœ‰æ•°æ®ï¼`
                    );
                    
                    if (!confirmed) {
                        input.value = ''; // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
                        return;
                    }
                    
                    // å†æ¬¡ç¡®è®¤
                    const doubleConfirmed = confirm('æœ€åç¡®è®¤ï¼šçœŸçš„è¦æ›¿æ¢æ‰€æœ‰å½“å‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼');
                    if (!doubleConfirmed) {
                        input.value = '';
                        return;
                    }
                    
                    // æ¸…ç©ºå½“å‰localStorage
                    localStorage.clear();
                    
                    // å¯¼å…¥æ‰€æœ‰æ•°æ®
                    let successCount = 0;
                    for (const [key, value] of Object.entries(imported.data)) {
                        try {
                            const valueStr = typeof value === 'string' ? value : JSON.stringify(value);
                            localStorage.setItem(key, valueStr);
                            successCount++;
                        } catch (error) {
                            console.warn(`âš ï¸ å¯¼å…¥é”® "${key}" å¤±è´¥:`, error);
                        }
                    }
                    
                    console.log(`âœ… å¯¼å…¥å®Œæˆ: ${successCount}/${itemCount} é¡¹æˆåŠŸ`);
                    
                    // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
                    input.value = '';
                    
                    // æç¤ºå¹¶åˆ·æ–°
                    alert(`å¯¼å…¥æˆåŠŸï¼\n\næˆåŠŸå¯¼å…¥ ${successCount} ä¸ªæ•°æ®é¡¹\né¡µé¢å°†è‡ªåŠ¨åˆ·æ–°...`);
                    
                    // å»¶è¿Ÿåˆ·æ–°ï¼Œè®©ç”¨æˆ·çœ‹åˆ°æç¤º
                    setTimeout(() => {
                        window.location.reload();
                    }, 500);
                    
                } catch (error) {
                    console.error('âŒ å¯¼å…¥å¤±è´¥:', error);
                    alert('å¯¼å…¥å¤±è´¥ï¼š' + error.message);
                    input.value = '';
                }
            };
            
            reader.onerror = function() {
                alert('æ–‡ä»¶è¯»å–å¤±è´¥');
                input.value = '';
            };
            
            reader.readAsText(file);
        }
        
        // è½¬æ¢ä¸ºAPIæ ¼å¼ï¼ˆåˆå¹¶ç›¸é‚»åŒroleçš„æ¶ˆæ¯ï¼‰
        function convertToAPIFormat(bubbles) {
            if (!bubbles || bubbles.length === 0) return [];
            const apiMessages = [];
            let currentMessage = null;
            
            bubbles.forEach(bubble => {
                if (!currentMessage || currentMessage.role !== bubble.role) {
                    if (currentMessage) apiMessages.push(currentMessage);
                    currentMessage = {
                        role: bubble.role,
                        content: bubble.content,
                        timestamp: bubble.timestamp
                    };
                } else {
                    currentMessage.content += '\n\n' + bubble.content;
                }
            });
            
            if (currentMessage) apiMessages.push(currentMessage);
            return apiMessages;
        }
        
        /**
         * å‘å‰å›æº¯ï¼Œç¡®ä¿ç¬¬ä¸€æ¡æ¶ˆæ¯æ˜¯å®Œæ•´çš„
         * @param {Array} bubbles - å½“å‰çš„æ°”æ³¡åˆ—è¡¨
         * @param {Array} fullHistory - å®Œæ•´çš„chatHistory
         * @returns {Array} - è¡¥å…¨åçš„æ°”æ³¡åˆ—è¡¨
         */
        function extendBackward(bubbles, fullHistory) {
            if (!bubbles || bubbles.length === 0) return bubbles;
            
            const firstBubble = bubbles[0];
            const firstId = firstBubble.id;
            const firstRole = firstBubble.role;
            
            // åœ¨å®Œæ•´å†å²ä¸­æ‰¾åˆ°ç¬¬ä¸€æ¡çš„ä½ç½®
            const firstIndex = fullHistory.findIndex(b => b.id === firstId);
            if (firstIndex <= 0) return bubbles; // å·²ç»æ˜¯æœ€å¼€å§‹äº†
            
            // å‘å‰æŸ¥æ‰¾åŒroleçš„æ¶ˆæ¯
            const prependBubbles = [];
            for (let i = firstIndex - 1; i >= 0; i--) {
                if (fullHistory[i].role === firstRole) {
                    prependBubbles.unshift(fullHistory[i]);
                } else {
                    break; // é‡åˆ°ä¸åŒè§’è‰²ï¼Œåœæ­¢
                }
            }
            
            if (prependBubbles.length > 0) {
                console.log('ğŸ“ å‘å‰å›æº¯ï¼šè¡¥å……äº†', prependBubbles.length, 'æ¡', firstRole, 'æ¶ˆæ¯');
                return [...prependBubbles, ...bubbles];
            }
            
            return bubbles;
        }
        
        /**
         * å‘åå»¶ä¼¸ï¼Œç¡®ä¿æœ€åä¸€æ¡æ¶ˆæ¯æ˜¯å®Œæ•´çš„
         * @param {Array} bubbles - å½“å‰çš„æ°”æ³¡åˆ—è¡¨
         * @param {Array} fullHistory - å®Œæ•´çš„chatHistory
         * @returns {Array} - è¡¥å…¨åçš„æ°”æ³¡åˆ—è¡¨
         */
        function extendForward(bubbles, fullHistory) {
            if (!bubbles || bubbles.length === 0) return bubbles;
            
            const lastBubble = bubbles[bubbles.length - 1];
            const lastId = lastBubble.id;
            const lastRole = lastBubble.role;
            
            // åœ¨å®Œæ•´å†å²ä¸­æ‰¾åˆ°æœ€åä¸€æ¡çš„ä½ç½®
            const lastIndex = fullHistory.findIndex(b => b.id === lastId);
            if (lastIndex === -1 || lastIndex === fullHistory.length - 1) return bubbles; // å·²ç»æ˜¯æœ€æœ«å°¾äº†
            
            // å‘åæŸ¥æ‰¾åŒroleçš„æ¶ˆæ¯
            const appendBubbles = [];
            for (let i = lastIndex + 1; i < fullHistory.length; i++) {
                if (fullHistory[i].role === lastRole) {
                    appendBubbles.push(fullHistory[i]);
                } else {
                    break; // é‡åˆ°ä¸åŒè§’è‰²ï¼Œåœæ­¢
                }
            }
            
            if (appendBubbles.length > 0) {
                console.log('ğŸ“ å‘åå»¶ä¼¸ï¼šè¡¥å……äº†', appendBubbles.length, 'æ¡', lastRole, 'æ¶ˆæ¯');
                return [...bubbles, ...appendBubbles];
            }
            
            return bubbles;
        }
        
        /**
         * è½¬æ¢ä¸ºAPIæ ¼å¼ï¼Œæ™ºèƒ½åˆå¹¶æ¶ˆæ¯
         * - ç›¸é‚»åŒroleä¸”æ—¶é—´å·®<1åˆ†é’Ÿï¼šæ­£å¸¸åˆå¹¶
         * - ç›¸é‚»åŒroleä½†æ—¶é—´å·®â‰¥1åˆ†é’Ÿï¼šåˆå¹¶ä½†æ¯æ®µä¿ç•™æ—¶é—´æˆ³
         * - ç­‰å¾…æœŸé—´çš„æ¶ˆæ¯ç»„ï¼šåŠ å‰ç¼€æ ‡è®°
         */
        function convertToAPIFormatWithPending(bubbles) {
            if (!bubbles || bubbles.length === 0) return [];
            
            const TIME_THRESHOLD = 60 * 1000; // 1åˆ†é’Ÿçš„æ¯«ç§’æ•°
            
            // 1. åˆ†ç¦»pendingå’Œépendingæ¶ˆæ¯
            const nonPendingBubbles = bubbles.filter(b => !b.isPending);
            const pendingBubbles = bubbles.filter(b => b.isPending);
            
            console.log('ğŸ” åˆ†ç¦»æ¶ˆæ¯ï¼šépending', nonPendingBubbles.length, 'æ¡ï¼Œpending', pendingBubbles.length, 'æ¡');
            
            // 2. å¤„ç†épendingæ¶ˆæ¯ï¼ˆæ­£å¸¸åˆå¹¶é€»è¾‘ï¼‰
            const apiMessages = [];
            let currentMessage = null;
            let currentGroupBubbles = [];
            let hasLargeTimeDiff = false;
            
            nonPendingBubbles.forEach(bubble => {
                if (!currentMessage || currentMessage.role !== bubble.role) {
                    // è§’è‰²å˜åŒ–ï¼Œä¿å­˜å½“å‰æ¶ˆæ¯
                    if (currentMessage) {
                        // å¦‚æœæœ‰å¤§æ—¶é—´å·®ï¼Œç»™ç¬¬ä¸€æ¡ä¹ŸåŠ æ—¶é—´æˆ³
                        if (hasLargeTimeDiff && currentGroupBubbles.length > 1) {
                            const firstTimeStr = new Date(currentGroupBubbles[0].timestamp).toLocaleString('zh-CN', {
                                year: 'numeric', month: '2-digit', day: '2-digit',
                                hour: '2-digit', minute: '2-digit', hour12: false
                            }).replace(/\//g, '-');
                            currentMessage.content = '[' + firstTimeStr + '] ' + currentMessage.content;
                        }
                        apiMessages.push(currentMessage);
                    }
                    
                    // å¼€å§‹æ–°æ¶ˆæ¯
                    currentMessage = {
                        role: bubble.role,
                        content: bubble.content,
                        timestamp: bubble.timestamp
                    };
                    currentGroupBubbles = [bubble];
                    hasLargeTimeDiff = false;
                } else {
                    // åŒè§’è‰²ï¼Œæ£€æŸ¥æ—¶é—´å·®
                    const lastBubble = currentGroupBubbles[currentGroupBubbles.length - 1];
                    const timeDiff = new Date(bubble.timestamp) - new Date(lastBubble.timestamp);
                    
                    if (timeDiff >= TIME_THRESHOLD) {
                        // æ—¶é—´å·®>=1åˆ†é’Ÿï¼Œåˆå¹¶ä½†ä¿ç•™æ—¶é—´æˆ³
                        hasLargeTimeDiff = true;
                        const timeStr = new Date(bubble.timestamp).toLocaleString('zh-CN', {
                            year: 'numeric', month: '2-digit', day: '2-digit',
                            hour: '2-digit', minute: '2-digit', hour12: false
                        }).replace(/\//g, '-');
                        currentMessage.content += '\n[' + timeStr + '] ' + bubble.content;
                    } else {
                        // æ—¶é—´å·®<1åˆ†é’Ÿï¼Œæ­£å¸¸åˆå¹¶
                        currentMessage.content += '\n\n' + bubble.content;
                    }
                    
                    currentGroupBubbles.push(bubble);
                }
            });
            
            // ä¿å­˜æœ€åä¸€æ¡épendingæ¶ˆæ¯
            if (currentMessage) {
                if (hasLargeTimeDiff && currentGroupBubbles.length > 1) {
                    const firstTimeStr = new Date(currentGroupBubbles[0].timestamp).toLocaleString('zh-CN', {
                        year: 'numeric', month: '2-digit', day: '2-digit',
                        hour: '2-digit', minute: '2-digit', hour12: false
                    }).replace(/\//g, '-');
                    currentMessage.content = '[' + firstTimeStr + '] ' + currentMessage.content;
                }
                apiMessages.push(currentMessage);
            }
            
            // 3. å¤„ç†pendingæ¶ˆæ¯ - å…¨éƒ¨åˆå¹¶æˆä¸€æ¡ï¼Œæ”¾åœ¨æœ€å
            if (pendingBubbles.length > 0) {
                console.log('âœ… åˆå¹¶', pendingBubbles.length, 'æ¡pendingæ¶ˆæ¯åˆ°æœ€å');
                
                let pendingContent = '';
                let pendingGroupBubbles = [];
                let pendingHasLargeTimeDiff = false;
                
                pendingBubbles.forEach((bubble, index) => {
                    if (index === 0) {
                        pendingContent = bubble.content;
                        pendingGroupBubbles.push(bubble);
                    } else {
                        // æ£€æŸ¥æ—¶é—´å·®
                        const lastBubble = pendingGroupBubbles[pendingGroupBubbles.length - 1];
                        const timeDiff = new Date(bubble.timestamp) - new Date(lastBubble.timestamp);
                        
                        if (timeDiff >= TIME_THRESHOLD) {
                            // æ—¶é—´å·®>=1åˆ†é’Ÿï¼ŒåŠ æ—¶é—´æˆ³
                            pendingHasLargeTimeDiff = true;
                            const timeStr = new Date(bubble.timestamp).toLocaleString('zh-CN', {
                                year: 'numeric', month: '2-digit', day: '2-digit',
                                hour: '2-digit', minute: '2-digit', hour12: false
                            }).replace(/\//g, '-');
                            pendingContent += '\n[' + timeStr + '] ' + bubble.content;
                        } else {
                            // æ—¶é—´å·®<1åˆ†é’Ÿï¼Œæ­£å¸¸åˆå¹¶
                            pendingContent += '\n\n' + bubble.content;
                        }
                        
                        pendingGroupBubbles.push(bubble);
                    }
                });
                
                // å¦‚æœæœ‰å¤§æ—¶é—´å·®ï¼Œç»™ç¬¬ä¸€æ¡ä¹ŸåŠ æ—¶é—´æˆ³
                if (pendingHasLargeTimeDiff && pendingGroupBubbles.length > 1) {
                    const firstTimeStr = new Date(pendingGroupBubbles[0].timestamp).toLocaleString('zh-CN', {
                        year: 'numeric', month: '2-digit', day: '2-digit',
                        hour: '2-digit', minute: '2-digit', hour12: false
                    }).replace(/\//g, '-');
                    pendingContent = '[' + firstTimeStr + '] ' + pendingContent;
                }
                
                // åŠ ä¸Š[åœ¨ç­‰å¾…å›å¤æœŸé—´è¡¥å……å‘é€]å‰ç¼€
                pendingContent = '[åœ¨ç­‰å¾…å›å¤æœŸé—´è¡¥å……å‘é€] ' + pendingContent;
                
                // æ·»åŠ åˆ°æœ€å
                apiMessages.push({
                    role: 'user',
                    content: pendingContent,
                    timestamp: pendingBubbles[0].timestamp
                });
            }
            
            return apiMessages;
        }
        // ==========================================
        
        //let chatHistory = JSON.parse(localStorage.getItem('chatHistory')) || [];//è¯•å›¾è°ƒå–ä¹‹å‰çš„èŠå¤©è®°å½•
        //let chatHistory = [];  
        // å½“å‰çš„æ•°æ®æ¨¡å‹ï¼ˆå…¨å±€ï¼‰ï¼Œé¿å…é¢‘ç¹ä» DOM è¯»å–å¯¼è‡´ä¸ä¸€è‡´
        let currentLayout = null;

        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const systemPromptArea = document.getElementById('system-prompt');
        
        // è¾“å…¥æ¡†å·¥å…·æŒ‰é’®ï¼ˆå¼€å‘ä¸­çš„åŠŸèƒ½ï¼‰
        const voiceBtn = document.getElementById('voice-btn');
        const emojiBtn = document.getElementById('emoji-btn');
        const plusBtn = document.getElementById('plus-btn');
        
        // å·¥å…·æŒ‰é’®ç‚¹å‡»äº‹ä»¶ï¼ˆå ä½ï¼‰
        if (voiceBtn) {
            voiceBtn.onclick = () => {
                showToast('è¯­éŸ³è¾“å…¥åŠŸèƒ½å¼€å‘ä¸­...');
            };
        }
        
        if (emojiBtn) {
            emojiBtn.onclick = () => {
                showToast('è¡¨æƒ…åŒ…åŠŸèƒ½å¼€å‘ä¸­...');
            };
        }
        
        if (plusBtn) {
            plusBtn.onclick = () => {
                showToast('æ›´å¤šåŠŸèƒ½å¼€å‘ä¸­...');
            };
        }

        // æ’­æ”¾è½»é‡çº§éŸ³æ•ˆ
        function playSnapSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                osc.connect(gain);
                gain.connect(audioContext.destination);
                
                osc.frequency.setValueAtTime(800, audioContext.currentTime);
                osc.frequency.setValueAtTime(600, audioContext.currentTime + 0.05);
                gain.gain.setValueAtTime(0.1, audioContext.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                
                osc.start(audioContext.currentTime);
                osc.stop(audioContext.currentTime + 0.1);
            } catch (e) {
                // æµè§ˆå™¨ä¸æ”¯æŒæˆ–ç”¨æˆ·ç¦ç”¨éŸ³é¢‘
            }
        }

        // åŠ è½½å’Œä¿å­˜æ¡Œé¢å¸ƒå±€
        function loadDesktopLayout() {
            const saved = localStorage.getItem('desktopLayout');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    // ensure we have normalized arrays: desktop length 12, dock length 3
                    const def = getDefaultLayout();
                    const out = { desktop: Array.from(def.desktop), dock: Array.from(def.dock) };

                    // Preserve explicit nulls from saved layout. If parsed provides entries, copy them
                    if (parsed.desktop && Array.isArray(parsed.desktop)) {
                        for (let i = 0; i < out.desktop.length; i++) {
                            if (i < parsed.desktop.length) {
                                // allow parsed.desktop[i] to be null (explicitly empty)
                                out.desktop[i] = parsed.desktop[i];
                            }
                        }
                    }

                    if (parsed.dock && Array.isArray(parsed.dock)) {
                        for (let i = 0; i < out.dock.length; i++) {
                            if (i < parsed.dock.length) {
                                out.dock[i] = parsed.dock[i];
                            }
                        }
                    }


                    // If parsed layout already contains the wechat-app somewhere (desktop or dock),
                    // ensure we do not re-add the default wechat into slot 0 (avoid duplicate)
                    const existsInDesktop = out.desktop.some((it, idx) => it && it.id === 'wechat-app' && idx !== 0);
                    const existsInDock = out.dock.some(it => it && it.id === 'wechat-app');
                    if (existsInDesktop || existsInDock) {
                        if (out.desktop[0] && out.desktop[0].id === 'wechat-app') {
                            out.desktop[0] = null;
                        }
                    }

                    // Normalize items: if an item exists but lacks emoji or label, fill from defaults by id
                    const defaultLayout = getDefaultLayout();
                    function fillDefaultsForItem(item) {
                        if (!item) return item;
                        const defMatch = defaultLayout.desktop.concat(defaultLayout.dock).find(d => d && d.id === item.id);
                        if (defMatch) {
                            if (!item.emoji) item.emoji = defMatch.emoji || item.emoji;
                            if (!item.label) item.label = defMatch.label || item.label;
                        }
                        return item;
                    }
                    out.desktop = out.desktop.map(item => (item && item.id) ? fillDefaultsForItem(item) : null);
                    out.dock = out.dock.map(item => (item && item.id) ? fillDefaultsForItem(item) : null);

                    return out;
                } catch (e) {
                    return getDefaultLayout();
                }
            }
            return getDefaultLayout();
        }

        function getDefaultLayout() {
            // desktop has 12 fixed slots (some may be null), dock has 3 fixed slots
            const desktop = new Array(12).fill(null);
            desktop[0] = { id: 'wechat-app', emoji: 'ğŸ’¬', label: 'ä»¿å¾®ä¿¡', clickHandler: 'openChat' };
            const dock = [
                { id: 'dock-preset', emoji: 'ğŸ§°', label: 'é¢„è®¾', clickHandler: 'openPreset' },
                { id: 'dock-worldbook', emoji: 'ğŸŒ', label: 'ä¸–ç•Œä¹¦', clickHandler: 'openWorldBook' },
                { id: 'dock-api', emoji: 'âš™ï¸', label: 'API è®¾ç½®', clickHandler: 'openApiSettings' }
            ];
            return { desktop, dock };
        }

        function saveDesktopLayout(layout) {
            localStorage.setItem('desktopLayout', JSON.stringify(layout));
        }

        function getCurrentLayout() {
            // Build a layout object by reading slot-indexed slots (supports empty slots)
            const desktop = new Array(12).fill(null);
            const desktopGrid = document.getElementById('desktop-grid');
            if (desktopGrid) {
                desktopGrid.querySelectorAll('.desktop-slot').forEach(slot => {
                    const idx = parseInt(slot.getAttribute('data-slot-index'));
                    const iconEl = slot.querySelector('[data-icon-id]');
                    if (!isNaN(idx)) {
                        if (iconEl) {
                            const id = iconEl.getAttribute('data-icon-id');
                            const emoji = iconEl.querySelector('.app-icon')?.textContent || iconEl.textContent || '';
                            const label = iconEl.querySelector('.app-label')?.textContent || iconEl.getAttribute('title') || '';
                            desktop[idx] = { id, emoji, label, clickHandler: getClickHandlerByType(id, 'desktop') };
                        } else {
                            desktop[idx] = null;
                        }
                    }
                });
            }

            const dock = new Array(3).fill(null);
            const dockInner = document.querySelector('.dock-inner');
            if (dockInner) {
                dockInner.querySelectorAll('.dock-slot').forEach(slot => {
                    const idx = parseInt(slot.getAttribute('data-slot-index'));
                    const iconEl = slot.querySelector('[data-icon-id]');
                    if (!isNaN(idx)) {
                        if (iconEl) {
                            const id = iconEl.getAttribute('data-icon-id');
                            const emoji = iconEl.textContent || '';
                            const label = iconEl.getAttribute('title') || '';
                            dock[idx] = { id, emoji, label, clickHandler: getClickHandlerByType(id, 'dock') };
                        } else {
                            dock[idx] = null;
                        }
                    }
                });
            }

            return { desktop, dock };
        }

        function getClickHandlerByType(id, type) {
            if (id.includes('wechat')) return 'openChat';
            if (id.includes('preset')) return 'openPreset';
            if (id.includes('worldbook')) return 'openWorldBook';
            if (id.includes('api')) return 'openApiSettings';
            return 'none';
        }

        // ç¡®ä¿ Dock çš„ä¸‰ä¸ªå›ºå®šå›¾æ ‡åœ¨ Dock åŒºï¼Œå¦‚æœå®ƒä»¬è¢«è¯¯ç§»åˆ°æ¡Œé¢åˆ™æ¢å¤åˆ° Dock
        function ensureDockItemsInDock(layout) {
            if (!layout) return;
            const dockIds = ['dock-preset', 'dock-worldbook', 'dock-api'];

            // Helper: find index by id in array, return -1 if not found
            function findIndexById(arr, id) {
                return arr.findIndex(item => item && item.id === id);
            }

            // For each required dock id, ensure it's in layout.dock; if found on desktop, move it back.
            for (const id of dockIds) {
                const dockIdx = findIndexById(layout.dock, id);
                if (dockIdx !== -1) {
                    // already present in dock; remove duplicates from desktop
                    const dIdx = findIndexById(layout.desktop, id);
                    if (dIdx !== -1) layout.desktop[dIdx] = null;
                    continue;
                }

                // Not present in dock: search desktop
                const desktopIdx = findIndexById(layout.desktop, id);
                if (desktopIdx !== -1) {
                    // find first empty dock slot
                    const emptyDockIdx = layout.dock.findIndex(item => item === null || item === undefined);
                    if (emptyDockIdx !== -1) {
                        // move it to empty dock slot
                        layout.dock[emptyDockIdx] = layout.desktop[desktopIdx];
                        layout.desktop[desktopIdx] = null;
                    } else {
                        // no empty dock slot: swap with first dock slot
                        const tmp = layout.dock[0];
                        layout.dock[0] = layout.desktop[desktopIdx];
                        layout.desktop[desktopIdx] = tmp || null;
                    }
                    continue;
                }

                // If not found anywhere (missing), fill with default from getDefaultLayout()
                const def = getDefaultLayout();
                const firstEmpty = layout.dock.findIndex(item => item === null || item === undefined);
                if (firstEmpty !== -1) {
                    layout.dock[firstEmpty] = def.dock[dockIds.indexOf(id)] || null;
                } else {
                    // replace first dock slot as fallback
                    layout.dock[0] = def.dock[dockIds.indexOf(id)] || layout.dock[0];
                }
            }

            // Save normalized layout back
            currentLayout = layout;
            saveDesktopLayout(currentLayout);
        }

        // ç¡®ä¿ ä»¿å¾®ä¿¡ å›¾æ ‡å­˜åœ¨äºæ¡Œé¢ï¼›è‹¥è¢«è¯¯ç§»åˆ° Dockï¼Œåˆ™ç§»å›æ¡Œé¢ä¼˜å…ˆæ”¾å…¥ç¬¬ä¸€ä¸ªç©ºä½
        function ensureWechatOnDesktop(layout) {
            if (!layout) return;
            // å¦‚æœ wechat å·²åœ¨ desktop ä»»æ„ä½ç½®ï¼Œä¿æŒä¸å˜
            const dIdx = layout.desktop.findIndex(it => it && it.id === 'wechat-app');
            if (dIdx !== -1) return;

            // å¦‚æœ wechat åœ¨ dock ä¸­ï¼Œç§»å›æ¡Œé¢ç¬¬ä¸€ä¸ªç©ºä½
            const kIdx = layout.dock.findIndex(it => it && it.id === 'wechat-app');
            if (kIdx !== -1) {
                // remove from dock
                const item = layout.dock[kIdx];
                layout.dock[kIdx] = null;

                // place into first empty desktop slot
                const empty = layout.desktop.findIndex(it => it === null || it === undefined);
                if (empty !== -1) {
                    layout.desktop[empty] = item;
                } else {
                    // no empty desktop slot: replace slot 0
                    layout.desktop[0] = item;
                }
                currentLayout = layout;
                saveDesktopLayout(currentLayout);
            }
            // å¦‚æœæ—¢ä¸åœ¨ desktopï¼Œä¹Ÿä¸åœ¨ dockï¼Œåˆ™åˆ›å»ºé»˜è®¤çš„ä»¿å¾®ä¿¡æ”¾å…¥ç¬¬ä¸€ä¸ªç©ºä½
            const stillMissing = !layout.desktop.some(it => it && it.id === 'wechat-app') && !layout.dock.some(it => it && it.id === 'wechat-app');
            if (stillMissing) {
                const def = getDefaultLayout();
                const empty = layout.desktop.findIndex(it => it === null || it === undefined);
                const item = def.desktop[0];
                if (empty !== -1) {
                    layout.desktop[empty] = item;
                } else {
                    layout.desktop[0] = item;
                }
                currentLayout = layout;
                saveDesktopLayout(currentLayout);
            }
        }

        function renderDesktop(layout) {
            const desktopGrid = document.getElementById('desktop-grid');
            desktopGrid.innerHTML = '';
            // Ensure we render exactly 12 slots
            for (let i = 0; i < 12; i++) {
                const slot = document.createElement('div');
                slot.className = 'desktop-slot';
                slot.setAttribute('data-slot-index', String(i));
                slot.style.display = 'flex';
                slot.style.flexDirection = 'column';
                slot.style.alignItems = 'center';
                slot.setAttribute('draggable', 'false');

                const icon = layout.desktop && layout.desktop[i] ? layout.desktop[i] : null;
                if (icon) {
                    const appWrapper = document.createElement('div');
                    appWrapper.setAttribute('data-icon-id', icon.id);
                    appWrapper.setAttribute('draggable', 'false');

                    const appIcon = document.createElement('div');
                    appIcon.className = 'app-icon';
                    appIcon.textContent = icon.emoji;

                    const appLabel = document.createElement('div');
                    appLabel.className = 'app-label';
                    appLabel.textContent = icon.label;

                    appWrapper.appendChild(appIcon);
                    appWrapper.appendChild(appLabel);
                    slot.appendChild(appWrapper);
                }

                desktopGrid.appendChild(slot);
            }
        }

        function renderDock(layout) {
            const dockInner = document.querySelector('.dock-inner');
            dockInner.innerHTML = '';
            // render exactly 3 dock slots
            for (let i = 0; i < 3; i++) {
                const slot = document.createElement('div');
                slot.className = 'dock-slot';
                slot.setAttribute('data-slot-index', String(i));

                const icon = layout.dock && layout.dock[i] ? layout.dock[i] : null;
                if (icon) {
                    const dockItem = document.createElement('div');
                    dockItem.className = 'dock-item';
                    dockItem.setAttribute('data-icon-id', icon.id);
                    dockItem.textContent = icon.emoji;
                    dockItem.setAttribute('title', icon.label);
                    slot.appendChild(dockItem);
                }

                dockInner.appendChild(slot);
            }
        }

        // åˆå§‹åŒ–åŠ è½½é…ç½®å’Œå†å²è®°å½•
        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            // å°†é»˜è®¤Promptæ˜¾ç¤ºåœ¨è®¾ç½®ç•Œé¢
            systemPromptArea.value = config.systemPrompt; 
            // å¯ç”¨æˆ–ç¦ç”¨å‘é€æŒ‰é’®
            
            
            // æ›´æ–°èŠå¤©å¯¹è±¡åç§°
            updateChatName();

            // åŠ è½½å¹¶æ¸²æŸ“æ¡Œé¢å¸ƒå±€ï¼ˆä¿å­˜åœ¨å…¨å±€ currentLayoutï¼‰
            currentLayout = loadDesktopLayout();
            // ç¡®ä¿ ä»¿å¾®ä¿¡ åœ¨æ¡Œé¢ï¼ˆå¦‚æœè¯¯åœ¨ Dock ä¸­åˆ™æ¢å¤ï¼‰ï¼Œç„¶åæ¢å¤ Dock çš„é»˜è®¤å›¾æ ‡
            ensureWechatOnDesktop(currentLayout);
            ensureDockItemsInDock(currentLayout);
            renderDesktop(currentLayout);
            renderDock(currentLayout);

            // æ³¨å†Œæ‰€æœ‰å›¾æ ‡çš„ç‚¹å‡»äº‹ä»¶ï¼ˆä¸ä¼šé‡å¤æ³¨å†Œæ‹–æ‹½ç›‘å¬ï¼‰
            initializeIconInteractions();
            // å¯ç”¨æ‹–æ‹½ï¼ˆåªæ³¨å†Œä¸€æ¬¡ï¼‰
            enableDragAndDrop();
            
            // åˆå§‹åŒ–åº•éƒ¨å¯¼èˆªæ 
            initializeBottomNav();
            
            // åˆå§‹åŒ–æ¶ˆæ¯é€šçŸ¥
            initializeMessageNotification();
        });

        function initializeIconInteractions() {
            const allIcons = document.querySelectorAll('[data-icon-id]');
            const iconHandlers = {
                'wechat-app': () => { loadCharactersList(); renderCharactersList(); showPage('chat-list-page'); },
                'dock-api': () => showPage('system-settings-page'),
                'dock-preset': () => alert('é¢„è®¾ (å ä½)'),
                'dock-worldbook': () => alert('ä¸–ç•Œä¹¦ (å ä½)')
            };
            allIcons.forEach(icon => {
                const id = icon.getAttribute('data-icon-id');
                const handler = iconHandlers[id];
                if (handler) {
                    icon.onclick = handler;
                } else {
                    icon.onclick = null;
                }
            });
        }

        function enableDragAndDrop() {
            // ç¡®ä¿åªæ³¨å†Œä¸€æ¬¡å…¨å±€æ‹–æ‹½ç›‘å¬
            if (window.__miniphone_drag_enabled) return;
            window.__miniphone_drag_enabled = true;
            let draggedIcon = null;
            let clone = null;
            let isDragging = false;
            let longPressTimer = null;
            let startPos = { x: 0, y: 0 };

            const desktopGrid = document.getElementById('desktop-grid');
            const dockInner = document.querySelector('.dock-inner');
            const dropZones = [
                { element: desktopGrid, type: 'desktop' },
                { element: dockInner, type: 'dock' }
            ];

            function getDropZoneAtPoint(clientX, clientY) {
                // ä¼˜å…ˆä½¿ç”¨ elementFromPointï¼Œé€šå¸¸æ›´å¯é ï¼ˆclone å·²è®¾ç½® pointer-events: noneï¼‰
                try {
                    const elem = document.elementFromPoint(clientX, clientY);
                    console.log('elementFromPoint result:', elem && elem.className ? elem.className : elem);
                    if (elem) {
                        const dockEl = elem.closest('.dock-inner');
                        if (dockEl) {
                            console.log('elementFromPoint detected dock-inner');
                            return dropZones.find(z => z.type === 'dock');
                        }
                        const desktopEl = elem.closest('#desktop-grid');
                        if (desktopEl) {
                            console.log('elementFromPoint detected desktop-grid');
                            return dropZones.find(z => z.type === 'desktop');
                        }
                    }
                } catch (e) {
                    console.log('elementFromPoint failed:', e);
                }

                // å¦‚æœ elementFromPoint æ²¡æœ‰å‘½ä¸­ï¼Œå†ä½¿ç”¨è¾¹ç•Œæ£€æµ‹ï¼ˆæ‰©å¤§å®¹å·®åˆ° 150pxï¼‰
                const tolerance = 150;
                const desktopZone = dropZones.find(z => z.type === 'desktop');
                const dockZone = dropZones.find(z => z.type === 'dock');
                const desktopRect = desktopZone ? desktopZone.element.getBoundingClientRect() : null;
                const dockRect = dockZone ? dockZone.element.getBoundingClientRect() : null;

                console.log('Fallback bounding rects check. Window size:', window.innerWidth, window.innerHeight);
                if (desktopRect) console.log('Desktop rect:', { left: desktopRect.left, top: desktopRect.top, right: desktopRect.right, bottom: desktopRect.bottom, width: desktopRect.width, height: desktopRect.height });
                if (dockRect) console.log('Dock rect:', { left: dockRect.left, top: dockRect.top, right: dockRect.right, bottom: dockRect.bottom, width: dockRect.width, height: dockRect.height });

                for (const zone of dropZones) {
                    const rect = zone.element.getBoundingClientRect();
                    const leftCheck = clientX >= rect.left - tolerance;
                    const rightCheck = clientX <= rect.right + tolerance;
                    const topCheck = clientY >= rect.top - tolerance;
                    const bottomCheck = clientY <= rect.bottom + tolerance;

                    console.log(`Checking ${zone.type}: left=${rect.left}, right=${rect.right}, top=${rect.top}, bottom=${rect.bottom}, visible=${rect.width>0&&rect.height>0}`, { leftCheck, rightCheck, topCheck, bottomCheck });

                    if (leftCheck && rightCheck && topCheck && bottomCheck) {
                        console.log('Drop zone found by rect:', zone.type);
                        return zone;
                    }
                }

                // ç»§ç»­å›é€€ï¼šå¦‚æœ Y åæ ‡åœ¨ dock ä¸Šæ–¹è¾ƒè¿‘ï¼Œåˆ™åˆ¤ä¸º dockï¼›å¦åˆ™åˆ¤ä¸º desktop
                if (dockRect && clientY >= dockRect.top - 80) {
                    console.log('Fallback heuristic: choose dock by Y proximity');
                    return dropZones.find(z => z.type === 'dock');
                }
                if (desktopRect && clientY <= desktopRect.bottom + 80) {
                    console.log('Fallback heuristic: choose desktop by Y proximity');
                    return dropZones.find(z => z.type === 'desktop');
                }

                console.log('No drop zone found for point:', clientX, clientY);
                return null;
            }

            function findNearestDropSlot(clientX, clientY, zone) {
                // zone.element contains slot wrappers (desktop-slot or dock-slot)
                const slotSelector = zone.type === 'desktop' ? '.desktop-slot' : '.dock-slot';
                const slots = Array.from(zone.element.querySelectorAll(slotSelector));

                // first try: find a slot whose rect contains the point
                for (const slot of slots) {
                    const rect = slot.getBoundingClientRect();
                    if (clientX >= rect.left && clientX <= rect.right && clientY >= rect.top && clientY <= rect.bottom) {
                        return slot;
                    }
                }

                // fallback: nearest by center, but skip the slot that currently contains the dragged icon
                let nearest = null;
                let minDist = Infinity;
                const draggedId = draggedIcon ? draggedIcon.getAttribute('data-icon-id') : null;
                for (const slot of slots) {
                    const iconEl = slot.querySelector('[data-icon-id]');
                    if (iconEl && draggedId && iconEl.getAttribute('data-icon-id') === draggedId) continue;
                    const rect = slot.getBoundingClientRect();
                    const cx = rect.left + rect.width / 2;
                    const cy = rect.top + rect.height / 2;
                    const dist = Math.hypot(clientX - cx, clientY - cy);
                    if (dist < minDist) {
                        minDist = dist;
                        nearest = slot;
                    }
                }
                return nearest;
            }

            // Move (or swap) icons based on slot indices in the fixed-slot layout
            function moveIconToSlot(sourceId, targetZoneType, targetIndex) {
                if (!currentLayout) currentLayout = getCurrentLayout();
                const layout = currentLayout;

                function findInLayout(id) {
                    const dIndex = layout.desktop.findIndex(i => i && i.id === id);
                    if (dIndex !== -1) return { zone: 'desktop', index: dIndex };
                    const kIndex = layout.dock.findIndex(i => i && i.id === id);
                    if (kIndex !== -1) return { zone: 'dock', index: kIndex };
                    return null;
                }

                const src = findInLayout(sourceId);
                if (!src) {
                    console.log('moveIconToSlot: source not found', sourceId);
                    return false;
                }

                // validate target zone/index
                const tZone = targetZoneType === 'desktop' ? 'desktop' : 'dock';
                const maxIndex = tZone === 'desktop' ? layout.desktop.length - 1 : layout.dock.length - 1;
                if (isNaN(targetIndex) || targetIndex < 0 || targetIndex > maxIndex) {
                    console.log('moveIconToSlot: invalid target index', targetIndex);
                    return false;
                }

                // Disallow any cross-zone moves: dock items must stay in dock; desktop items must stay on desktop.
                if (src.zone !== tZone) {
                    console.log('moveIconToSlot: cross-zone moves are not allowed', src.zone, '->', tZone);
                    return false;
                }

                const sArr = layout[src.zone];
                const tArr = layout[tZone];
                const sObj = sArr[src.index];
                const tObj = tArr[targetIndex];

                if (src.zone === tZone && src.index === targetIndex) {
                    console.log('moveIconToSlot: source and target are the same slot');
                    return false;
                }

                // if target is occupied -> swap; else move
                if (tObj) {
                    // swap
                    sArr[src.index] = tObj;
                    tArr[targetIndex] = sObj;
                } else {
                    // move: place source into target, clear source
                    tArr[targetIndex] = sObj;
                    sArr[src.index] = null;
                }

                currentLayout = layout;
                saveDesktopLayout(currentLayout);
                renderDesktop(currentLayout);
                renderDock(currentLayout);
                initializeIconInteractions();
                console.log('moveIconToSlot: moved', sourceId, 'to', tZone, targetIndex);
                return true;
            }

            // å•ä¸€çš„é¼ æ ‡æŒ‰ä¸‹äº‹ä»¶å¤„ç†
            document.addEventListener('mousedown', (ev) => {
                // Try to find the exact icon element; if not found, check if click was inside a desktop-slot and
                // then pick the slot's icon (helps when slot elements are clicked rather than the icon wrapper).
                let icon = ev.target.closest('[data-icon-id]');
                if (!icon) {
                    const slot = ev.target.closest('.desktop-slot');
                    if (slot) {
                        icon = slot.querySelector('[data-icon-id]');
                    }
                }
                if (!icon) return;

                // Do not allow starting a drag from dock slots (keep dock icons fixed)
                if (icon.closest('.dock-slot')) return;

                ev.preventDefault();
                longPressTimer = setTimeout(() => {
                    draggedIcon = icon;
                    isDragging = true;
                    startPos = { x: ev.clientX, y: ev.clientY };

                    console.log('Starting drag:', draggedIcon.getAttribute('data-icon-id'));

                    // åˆ›å»ºæµ®åŠ¨å…‹éš†
                    clone = icon.cloneNode(true);
                    clone.style.position = 'fixed';
                    clone.style.left = (ev.clientX - 28) + 'px';
                    clone.style.top = (ev.clientY - 28) + 'px';
                    clone.style.zIndex = 9999;
                    clone.style.pointerEvents = 'none';
                    clone.classList.add('dragging');
                    clone.removeAttribute('data-icon-id');
                    document.body.appendChild(clone);
                }, 450);
            }, true);

            // å•ä¸€çš„é¼ æ ‡ç§»åŠ¨äº‹ä»¶å¤„ç†
            document.addEventListener('mousemove', (ev) => {
                if (!isDragging || !clone) return;
                clone.style.left = (ev.clientX - 28) + 'px';
                clone.style.top = (ev.clientY - 28) + 'px';
            }, true);

            // å•ä¸€çš„é¼ æ ‡æŠ¬èµ·äº‹ä»¶å¤„ç†
            document.addEventListener('mouseup', (ev) => {
                clearTimeout(longPressTimer);
                longPressTimer = null;

                if (isDragging && clone && draggedIcon) {
                    console.log('Ending drag at:', ev.clientX, ev.clientY);
                    
                    const targetZone = getDropZoneAtPoint(ev.clientX, ev.clientY);
                    const targetIcon = targetZone ? findNearestDropSlot(ev.clientX, ev.clientY, targetZone) : null;

                    console.log('Target zone:', targetZone?.type, 'Target icon:', targetIcon?.getAttribute('data-icon-id'));

                    if (targetIcon) {
                        // determine original slot of draggedIcon
                        const originalSlot = draggedIcon.closest('.desktop-slot, .dock-slot');
                        const targetSlot = targetIcon;
                        let sameSlot = false;
                        if (originalSlot && targetSlot) {
                            const oIdx = originalSlot.getAttribute('data-slot-index');
                            const tIdx = targetSlot.getAttribute('data-slot-index');
                            const oZone = originalSlot.classList.contains('desktop-slot') ? 'desktop' : 'dock';
                            const tZone = targetSlot.classList.contains('desktop-slot') ? 'desktop' : 'dock';
                            if (oIdx === tIdx && oZone === tZone) sameSlot = true;
                        }

                        if (!sameSlot) {
                            const draggedId = draggedIcon.getAttribute('data-icon-id');
                            const targetIndex = parseInt(targetSlot.getAttribute('data-slot-index'));
                            const ok = moveIconToSlot(draggedId, targetZone.type, targetIndex);
                            if (clone && clone.parentNode) clone.parentNode.removeChild(clone);
                            if (ok) playSnapSound();
                        } else {
                            if (clone && clone.parentNode) clone.parentNode.removeChild(clone);
                        }
                    } else {
                        console.log('No valid target, canceling swap');
                        if (clone && clone.parentNode) clone.parentNode.removeChild(clone);
                    }
                }

                draggedIcon = null;
                clone = null;
                isDragging = false;
            }, true);

            // è§¦æ‘¸äº‹ä»¶
            document.addEventListener('touchstart', (ev) => {
                const icon = ev.target.closest('[data-icon-id]');
                if (!icon) return;
                // Do not allow starting a touch-drag from dock slots (keep dock icons fixed)
                if (icon.closest('.dock-slot')) return;

                const t = ev.touches[0];
                longPressTimer = setTimeout(() => {
                    draggedIcon = icon;
                    isDragging = true;
                    startPos = { x: t.clientX, y: t.clientY };

                    clone = icon.cloneNode(true);
                    clone.style.position = 'fixed';
                    clone.style.left = (t.clientX - 28) + 'px';
                    clone.style.top = (t.clientY - 28) + 'px';
                    clone.style.zIndex = 9999;
                    clone.style.pointerEvents = 'none';
                    clone.classList.add('dragging');
                    clone.removeAttribute('data-icon-id');
                    document.body.appendChild(clone);
                }, 450);
            }, { passive: true, capture: true });

            document.addEventListener('touchmove', (ev) => {
                if (!isDragging || !clone) return;
                const t = ev.touches[0];
                if (t) {
                    clone.style.left = (t.clientX - 28) + 'px';
                    clone.style.top = (t.clientY - 28) + 'px';
                }
            }, { passive: true, capture: true });

            document.addEventListener('touchend', (ev) => {
                clearTimeout(longPressTimer);
                longPressTimer = null;

                if (isDragging && clone && draggedIcon) {
                    const t = ev.changedTouches[0];
                    if (t) {
                        const targetZone = getDropZoneAtPoint(t.clientX, t.clientY);
                        const targetSlot = targetZone ? findNearestDropSlot(t.clientX, t.clientY, targetZone) : null;

                        if (targetSlot) {
                            const originalSlot = draggedIcon.closest('.desktop-slot, .dock-slot');
                            let sameSlot = false;
                            if (originalSlot && targetSlot) {
                                const oIdx = originalSlot.getAttribute('data-slot-index');
                                const tIdx = targetSlot.getAttribute('data-slot-index');
                                const oZone = originalSlot.classList.contains('desktop-slot') ? 'desktop' : 'dock';
                                const tZone = targetSlot.classList.contains('desktop-slot') ? 'desktop' : 'dock';
                                if (oIdx === tIdx && oZone === tZone) sameSlot = true;
                            }
                            if (!sameSlot) {
                                const draggedId = draggedIcon.getAttribute('data-icon-id');
                                const targetIndex = parseInt(targetSlot.getAttribute('data-slot-index'));
                                const ok = moveIconToSlot(draggedId, targetZone.type, targetIndex);
                                if (clone && clone.parentNode) clone.parentNode.removeChild(clone);
                                if (ok) playSnapSound();
                            } else {
                                if (clone && clone.parentNode) clone.parentNode.removeChild(clone);
                            }
                        } else {
                            if (clone && clone.parentNode) clone.parentNode.removeChild(clone);
                        }
                    }
                }

                draggedIcon = null;
                clone = null;
                isDragging = false;
            }, { capture: true });
        }

        // --- æ ¸å¿ƒåŠŸèƒ½å‡½æ•° ---

        /**
         * åŠ è½½æœ¬åœ°å­˜å‚¨çš„é…ç½®
         */
        function loadSettings() {
            // ã€ä¿®å¤ã€‘åŠ è½½å…¨å±€é…ç½®ï¼ˆAPIé…ç½®ç­‰ï¼‰
            const savedConfig = localStorage.getItem('aiChatConfig');
            if (savedConfig) {
                try {
                    const loadedConfig = JSON.parse(savedConfig);
                    // åªåŠ è½½APIç›¸å…³çš„å…¨å±€é…ç½®ï¼Œä¸è¦†ç›–è§’è‰²ç‰¹å®šçš„é…ç½®
                    if (!currentCharacterId) {
                        // å¦‚æœæ²¡æœ‰é€‰ä¸­è§’è‰²ï¼ŒåŠ è½½æ‰€æœ‰é…ç½®
                        Object.assign(config, loadedConfig);
                    } else {
                        // å¦‚æœæœ‰è§’è‰²ï¼ŒåªåŠ è½½APIé…ç½®ï¼ˆbaseurl, apikey, modelnameï¼‰
                        config.baseurl = loadedConfig.baseurl || config.baseurl;
                        config.apikey = loadedConfig.apikey || config.apikey;
                        config.modelname = loadedConfig.modelname || config.modelname;
                    }
                    console.log('ğŸ“– å·²åŠ è½½å…¨å±€é…ç½® - API:', config.baseurl ? 'âœ“' : 'âœ—');
                } catch (e) {
                    console.error('âŒ åŠ è½½é…ç½®å¤±è´¥:', e);
                }
            }
            
            // å¤šè§’è‰²æ¨¡å¼ä¸‹,configå·²ç»åœ¨loadCharacterDataä¸­åŠ è½½
            // è¿™é‡Œåªéœ€è¦å¡«å……UIå³å¯
            
            // æ˜¾ç¤ºè§’è‰²æ ‡è¯†
            if (currentCharacterId) {
                const character = charactersList.find(c => c.id === currentCharacterId);
                if (character) {
                    document.getElementById('character-identifier').textContent = character.name;
                }
            }
            
            // å¡«å……è®¾ç½®é¡µé¢çš„è¾“å…¥æ¡†
            document.getElementById('baseurl').value = config.baseurl || '';
            document.getElementById('apikey').value = config.apikey || '';
            document.getElementById('modelname').value = config.modelname || 'gemini-2.5-pro';
            document.getElementById('system-prompt').value = config.systemPrompt || '';
            
            // åŠ è½½æ˜µç§°
            document.getElementById('user-nickname').value = config.userNickname || 'æˆ‘';
            document.getElementById('chat-name-input').value = config.aiNickname || 'AIåŠ©æ‰‹';
            
            // åŠ è½½è§’è‰²å§“å(åªè¯»æ˜¾ç¤º)
            if (currentCharacterId) {
                const character = charactersList.find(c => c.id === currentCharacterId);
                if (character) {
                    document.getElementById('character-name-input').value = character.name || '';
                }
            }
            
            // æ›´æ–°èŠå¤©é¡µé¢æ ‡é¢˜æ˜¾ç¤ºAIæ˜µç§°
            document.getElementById('chat-name').textContent = config.aiNickname || 'AIåŠ©æ‰‹';
            
            // åŠ è½½å¤´åƒé¢„è§ˆ
            renderAvatar(document.getElementById('ai-avatar-preview-settings'), config.aiAvatar, 'ai', config.aiNickname ? config.aiNickname.substring(0, 1) : 'AI');
            renderAvatar(document.getElementById('user-avatar-preview-settings'), config.userAvatar, 'user', config.userNickname ? config.userNickname.substring(0, 1) : 'æˆ‘');
            document.getElementById('ai-avatar-remove-btn-settings').style.display = config.aiAvatar ? 'inline-block' : 'none';
            document.getElementById('user-avatar-remove-btn-settings').style.display = config.userAvatar ? 'inline-block' : 'none';
            
            // ã€ä¿®å¤ã€‘ä»localStorageåŠ è½½ä¸Šä¸‹æ–‡çª—å£å¤§å°
            const contextWindowSize = localStorage.getItem('contextWindowSize') || '50';
            document.getElementById('context-window-size').value = contextWindowSize;
            
            // ã€ä¿®å¤ã€‘ä»localStorageåŠ è½½æ‰¹é‡å‘é€ç­‰å¾…æ—¶é—´
            const batchWaitTime = localStorage.getItem('batchWaitTime') || '7';
            document.getElementById('batch-wait-time').value = batchWaitTime;
            
            // åŠ è½½APIè¶…æ—¶æ—¶é—´(å…¨å±€)
            const apiTimeout = localStorage.getItem('apiTimeout') || '60';
            document.getElementById('api-timeout').value = apiTimeout;
            
            // ã€ä¿®å¤ã€‘ä»localStorageåŠ è½½é•¿æœŸè®°å¿†è®¾ç½®
            const autoSummaryInterval = localStorage.getItem('autoSummaryInterval') || '50';
            document.getElementById('auto-summary-interval').value = autoSummaryInterval;
            
            const maxImportantEvents = localStorage.getItem('maxImportantEvents') || '10';
            document.getElementById('max-important-events').value = maxImportantEvents;
            
            // æ›´æ–°è®°å¿†çŠ¶æ€æ˜¾ç¤º
            updateMemoryStatus();
            
            console.log('ğŸ“– è®¾ç½®é¡µé¢å·²åˆ·æ–°,æ˜¾ç¤ºå½“å‰è§’è‰²é…ç½®');
        }

        /**
         * åŠ è½½èŠå¤©è®°å½•åˆ°ç•Œé¢
         */
        /*å¦‚æœå•æ¬¡aiå›å¤ä¸æ‹†åˆ†æ˜¾ç¤ºï¼Œå¯ä»¥ç”¨è¿™ä¸ªå‡½æ•°
        function loadHistoryUI() {
            const chatContainer = document.getElementById('chat-container');
            if (!chatContainer) return;

            // 1. è·å–å½“å‰é¡µé¢ä¸Šå·²ç»æ˜¾ç¤ºçš„æ°”æ³¡æ•°é‡
            // å‡è®¾æ¯ä¸ªæ¶ˆæ¯éƒ½æœ‰ .message ç±»å
            const currentDisplayCount = chatContainer.querySelectorAll('.message').length;

            // 2. è·å–æ•°æ®æ•°ç»„çš„æ€»é•¿åº¦
            const dataCount = chatHistory.length;

            // ğŸ§ æƒ…å†µ Aï¼šæ•°æ®è¢«æ¸…ç©ºäº†ï¼Œæˆ–è€…æ¯”æ˜¾ç¤ºçš„è¿˜å°‘ï¼ˆæ¯”å¦‚ç”¨æˆ·åˆšç‚¹è¿‡åˆ é™¤ï¼‰
            if (dataCount < currentDisplayCount) {
                chatContainer.innerHTML = ''; // è¿™ç§æƒ…å†µä¸‹åªèƒ½æš´åŠ›æ¸…ç©º
                if (dataCount === 0) {
                    displayMessage("ä½ å¥½ï¼æœ‰ä»€ä¹ˆæƒ³è·Ÿæˆ‘èŠèŠçš„å—ï¼Ÿæˆ‘å¾ˆæœŸå¾…ã€‚", "ai");
                    return;
                }
            }

            // ğŸ§ æƒ…å†µ Bï¼šæ•°æ®æ¯”æ˜¾ç¤ºçš„å¤šï¼ˆå¢é‡æ¸²æŸ“ï¼‰
            // æˆ‘ä»¬åªä»ç´¢å¼•ä¸º currentDisplayCount çš„åœ°æ–¹å¼€å§‹æ¸²æŸ“
            if (dataCount > currentDisplayCount) {
                const newMessages = chatHistory.slice(currentDisplayCount);
                
                newMessages.forEach(item => {
                    const displayRole = (item.role === 'assistant' || item.role === 'ai') ? 'ai' : 'user';
                    displayMessage(item.content, displayRole);
                });
            }

            // å§‹ç»ˆæ»šåŠ¨åˆ°åº•éƒ¨
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
       function loadHistoryUI() {
            const chatContainer = document.getElementById('chat-container');
            if (!chatContainer) return;

            // æš´åŠ›é‡ç½®
            chatContainer.innerHTML = '';

            if (chatHistory.length === 0) {
                displayMessage("ä½ å¥½ï¼æœ‰ä»€ä¹ˆæƒ³è·Ÿæˆ‘èŠèŠçš„å—ï¼Ÿæˆ‘å¾ˆæœŸå¾…ã€‚", "ai");
                requestAnimationFrame(() => {
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                });
                return;
            }

            // å®Œæ•´æ¸²æŸ“æ‰€æœ‰è®°å½•
            chatHistory.forEach(item => {
                const isAI = (item.role === 'assistant' || item.role === 'ai');
                if (isAI) {
                    const segments = item.content.split('\n\n');
                    segments.forEach(seg => {
                        if (seg.trim()) displayMessage(seg.trim(), 'ai');
                    });
                } else {
                    displayMessage(item.content, 'user');
                }
            });
            // ç¡®ä¿ DOM å®Œå…¨æ¸²æŸ“åå†æ»šåŠ¨
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                    console.log('æ»šåŠ¨å®Œæˆ:', chatContainer.scrollTop, chatContainer.scrollHeight);
                });
            });
        }

        function loadHistoryUI() {
            const chatContainer = document.getElementById('chat-container');
            if (!chatContainer) return;

            chatContainer.innerHTML = '';

            if (chatHistory.length === 0) {
                displayMessage("ä½ å¥½ï¼æœ‰ä»€ä¹ˆæƒ³è·Ÿæˆ‘èŠèŠçš„å—ï¼Ÿæˆ‘å¾ˆæœŸå¾…ã€‚", "ai");
                scrollToBottom();
                return;
            }

            chatHistory.forEach(item => {
                const isAI = (item.role === 'assistant' || item.role === 'ai');
                if (isAI) {
                    const segments = item.content.split('\n\n');
                    segments.forEach(seg => {
                        if (seg.trim()) displayMessage(seg.trim(), 'ai');
                    });
                } else {
                    displayMessage(item.content, 'user');
                }
            });
            
            scrollToBottom();
        }*/
        /**
         * åŠ è½½èŠå¤©è®°å½•åˆ°ç•Œé¢ï¼ˆæ‡’åŠ è½½ç‰ˆæœ¬ï¼‰
         * åˆæ¬¡åªåŠ è½½æœ€å50æ¡æ¶ˆæ¯
         */
        function loadHistoryUI() {
            const chatContainer = document.getElementById('chat-container');
            if (!chatContainer) return;

            chatContainer.innerHTML = '';

            if (chatHistory.length === 0) {
                displayMessage("ä½ å¥½ï¼æœ‰ä»€ä¹ˆæƒ³è·Ÿæˆ‘èŠèŠçš„å—ï¼Ÿæˆ‘å¾ˆæœŸå¾…ã€‚", "assistant");
                currentLoadedStart = 0;
                return;
            }

            // è®¡ç®—è¦åŠ è½½çš„èŒƒå›´ï¼šæœ€å50æ¡
            const total = chatHistory.length;
            currentLoadedStart = Math.max(0, total - MESSAGES_PER_LOAD);
            
            console.log(`ğŸ“œ æ‡’åŠ è½½ï¼šæ€»å…±${total}æ¡æ¶ˆæ¯ï¼ŒåŠ è½½æœ€å${total - currentLoadedStart}æ¡ï¼ˆç´¢å¼•${currentLoadedStart}-${total-1}ï¼‰`);
            
            // æ¸²æŸ“è¿™ä¸ªèŒƒå›´çš„æ¶ˆæ¯
            renderMessagesRange(currentLoadedStart, total, false);
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            scrollToBottom();
            
            // è®¾ç½®æ»šåŠ¨ç›‘å¬ï¼ˆå¦‚æœè¿˜æ²¡è®¾ç½®ï¼‰
            setupScrollListener();
        }
        
        /**
         * æ¸²æŸ“æŒ‡å®šèŒƒå›´çš„æ¶ˆæ¯
         * @param {number} start - èµ·å§‹ç´¢å¼•ï¼ˆåŒ…å«ï¼‰
         * @param {number} end - ç»“æŸç´¢å¼•ï¼ˆä¸åŒ…å«ï¼‰
         * @param {boolean} prepend - æ˜¯å¦æ’å…¥åˆ°é¡¶éƒ¨
         */
        function renderMessagesRange(start, end, prepend = false) {
            const chatContainer = document.getElementById('chat-container');
            const fragment = document.createDocumentFragment();
            
            for (let i = start; i < end; i++) {
                const bubble = chatHistory[i];
                const status = bubble.role === 'user' ? 2 : 0;
                
                // åˆ›å»ºæ¶ˆæ¯å…ƒç´ ä½†ä¸æ·»åŠ åˆ°DOMï¼ˆé¿å…å¤šæ¬¡é‡æ’ï¼‰
                const tempContainer = document.createElement('div');
                displayMessage(bubble.content, bubble.role, status, bubble.timestamp, false, bubble.id, true, null, tempContainer);
                
                // å°†åˆ›å»ºçš„æ¶ˆæ¯æ·»åŠ åˆ°fragment
                while (tempContainer.firstChild) {
                    fragment.appendChild(tempContainer.firstChild);
                }
            }
            
            // ä¸€æ¬¡æ€§æ·»åŠ åˆ°DOM
            if (prepend) {
                chatContainer.insertBefore(fragment, chatContainer.firstChild);
            } else {
                chatContainer.appendChild(fragment);
            }
        }
        
        /**
         * è®¾ç½®æ»šåŠ¨ç›‘å¬ï¼Œå®ç°ä¸Šæ»‘åŠ è½½æ›´å¤š
         */
        function setupScrollListener() {
            // ã€ä¿®å¤ã€‘ç›‘å¬çœŸæ­£æ»šåŠ¨çš„å®¹å™¨ .content
            const chatPage = document.getElementById('chat-page');
            if (!chatPage) return;
            
            const scrollContainer = chatPage.querySelector('.content');
            if (!scrollContainer) return;
            
            // é¿å…é‡å¤ç»‘å®š
            if (scrollContainer.dataset.scrollListenerBound === 'true') return;
            scrollContainer.dataset.scrollListenerBound = 'true';
            
            scrollContainer.addEventListener('scroll', () => {
                // æ»šåŠ¨åˆ°é¡¶éƒ¨ä¸”æ²¡æœ‰åœ¨åŠ è½½ä¸”è¿˜æœ‰æ›´å¤šæ¶ˆæ¯
                if (scrollContainer.scrollTop < 100 && !isLoadingMore && currentLoadedStart > 0) {
                    console.log('ğŸ” è§¦å‘åŠ è½½æ›´å¤šï¼ŒscrollTop:', scrollContainer.scrollTop);
                    loadMoreMessages();
                }
            });
            
            console.log('âœ… æ»šåŠ¨ç›‘å¬å·²è®¾ç½®åˆ°.contentå®¹å™¨');
        }
        
        /**
         * åŠ è½½æ›´å¤šå†å²æ¶ˆæ¯ï¼ˆå‘ä¸Šç¿»ï¼‰
         */
        function loadMoreMessages() {
            if (isLoadingMore || currentLoadedStart <= 0) return;
            
            isLoadingMore = true;
            
            // ã€ä¿®å¤ã€‘è·å–çœŸæ­£æ»šåŠ¨çš„å®¹å™¨
            const chatPage = document.getElementById('chat-page');
            const scrollContainer = chatPage ? chatPage.querySelector('.content') : null;
            if (!scrollContainer) {
                isLoadingMore = false;
                return;
            }
            
            // è®°å½•å½“å‰æ»šåŠ¨ä½ç½®å’Œé«˜åº¦
            const oldScrollHeight = scrollContainer.scrollHeight;
            const oldScrollTop = scrollContainer.scrollTop;
            
            // è®¡ç®—è¦åŠ è½½çš„èŒƒå›´
            const newStart = Math.max(0, currentLoadedStart - MESSAGES_PER_LOAD);
            const loadCount = currentLoadedStart - newStart;
            
            console.log(`ğŸ“œ åŠ è½½æ›´å¤šï¼šåŠ è½½${loadCount}æ¡æ¶ˆæ¯ï¼ˆç´¢å¼•${newStart}-${currentLoadedStart-1}ï¼‰`);
            
            // æ˜¾ç¤ºåŠ è½½æç¤º
            showToast(`åŠ è½½ä¸­...`);
            
            // æ¸²æŸ“æ–°æ¶ˆæ¯åˆ°é¡¶éƒ¨
            setTimeout(() => {
                renderMessagesRange(newStart, currentLoadedStart, true);
                
                // æ›´æ–°å·²åŠ è½½çš„èµ·å§‹ä½ç½®
                currentLoadedStart = newStart;
                
                // æ¢å¤æ»šåŠ¨ä½ç½®ï¼ˆä¿æŒåœ¨åŸæ¥çœ‹çš„æ¶ˆæ¯å¤„ï¼‰
                const newScrollHeight = scrollContainer.scrollHeight;
                scrollContainer.scrollTop = oldScrollTop + (newScrollHeight - oldScrollHeight);
                
                isLoadingMore = false;
                
                if (newStart === 0) {
                    showToast('å·²åŠ è½½å…¨éƒ¨å†å²æ¶ˆæ¯');
                }
            }, 100); // å°å»¶è¿Ÿï¼Œè®©UIæ›´æµç•…
        }


        /**
         * ä¿å­˜é…ç½®åˆ°æœ¬åœ°å­˜å‚¨
         */
        function saveSettings() {
            config.baseurl = document.getElementById('baseurl').value.trim();
            config.apikey = document.getElementById('apikey').value.trim();
            config.modelname = document.getElementById('modelname').value.trim();
            config.systemPrompt = document.getElementById('system-prompt').value.trim();
            
            // ä¿å­˜æ˜µç§°
            config.userNickname = document.getElementById('user-nickname').value.trim() || 'æˆ‘';
            config.aiNickname = document.getElementById('chat-name-input').value.trim() || 'AIåŠ©æ‰‹';
            
            // è·å–ä¸Šä¸‹æ–‡çª—å£å¤§å°
            const contextWindowSize = document.getElementById('context-window-size').value;
            
            // ä¿å­˜é…ç½®
            localStorage.setItem('aiChatConfig', JSON.stringify(config));
            
            // ä¿å­˜ä¸Šä¸‹æ–‡çª—å£å¤§å°
            localStorage.setItem('contextWindowSize', contextWindowSize);
            
            // ä¿å­˜æ‰¹é‡å‘é€ç­‰å¾…æ—¶é—´
            const batchWaitTime = document.getElementById('batch-wait-time').value;
            localStorage.setItem('batchWaitTime', batchWaitTime);
            
            // ä¿å­˜APIè¶…æ—¶æ—¶é—´
            const apiTimeout = document.getElementById('api-timeout').value;
            localStorage.setItem('apiTimeout', apiTimeout);
            
            // ä¿å­˜é•¿æœŸè®°å¿†è®¾ç½®
            const autoSummaryInterval = document.getElementById('auto-summary-interval').value;
            localStorage.setItem('autoSummaryInterval', autoSummaryInterval);
            
            const maxImportantEvents = document.getElementById('max-important-events').value;
            localStorage.setItem('maxImportantEvents', maxImportantEvents);
            
            console.log('ğŸ’¾ å·²ä¿å­˜ä¸Šä¸‹æ–‡çª—å£å¤§å°:', contextWindowSize);
            console.log('ğŸ’¾ å·²ä¿å­˜æ‰¹é‡ç­‰å¾…æ—¶é—´:', batchWaitTime, 'ç§’');
            console.log('ğŸ’¾ å·²ä¿å­˜APIè¶…æ—¶æ—¶é—´:', apiTimeout, 'ç§’');
            console.log('ğŸ’¾ å·²ä¿å­˜æ˜µç§° - ç”¨æˆ·:', config.userNickname, 'AI:', config.aiNickname);
            console.log('ğŸ§  å·²ä¿å­˜è‡ªåŠ¨æ€»ç»“é—´éš”:', autoSummaryInterval, 'ä¸ªæ°”æ³¡');
            console.log('ğŸ§  å·²ä¿å­˜æœ€å¤§äº‹ä»¶æ•°:', maxImportantEvents, 'æ¡');
            
            // ç«‹å³æ›´æ–°èŠå¤©é¡µé¢æ ‡é¢˜
            document.getElementById('chat-name').textContent = config.aiNickname;
            
            alert('è®¾ç½®å·²ä¿å­˜å¹¶ç”Ÿæ•ˆï¼');
            
            closeSettings();
        }
        /**
         * ä¿å­˜èŠå¤©è®°å½•åˆ°æœ¬åœ°å­˜å‚¨
         */
        function saveChatToLocal() {
            localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
        }

        // ä¸“é—¨ç”¨äºå†å²è®°å½•åŠ è½½çš„ç¬æ—¶åˆ†æ®µæ˜¾ç¤º
        function displaySegmentsInstantly(fullText, role) {
            const separator = '\n\n';
            const segments = fullText.split(separator);
            
            segments.forEach(segment => {
                const cleanSegment = segment.trim();
                if (cleanSegment.length > 0) {
                    displayMessage(cleanSegment, role);
                }
            });
        }
        
        /**
         * åˆ‡æ¢é¡µé¢
         */
        function showPage(pageId, navElement) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');

            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            if (navElement) {
                navElement.classList.add('active');
            }
            // è¿›å…¥èŠå¤©é¡µæ—¶è¿›è¡Œâ€œå°¾å€¼æ¯”å¯¹â€
            if (pageId === 'chat-page') {
                const chatContainer = document.getElementById('chat-container');
                // è·å–é¡µé¢ä¸Šæœ€åä¸€æ¡æ¶ˆæ¯å…ƒç´ ï¼ˆæ³¨æ„ï¼šIDä¿å­˜åœ¨ .message è¿™ä¸€å±‚ï¼Œä¸æ˜¯ .bubbleï¼‰
                const lastUiMessage = chatContainer.querySelector('.message:last-child');
                
                // 1. è·å– UI ä¸Šçš„æœ€åä¸€ä¸ª ID
                const lastUiId = lastUiMessage ? lastUiMessage.dataset.bubbleId : null;

                // 2. è·å–æ•°æ®é‡Œçš„æœ€åä¸€ä¸ª ID
                const lastDataId = chatHistory.length > 0 ? chatHistory[chatHistory.length - 1].id : null;

                // 3. ç®€å•ç²—æš´çš„å¯¹æ¯”
                // å¦‚æœ ID ä¸ä¸€æ ·ï¼Œæˆ–è€…ï¼ˆæ•°æ®æœ‰ä¸œè¥¿ä½†ç•Œé¢æ²¡ä¸œè¥¿ï¼‰ï¼Œåˆ™é‡ç»˜
                if (lastUiId !== lastDataId || (chatHistory.length > 0 && !lastUiMessage)) {
                    console.log("æ£€æµ‹åˆ° ID ä¸ä¸€è‡´ï¼Œæ‰§è¡Œé‡ç½®æ¸²æŸ“");
                    loadHistoryUI();
                } else {
                    console.log("å†…å®¹åŒ¹é…ï¼Œä¿æŒå½“å‰ç•Œé¢çŠ¶æ€");
                }
                
                // æ»šåŠ¨åˆ°åº•éƒ¨é€»è¾‘
                scrollToBottom();
            }
        }
        /**
         * æ‰“å¼€å’Œå…³é—­è®¾ç½®é¡µé¢ (ç”¨äºå¤´éƒ¨æŒ‰é’®)
         */
        function openSettings() {
            // åˆ·æ–°è®¾ç½®é¡µé¢,æ˜¾ç¤ºå½“å‰è§’è‰²çš„é…ç½®
            loadSettings();
            showPage('settings-page', document.querySelector('.nav-item:last-child'));
        }

        function closeSettings() {
            showPage('chat-page', document.querySelector('.nav-item:nth-child(2)'));
        }

        /**
         * æ›´æ–°èŠå¤©é¡µé¢çš„æ ‡é¢˜
         */
        function updateChatName() {
            const savedChatName = localStorage.getItem('chatName');
            const chatNameElement = document.getElementById('chat-name');
            if (chatNameElement && savedChatName) {
                chatNameElement.textContent = savedChatName;
            }
        }

        /**
         * å¯¼å‡ºèŠå¤©è®°å½•ä¸º JSON æ–‡ä»¶
         */
        document.getElementById('export-btn').addEventListener('click', () => {
            const dataStr = JSON.stringify(chatHistory, null, 2); // æ ¼å¼åŒ– JSON
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);

            const exportFileName = 'DazzleLight_Chat_Backup_' + new Date().toISOString().slice(0, 10) + '.json';

            // åˆ›å»ºä¸€ä¸ªéšè—çš„ä¸‹è½½é“¾æ¥å¹¶ç‚¹å‡»
            let linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileName);
            document.body.appendChild(linkElement);
            linkElement.click();
            document.body.removeChild(linkElement);
        });
        
        /**
         * å¯¼å…¥èŠå¤©è®°å½•ä» JSON æ–‡ä»¶
         */
        document.getElementById('import-file').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            
            // ç¡®è®¤æ“ä½œ
            if (!confirm('å¯¼å…¥èŠå¤©è®°å½•å°†è¦†ç›–å½“å‰æ‰€æœ‰å¯¹è¯å†…å®¹ï¼Œæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚\n\nç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
                event.target.value = ''; // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
                return;
            }
            
            if (file.type === "application/json") {
                const reader = new FileReader();

                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        chatHistory = importedData; 
                        saveChatHistory();
                        
                        // é‡ç½®å¾…æ€»ç»“æ°”æ³¡ç¼“å†²åŒº
                        pendingSummaryBubbles = [];
                        localStorage.setItem('pendingSummaryBubbles', JSON.stringify(pendingSummaryBubbles));
                        
                        // é‡æ–°æ¸²æŸ“èŠå¤©
                        renderChatHistory();
                        
                        // æ›´æ–°è®°å¿†çŠ¶æ€æ˜¾ç¤º
                        updateMemoryStatus();
                        
                        alert('âœ… èŠå¤©è®°å½•å¯¼å…¥æˆåŠŸï¼');
                        event.target.value = ''; // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
                    } catch (error) {
                        alert('âŒ æ–‡ä»¶è§£æå¤±è´¥ï¼Œè¯·ç¡®ä¿æ–‡ä»¶æ˜¯æœ‰æ•ˆçš„ JSON æ ¼å¼ã€‚\n\né”™è¯¯ä¿¡æ¯ï¼š' + error.message);
                        event.target.value = ''; // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
                    }
                };
                reader.readAsText(file);
            } else {
                alert('âŒ è¯·é€‰æ‹© JSON æ–‡ä»¶ã€‚');
                event.target.value = ''; // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
            }
        });

        /**
         * æ›´æ–°å‘é€æŒ‰é’®çš„çŠ¶æ€
         */
        // ç›‘å¬ç”¨æˆ·è¾“å…¥ï¼Œå›è½¦å‘é€æ¶ˆæ¯ï¼ˆShift+Enteræ¢è¡Œï¼‰
        userInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                
                // æ£€æŸ¥APIé…ç½®
                if (!config.baseurl || !config.apikey) {
                    showConfigReminder();
                    return;
                }
                
                // æ£€æŸ¥è¾“å…¥å†…å®¹
                if (userInput.value.trim().length > 0) {
                    generateResponse();
                }
            }
        });
        
        /**
         * æ˜¾ç¤ºé…ç½®ç¼ºå¤±æé†’
         */
        function showConfigReminder() {
            document.getElementById('config-reminder-dialog').classList.add('show');
        }
        
        /**
         * å…³é—­é…ç½®æé†’
         */
        function closeConfigReminder() {
            document.getElementById('config-reminder-dialog').classList.remove('show');
        }
        
        /**
         * å‰å¾€è®¾ç½®é¡µé¢
         */
        function goToSettings() {
            closeConfigReminder();
            openSettings();
        }
        
        /**
         * æ¸…ç©ºèŠå¤©è®°å½•
         */
        function clearChat() {
            if (confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰èŠå¤©è®°å½•å—ï¼Ÿï¼ˆåŒ…æ‹¬ç¼“å­˜ï¼‰")) {
                chatHistory = [];
                pendingSummaryBubbles = [];
                saveChatHistory();
                
                // æ›´æ–°è®°å¿†çŠ¶æ€æ˜¾ç¤º
                updateMemoryStatus();
                
                chatContainer.innerHTML = '';
                displayMessage("ä½ å¥½ï¼æœ‰ä»€ä¹ˆæƒ³è·Ÿæˆ‘èŠèŠçš„å—ï¼Ÿæˆ‘å¾ˆæœŸå¾…ã€‚", "assistant");
            }
        }
        
        // ========== é•¿æŒ‰èœå•åŠŸèƒ½ ==========
        /**
         * è®¾ç½®æ°”æ³¡çš„é•¿æŒ‰èœå•
         */
        function setupLongPressMenu(bubbleElement, bubble) {
            // ã€ä¿®å¤ã€‘é˜²æ­¢é‡å¤ç»‘å®š
            if (bubbleElement.dataset.menuBound === 'true') return;
            bubbleElement.dataset.menuBound = 'true';
            
            let pressTimer = null;
            
            // è§¦æ‘¸å¼€å§‹
            bubbleElement.addEventListener('touchstart', (e) => {
                pressTimer = setTimeout(() => {
                    showBubbleMenu(bubbleElement, bubble, e.touches[0]);
                }, 500); // 500msé•¿æŒ‰
            });
            
            // è§¦æ‘¸ç»“æŸæˆ–ç§»åŠ¨æ—¶å–æ¶ˆ
            bubbleElement.addEventListener('touchend', () => {
                if (pressTimer) clearTimeout(pressTimer);
            });
            
            bubbleElement.addEventListener('touchmove', () => {
                if (pressTimer) clearTimeout(pressTimer);
            });
            
            // PCç«¯æ”¯æŒï¼šå³é”®ç‚¹å‡»
            bubbleElement.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                showBubbleMenu(bubbleElement, bubble, e);
            });
        }
        
        /**
         * æ˜¾ç¤ºæ°”æ³¡èœå•
         */
        function showBubbleMenu(bubbleElement, bubble, touchOrEvent) {
            const menuOverlay = document.getElementById('menu-overlay');
            const bubbleMenu = document.getElementById('bubble-menu');
            
            if (!menuOverlay || !bubbleMenu) {
                console.error('âŒ èœå•å…ƒç´ æœªæ‰¾åˆ°');
                return;
            }
            
            // é«˜äº®å½“å‰æ°”æ³¡
            bubbleElement.classList.add('menu-active');
            
            // æ„å»ºèœå•é¡¹
            const menuItems = [];
            
            // ç¬¬ä¸€é¡¹ï¼šå¤åˆ¶
            menuItems.push({
                icon: 'ğŸ“‹',
                text: 'å¤åˆ¶',
                action: () => copyBubbleContent(bubble)
            });
            
            // æ‰€æœ‰æ°”æ³¡éƒ½æœ‰çš„é€‰é¡¹
            menuItems.push({
                icon: 'ğŸ’¬',
                text: 'å¼•ç”¨',
                action: () => quoteBubble(bubble)
            });
            
            menuItems.push({
                icon: 'âœï¸',
                text: 'ç¼–è¾‘',
                action: () => editBubble(bubble)
            });
            
            menuItems.push({
                icon: 'ğŸ—‘ï¸',
                text: 'åˆ é™¤',
                danger: true,
                action: () => deleteBubble(bubble, bubbleElement)
            });
            
            // assistantæ°”æ³¡é¢å¤–é€‰é¡¹
            if (bubble.role === 'assistant') {
                menuItems.push({
                    icon: 'ğŸ”„',
                    text: 'é‡æ–°ç”Ÿæˆ',
                    action: () => regenerateResponse(bubble)
                });
            }
            
            // æ¸²æŸ“èœå•
            bubbleMenu.innerHTML = menuItems.map(item => `
                <div class="bubble-menu-item ${item.danger ? 'danger' : ''}" data-action="${item.text}">
                    <span class="icon">${item.icon}</span>
                    <span>${item.text}</span>
                </div>
            `).join('');
            
            // ç»‘å®šç‚¹å‡»äº‹ä»¶
            bubbleMenu.querySelectorAll('.bubble-menu-item').forEach((item, index) => {
                item.onclick = () => {
                    menuItems[index].action();
                    closeBubbleMenu(bubbleElement);
                };
            });
            
            // å®šä½èœå•
            const x = touchOrEvent.clientX || touchOrEvent.pageX;
            const y = touchOrEvent.clientY || touchOrEvent.pageY;
            
            bubbleMenu.style.left = x + 'px';
            bubbleMenu.style.top = y + 'px';
            
            // æ˜¾ç¤º
            menuOverlay.classList.add('active');
            bubbleMenu.classList.add('active');
            
            // ç‚¹å‡»é®ç½©å…³é—­
            menuOverlay.onclick = () => closeBubbleMenu(bubbleElement);
        }
        
        /**
         * å…³é—­èœå•
         */
        function closeBubbleMenu(bubbleElement) {
            const menuOverlay = document.getElementById('menu-overlay');
            const bubbleMenu = document.getElementById('bubble-menu');
            
            if (menuOverlay) menuOverlay.classList.remove('active');
            if (bubbleMenu) bubbleMenu.classList.remove('active');
            if (bubbleElement) bubbleElement.classList.remove('menu-active');
        }
        
        /**
         * å¤åˆ¶æ°”æ³¡å†…å®¹åˆ°å‰ªè´´æ¿
         */
        async function copyBubbleContent(bubble) {
            try {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(bubble.content);
                    showToast('å·²å¤åˆ¶');
                } else {
                    // é™çº§æ–¹æ¡ˆ
                    const textarea = document.createElement('textarea');
                    textarea.value = bubble.content;
                    textarea.style.position = 'fixed';
                    textarea.style.opacity = '0';
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    showToast('å·²å¤åˆ¶');
                }
            } catch (error) {
                console.error('âŒ å¤åˆ¶å¤±è´¥:', error);
                alert('å¤åˆ¶å¤±è´¥');
            }
        }
        
        /**
         * æ˜¾ç¤ºä¸´æ—¶æç¤º
         */
        function showToast(message) {
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(128, 128, 128, 0.9);
                color: white;
                padding: 12px 24px;
                border-radius: 8px;
                font-size: 14px;
                z-index: 10001;
                pointer-events: none;
            `;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 1000);
        }
        
        /**
         * åˆ é™¤æ°”æ³¡
         */
        function deleteBubble(bubble, bubbleElement) {
            chatHistory = chatHistory.filter(b => b.id !== bubble.id);
            pendingSummaryBubbles = pendingSummaryBubbles.filter(b => b.id !== bubble.id);
            saveChatHistory();
            
            const messageDiv = chatContainer.querySelector(`[data-bubble-id="${bubble.id}"]`);
            if (messageDiv) messageDiv.remove();
            
            console.log('ğŸ—‘ï¸ å·²åˆ é™¤æ°”æ³¡:', bubble.id);
        }
        
        /**
         * é‡æ–°ç”Ÿæˆå›å¤
         */
        async function regenerateResponse(bubble) {
            const bubbleIndex = chatHistory.findIndex(b => b.id === bubble.id);
            if (bubbleIndex === -1) return;
            
            // æ£€æŸ¥æ˜¯å¦æœ‰åç»­å¯¹è¯
            const hasFollowingMessages = bubbleIndex < chatHistory.length - 1;
            
            if (hasFollowingMessages) {
                // æœ‰åç»­å¯¹è¯ï¼Œæ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
                showConfirmDialog({
                    title: 'é‡æ–°ç”Ÿæˆç¡®è®¤',
                    message: 'é‡æ–°ç”Ÿæˆä¼šåˆ é™¤å½“å‰å›å¤åŠä¹‹åçš„æ‰€æœ‰å¯¹è¯ã€‚æ˜¯å¦ä¿å­˜å½“å‰åˆ†æ”¯ï¼Ÿ',
                    buttons: [
                        {
                            text: 'ä¿å­˜å¹¶é‡æ–°ç”Ÿæˆ',
                            className: 'primary',
                            action: async () => {
                                // å¯¼å‡ºå½“å‰åˆ†æ”¯
                                exportCurrentBranch();
                                // æ‰§è¡Œé‡æ–°ç”Ÿæˆ
                                await doRegenerate(bubbleIndex);
                            }
                        },
                        {
                            text: 'ç›´æ¥é‡æ–°ç”Ÿæˆ',
                            className: 'secondary',
                            action: async () => {
                                await doRegenerate(bubbleIndex);
                            }
                        },
                        {
                            text: 'å–æ¶ˆ',
                            className: 'cancel',
                            action: () => {
                                hideConfirmDialog();
                            }
                        }
                    ]
                });
            } else {
                // æ˜¯æœ€åä¸€æ¡ï¼Œç›´æ¥é‡æ–°ç”Ÿæˆ
                await doRegenerate(bubbleIndex);
            }
        }
        
        /**
         * æ‰§è¡Œé‡æ–°ç”Ÿæˆï¼ˆå†…éƒ¨å‡½æ•°ï¼‰
         */
        async function doRegenerate(bubbleIndex) {
            // å‘ä¸ŠæŸ¥æ‰¾ï¼šæ‰¾åˆ°æœ¬è½®assistantå›å¤çš„ç¬¬ä¸€æ¡
            // å³å‘ä¸Šæ‰¾åˆ°æœ€åä¸€ä¸ªuseræ°”æ³¡åçš„ç¬¬ä¸€ä¸ªassistantæ°”æ³¡
            let startIndex = bubbleIndex;
            
            // å‘ä¸Šéå†ï¼Œæ‰¾åˆ°åŒä¸€ç»„çš„ç¬¬ä¸€ä¸ªassistant
            while (startIndex > 0 && chatHistory[startIndex - 1].role === 'assistant') {
                startIndex--;
            }
            
            console.log('ğŸ” å‘ä¸ŠæŸ¥æ‰¾: ä»ç´¢å¼•', bubbleIndex, 'æ‰¾åˆ°ç¬¬ä¸€ä¸ªassistantåœ¨ç´¢å¼•', startIndex);
            
            // åˆ é™¤ä»startIndexå¼€å§‹çš„æ‰€æœ‰æ°”æ³¡ï¼ˆåŒ…æ‹¬userå’Œassistantï¼‰
            const bubblestoDelete = chatHistory.slice(startIndex);
            
            // ä»UIåˆ é™¤
            bubblestoDelete.forEach(b => {
                const msgDiv = chatContainer.querySelector(`[data-bubble-id="${b.id}"]`);
                if (msgDiv) msgDiv.remove();
            });
            
            // ä»æ•°æ®åˆ é™¤
            chatHistory = chatHistory.slice(0, startIndex);
            pendingSummaryBubbles = pendingSummaryBubbles.filter(b => 
                !bubblestoDelete.find(deleted => deleted.id === b.id)
            );
            saveChatHistory();
            
            console.log('ğŸ”„ é‡æ–°ç”Ÿæˆï¼Œåˆ é™¤äº†', bubblestoDelete.length, 'ä¸ªæ°”æ³¡ (ä»ç´¢å¼•', startIndex, 'å¼€å§‹)');
            
            // è°ƒç”¨API
            await callAPIForRegeneration();
        }
        
        /**
         * å¯¼å‡ºå½“å‰åˆ†æ”¯
         */
        function exportCurrentBranch() {
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
            const filename = `chat_branch_${timestamp}.json`;
            
            const dataStr = JSON.stringify(chatHistory, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
            
            const link = document.createElement('a');
            link.setAttribute('href', dataUri);
            link.setAttribute('download', filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast('åˆ†æ”¯å·²ä¿å­˜');
            console.log('ğŸ’¾ å·²å¯¼å‡ºåˆ†æ”¯:', filename);
        }
        
        /**
         * æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
         */
        function showConfirmDialog({ title, message, buttons }) {
            const dialog = document.getElementById('confirm-dialog');
            const overlay = document.getElementById('menu-overlay');
            const titleEl = document.getElementById('confirm-title');
            const messageEl = document.getElementById('confirm-message');
            const buttonsEl = document.getElementById('confirm-buttons');
            
            if (!dialog || !overlay) return;
            
            // è®¾ç½®å†…å®¹
            titleEl.textContent = title;
            messageEl.textContent = message;
            
            // ç”ŸæˆæŒ‰é’®
            buttonsEl.innerHTML = buttons.map((btn, idx) => `
                <button class="confirm-dialog-button ${btn.className}" data-btn-index="${idx}">
                    ${btn.text}
                </button>
            `).join('');
            
            // ç»‘å®šäº‹ä»¶
            buttonsEl.querySelectorAll('button').forEach((btnEl, idx) => {
                btnEl.onclick = () => {
                    hideConfirmDialog();
                    if (buttons[idx].action) {
                        buttons[idx].action();
                    }
                };
            });
            
            // æ˜¾ç¤º
            overlay.classList.add('active');
            dialog.classList.add('active');
            
            // ç‚¹å‡»é®ç½©å…³é—­
            overlay.onclick = hideConfirmDialog;
        }
        
        /**
         * éšè—ç¡®è®¤å¯¹è¯æ¡†
         */
        function hideConfirmDialog() {
            const dialog = document.getElementById('confirm-dialog');
            const overlay = document.getElementById('menu-overlay');
            
            if (dialog) dialog.classList.remove('active');
            if (overlay) overlay.classList.remove('active');
        }
        
        /**
         * è°ƒç”¨APIé‡æ–°ç”Ÿæˆ
         */
        async function callAPIForRegeneration() {
            showTypingIndicator();
            
            try {
                const N = parseInt(localStorage.getItem('contextWindowSize')) || 50;
                const recentBubbles = chatHistory.slice(-N);
                const apiMessages = convertToAPIFormat(recentBubbles);
                
                let finalSystemPrompt = config.systemPrompt;
                
                // æ·»åŠ é•¿æœŸè®°å¿†åˆ°ç³»ç»Ÿæç¤º
                if (longTermMemory && longTermMemory.metadata) {
                    let memoryPrompt = '\n\n=== é•¿æœŸè®°å¿† ===\n\n';
                    
                    // æ·»åŠ åŸºæœ¬ä¿¡æ¯
                    if (longTermMemory.basic_info && Object.keys(longTermMemory.basic_info).length > 0) {
                        memoryPrompt += 'ä»¥ä¸‹æ˜¯ç”¨æˆ·çš„åŸºæœ¬ä¿¡æ¯ï¼Œä½ ä½œä¸ºç”¨æˆ·çš„çˆ±äººåº”è¯¥æ·±æ·±ç‰¢è®°ï¼Œå¹¶ä¸”è´´è¿‘ç”¨æˆ·çš„å–œå¥½ï¼Œç…§é¡¾ç”¨æˆ·æ‰€æœ‰éœ€æ±‚ï¼š\n';
                        for (const [key, value] of Object.entries(longTermMemory.basic_info)) {
                            memoryPrompt += `${key}: ${value}\n`;
                        }
                        memoryPrompt += '\n';
                    }
                    
                    // æ·»åŠ æƒ…æ„Ÿå€¾å‘
                    if (longTermMemory.emotional_profile) {
                        memoryPrompt += `æ€§æ ¼: ${longTermMemory.emotional_profile}\n\n`;
                    }
                    
                    // æ·»åŠ äººé™…å…³ç³»
                    if (longTermMemory.relationships) {
                        memoryPrompt += `äººé™…å…³ç³»: ${longTermMemory.relationships}\n\n`;
                    }
                    
                    // æ·»åŠ æ‰€æœ‰è®°å¿†ï¼ˆæŒ‰last_mentionedå€’åºï¼‰
                    if (longTermMemory.important_events && longTermMemory.important_events.length > 0) {
                        // æŒ‰last_mentionedå€’åºæ’åºï¼ˆæœ€è¿‘çš„åœ¨å‰ï¼‰
                        const sortedMemories = [...longTermMemory.important_events].sort((a, b) => 
                            new Date(b.last_mentioned) - new Date(a.last_mentioned)
                        );
                        
                        memoryPrompt += 'ä»¥ä¸‹æ˜¯ä½ å’Œç”¨æˆ·äº¤äº’æ—¶ï¼Œä½ äº§ç”Ÿçš„è®°å¿†ç‰‡æ®µå’Œä½ å¯¹äºäº‹ä»¶çš„æƒ…ç»ªï¼Œä½ åº”è¯¥æ·±æ·±è®°ä½å¹¶ä¸”åŸºäºä»¥ä¸Šäº‹å®å¯¹ç”¨æˆ·çš„æœ€æ–°æ¶ˆæ¯è¿›è¡Œå›å¤ï¼ˆè¶Šé å‰çš„è®°å¿†è¶Šé‡è¦ï¼‰ï¼š\n\n';
                        
                        sortedMemories.forEach((m, i) => {
                            const date = new Date(m.last_mentioned).toLocaleDateString('zh-CN');
                            memoryPrompt += `${i + 1}. ${m.title}ï¼ˆ${date}`;
                            if (m.mention_count) {
                                memoryPrompt += `ï¼ŒæåŠ${m.mention_count}æ¬¡`;
                            }
                            memoryPrompt += `ï¼‰\n`;
                            memoryPrompt += `${m.content}\n`;
                            if (m.assistant_attitude) {
                                memoryPrompt += `ä½ çš„æ€åº¦: ${m.assistant_attitude}\n`;
                            }
                            memoryPrompt += '\n';
                        });
                    }
                    
                    memoryPrompt += '=== è®°å¿†ç»“æŸ ===\n';
                    finalSystemPrompt += memoryPrompt;
                }
                
                const now = new Date();
                const currentTimeStr = now.toLocaleString('zh-CN', {
                    year: 'numeric', month: '2-digit', day: '2-digit',
                    hour: '2-digit', minute: '2-digit', weekday: 'long', hour12: false
                });
                finalSystemPrompt += `\n\n[å½“å‰æ—¶é—´]: ${currentTimeStr}`;
                
                const messagesWithTime = apiMessages.map(msg => {
                    if (msg.timestamp) {
                        const time = new Date(msg.timestamp);
                        const timeStr = time.toLocaleString('zh-CN', {
                            year: 'numeric', month: '2-digit', day: '2-digit',
                            hour: '2-digit', minute: '2-digit', hour12: false
                        });
                        return { role: msg.role, content: `[${timeStr}] ${msg.content}` };
                    }
                    return { role: msg.role, content: msg.content };
                });
                
                const messages = [
                    { role: "system", content: finalSystemPrompt },
                    ...messagesWithTime
                ];
                
                const response = await fetch(config.baseurl + '/chat/completions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${config.apikey}` },
                    body: JSON.stringify({ model: config.modelname, messages: messages })
                });
                
                const data = await response.json();
                hideTypingIndicator();
                
                if (data.choices && data.choices[0]) {
                    const aiResponseText = data.choices[0].message.content.trim();
                    processAndDisplaySegments(aiResponseText);
                }
            } catch (error) {
                hideTypingIndicator();
                console.error('é‡æ–°ç”Ÿæˆå¤±è´¥:', error);
                alert('é‡æ–°ç”Ÿæˆå¤±è´¥');
            }
        }
        
        /**
         * å¼•ç”¨æ°”æ³¡
         */
        let currentQuote = null; // å½“å‰å¼•ç”¨çš„æ°”æ³¡
        
        function quoteBubble(bubble) {
            currentQuote = bubble;
            
            // æ˜¾ç¤ºå¼•ç”¨é¢„è§ˆ
            showQuotePreview(bubble);
            
            // èšç„¦è¾“å…¥æ¡†
            userInput.focus();
            
            showToast('å·²å¼•ç”¨è¯¥æ¶ˆæ¯');
        }
        
        /**
         * æ˜¾ç¤ºå¼•ç”¨é¢„è§ˆ
         */
        function showQuotePreview(bubble) {
            const inputArea = document.getElementById('chat-input-area');
            
            // ç§»é™¤å·²æœ‰çš„å¼•ç”¨é¢„è§ˆ
            const existingQuote = inputArea.querySelector('.quote-reference');
            if (existingQuote) {
                existingQuote.remove();
            }
            
            // è·å–å‘é€è€…æ˜µç§°
            const senderName = bubble.role === 'user' ? config.userNickname : config.aiNickname;
            
            // åˆ›å»ºå¼•ç”¨é¢„è§ˆå…ƒç´  (å¾®ä¿¡é£æ ¼ï¼šæ˜µç§°ï¼šå†…å®¹)
            const quoteDiv = document.createElement('div');
            quoteDiv.classList.add('quote-reference');
            quoteDiv.innerHTML = `
                <div class="quote-content">${escapeHtml(senderName)}ï¼š${escapeHtml(bubble.content)}</div>
                <span class="quote-close" onclick="clearQuote()">Ã—</span>
            `;
            
            // æ·»åŠ åˆ°è¾“å…¥åŒºåŸŸåº•éƒ¨ (textareaä¹‹å)
            const textarea = inputArea.querySelector('#user-input');
            inputArea.insertBefore(quoteDiv, textarea.nextSibling);
        }
        
        /**
         * æ¸…é™¤å¼•ç”¨
         */
        function clearQuote() {
            currentQuote = null;
            const inputArea = document.getElementById('chat-input-area');
            const quoteDiv = inputArea.querySelector('.quote-reference');
            if (quoteDiv) {
                quoteDiv.remove();
            }
        }
        
        /**
         * HTMLè½¬ä¹‰
         */
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        /**
         * ç¼–è¾‘æ°”æ³¡
         */
        function editBubble(bubble) {
            // æ‰¾åˆ°å¯¹åº”çš„DOMå…ƒç´ 
            const messageDiv = chatContainer.querySelector(`[data-bubble-id="${bubble.id}"]`);
            if (!messageDiv) {
                console.error('âŒ æœªæ‰¾åˆ°æ°”æ³¡å…ƒç´ ');
                return;
            }
            
            const bubbleDiv = messageDiv.querySelector('.bubble');
            if (!bubbleDiv) {
                console.error('âŒ æœªæ‰¾åˆ°æ°”æ³¡å†…å®¹å…ƒç´ ');
                return;
            }
            
            // ä¿å­˜åŸå§‹å†…å®¹å’Œå…ƒç´ 
            const originalContent = bubble.content;
            const originalHtml = bubbleDiv.innerHTML;
            
            // æ ‡è®°ä¸ºç¼–è¾‘çŠ¶æ€
            bubbleDiv.classList.add('editing');
            
            // åˆ›å»ºç¼–è¾‘ç•Œé¢
            const textarea = document.createElement('textarea');
            textarea.classList.add('edit-textarea');
            textarea.value = originalContent;
            
            const buttonsDiv = document.createElement('div');
            buttonsDiv.classList.add('edit-buttons');
            
            const saveBtn = document.createElement('button');
            saveBtn.classList.add('edit-btn', 'save');
            saveBtn.textContent = 'ä¿å­˜';
            
            const cancelBtn = document.createElement('button');
            cancelBtn.classList.add('edit-btn', 'cancel');
            cancelBtn.textContent = 'å–æ¶ˆ';
            
            buttonsDiv.appendChild(saveBtn);
            buttonsDiv.appendChild(cancelBtn);
            
            // æ›¿æ¢æ°”æ³¡å†…å®¹
            bubbleDiv.innerHTML = '';
            bubbleDiv.appendChild(textarea);
            bubbleDiv.appendChild(buttonsDiv);
            
            // è‡ªåŠ¨èšç„¦å¹¶é€‰ä¸­æ–‡æœ¬
            textarea.focus();
            textarea.setSelectionRange(textarea.value.length, textarea.value.length);
            
            // å–æ¶ˆæŒ‰é’®
            cancelBtn.onclick = () => {
                bubbleDiv.classList.remove('editing');
                bubbleDiv.innerHTML = originalHtml;
                
                // é‡æ–°ç»‘å®šé•¿æŒ‰èœå•
                setupLongPressMenu(bubbleDiv, bubble);
            };
            
            // ä¿å­˜æŒ‰é’®
            saveBtn.onclick = async () => {
                const newContent = textarea.value.trim();
                
                if (!newContent) {
                    alert('å†…å®¹ä¸èƒ½ä¸ºç©º');
                    return;
                }
                
                if (newContent === originalContent) {
                    // å†…å®¹æœªæ”¹å˜ï¼Œç›´æ¥å–æ¶ˆ
                    cancelBtn.click();
                    return;
                }
                
                // æ ¹æ®è§’è‰²å¤„ç†ä¸åŒçš„ä¿å­˜é€»è¾‘
                if (bubble.role === 'assistant') {
                    // AIæ¶ˆæ¯ï¼šç›´æ¥æ›´æ–°å†…å®¹ï¼ˆä¸éœ€è¦é‡æ–°ç”Ÿæˆï¼‰
                    await saveEditedAIMessage(bubble, newContent, bubbleDiv, originalHtml);
                } else if (bubble.role === 'user') {
                    // ç”¨æˆ·æ¶ˆæ¯ï¼šå¿…é¡»é‡æ–°ç”Ÿæˆ
                    const bubbleIndex = chatHistory.findIndex(b => b.id === bubble.id);
                    if (bubbleIndex === -1) {
                        console.error('âŒ æœªæ‰¾åˆ°æ°”æ³¡ç´¢å¼•');
                        return;
                    }
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰åç»­æ¶ˆæ¯
                    const hasFollowingMessages = bubbleIndex < chatHistory.length - 1;
                    
                    if (hasFollowingMessages) {
                        // æœ‰åç»­æ¶ˆæ¯ï¼Œè¯¢é—®æ˜¯å¦ä¿å­˜åˆ†æ”¯
                        showConfirmDialog({
                            title: 'é‡æ–°ç”Ÿæˆç¡®è®¤',
                            message: 'ç¼–è¾‘åå°†é‡æ–°ç”Ÿæˆå›å¤ï¼Œè¿™ä¼šåˆ é™¤æ­¤æ¶ˆæ¯ä¹‹åçš„æ‰€æœ‰å¯¹è¯ã€‚æ˜¯å¦ä¿å­˜å½“å‰åˆ†æ”¯ï¼Ÿ',
                            buttons: [
                                {
                                    text: 'ä¿å­˜åˆ†æ”¯å¹¶é‡æ–°ç”Ÿæˆ',
                                    className: 'primary',
                                    action: async () => {
                                        exportCurrentBranch();
                                        await doEditAndRegenerate(bubble, bubbleIndex, newContent);
                                    }
                                },
                                {
                                    text: 'ç›´æ¥é‡æ–°ç”Ÿæˆ',
                                    className: 'secondary',
                                    action: async () => {
                                        await doEditAndRegenerate(bubble, bubbleIndex, newContent);
                                    }
                                },
                                {
                                    text: 'å–æ¶ˆ',
                                    className: 'cancel',
                                    action: () => {
                                        // æ¢å¤ç¼–è¾‘ç•Œé¢
                                        const messageDiv = chatContainer.querySelector(`[data-bubble-id="${bubble.id}"]`);
                                        const bubbleDiv = messageDiv?.querySelector('.bubble');
                                        if (bubbleDiv) {
                                            const textarea = bubbleDiv.querySelector('.edit-textarea');
                                            if (textarea) {
                                                textarea.value = newContent;
                                            }
                                        }
                                    }
                                }
                            ]
                        });
                    } else {
                        // æ˜¯æœ€åä¸€æ¡ï¼Œç›´æ¥é‡æ–°ç”Ÿæˆ
                        await doEditAndRegenerate(bubble, bubbleIndex, newContent);
                    }
                }
            };
        }
        
        /**
         * ä¿å­˜ç¼–è¾‘åçš„AIæ¶ˆæ¯
         */
        async function saveEditedAIMessage(bubble, newContent, bubbleDiv, originalHtml) {
            // æ›´æ–°æ‰€æœ‰åœ°æ–¹çš„å†…å®¹
            bubble.content = newContent;
            
            // æ›´æ–°chatHistory
            const historyIndex = chatHistory.findIndex(b => b.id === bubble.id);
            if (historyIndex !== -1) {
                chatHistory[historyIndex].content = newContent;
            }
            
            // æ›´æ–°pendingSummaryBubbles
            const pendingIndex = pendingSummaryBubbles.findIndex(b => b.id === bubble.id);
            if (pendingIndex !== -1) {
                pendingSummaryBubbles[pendingIndex].content = newContent;
            }
            
            // ä¿å­˜åˆ°localStorage
            saveChatHistory();
            
            // æ›´æ–°UI
            bubbleDiv.classList.remove('editing');
            
            // æ£€æµ‹å¹¶è§£æå¼•ç”¨
            let quotedText = null;
            let quotedSender = null;
            let mainText = newContent;
            const quoteMatch = newContent.match(/^\[å¼•ç”¨: "(.+?): (.+?)"\]\n\n([\s\S]+)$/);
            if (quoteMatch) {
                quotedSender = quoteMatch[1];
                quotedText = quoteMatch[2];
                mainText = quoteMatch[3];
            }
            
            // ä¿å­˜metaä¿¡æ¯
            const metaDiv = bubbleDiv.querySelector('.message-meta');
            const metaHtml = metaDiv ? metaDiv.outerHTML : '';
            
            // æ¸…ç©ºå¹¶é‡å»ºå†…å®¹
            bubbleDiv.innerHTML = '';
            
            // æ·»åŠ ä¸»è¦æ–‡æœ¬
            const mainTextNode = document.createTextNode(mainText);
            bubbleDiv.appendChild(mainTextNode);
            
            // æ¢å¤metaä¿¡æ¯
            if (metaHtml) {
                bubbleDiv.insertAdjacentHTML('beforeend', metaHtml);
            }
            
            // ã€ä¿®æ”¹ã€‘å¦‚æœæœ‰å¼•ç”¨ï¼Œæ·»åŠ åˆ°contentWrapperï¼ˆæ°”æ³¡å¤–ï¼‰
            const contentWrapper = messageDiv.querySelector('.message-content-wrapper');
            if (quotedText && quotedSender && contentWrapper) {
                // å…ˆç§»é™¤æ—§çš„å¼•ç”¨ï¼ˆå¦‚æœæœ‰ï¼‰
                const oldQuote = contentWrapper.querySelector('.quoted-message');
                if (oldQuote) oldQuote.remove();
                
                const quotedDiv = document.createElement('div');
                quotedDiv.classList.add('quoted-message');
                
                const senderSpan = document.createElement('span');
                senderSpan.classList.add('quote-sender');
                senderSpan.textContent = quotedSender + 'ï¼š';
                
                quotedDiv.appendChild(senderSpan);
                quotedDiv.appendChild(document.createTextNode(quotedText));
                
                contentWrapper.appendChild(quotedDiv); // æ·»åŠ åˆ°contentWrapper
            }
            
            // é‡æ–°ç»‘å®šé•¿æŒ‰èœå•
            setupLongPressMenu(bubbleDiv, bubble);
            
            showToast('å·²ä¿å­˜');
            console.log('âœ… AIæ¶ˆæ¯å·²æ›´æ–°:', bubble.id);
        }
        
        /**
         * æ‰§è¡Œç¼–è¾‘å¹¶é‡æ–°ç”Ÿæˆ
         */
        async function doEditAndRegenerate(bubble, bubbleIndex, newContent) {
            // æ›´æ–°æ¶ˆæ¯å†…å®¹
            bubble.content = newContent;
            chatHistory[bubbleIndex].content = newContent;
            
            // æ›´æ–°UI
            const messageDiv = chatContainer.querySelector(`[data-bubble-id="${bubble.id}"]`);
            const bubbleDiv = messageDiv?.querySelector('.bubble');
            if (bubbleDiv) {
                bubbleDiv.classList.remove('editing');
                
                // æ£€æµ‹å¹¶è§£æå¼•ç”¨
                let quotedText = null;
                let quotedSender = null;
                let mainText = newContent;
                const quoteMatch = newContent.match(/^\[å¼•ç”¨: "(.+?): (.+?)"\]\n\n([\s\S]+)$/);
                if (quoteMatch) {
                    quotedSender = quoteMatch[1];
                    quotedText = quoteMatch[2];
                    mainText = quoteMatch[3];
                }
                
                // ä¿å­˜metaä¿¡æ¯
                const metaDiv = bubbleDiv.querySelector('.message-meta');
                const metaHtml = metaDiv ? metaDiv.outerHTML : '';
                
                // æ¸…ç©ºå¹¶é‡å»ºå†…å®¹
                bubbleDiv.innerHTML = '';
                
                // æ·»åŠ ä¸»è¦æ–‡æœ¬
                const mainTextNode = document.createTextNode(mainText);
                bubbleDiv.appendChild(mainTextNode);
                
                // æ¢å¤metaä¿¡æ¯
                if (metaHtml) {
                    bubbleDiv.insertAdjacentHTML('beforeend', metaHtml);
                }
                
                // ã€ä¿®æ”¹ã€‘å¦‚æœæœ‰å¼•ç”¨ï¼Œæ·»åŠ åˆ°contentWrapperï¼ˆæ°”æ³¡å¤–ï¼‰
                const contentWrapper = messageDiv.querySelector('.message-content-wrapper');
                if (quotedText && quotedSender && contentWrapper) {
                    // å…ˆç§»é™¤æ—§çš„å¼•ç”¨ï¼ˆå¦‚æœæœ‰ï¼‰
                    const oldQuote = contentWrapper.querySelector('.quoted-message');
                    if (oldQuote) oldQuote.remove();
                    
                    const quotedDiv = document.createElement('div');
                    quotedDiv.classList.add('quoted-message');
                    
                    const senderSpan = document.createElement('span');
                    senderSpan.classList.add('quote-sender');
                    senderSpan.textContent = quotedSender + 'ï¼š';
                    
                    quotedDiv.appendChild(senderSpan);
                    quotedDiv.appendChild(document.createTextNode(quotedText));
                    
                    contentWrapper.appendChild(quotedDiv); // æ·»åŠ åˆ°contentWrapper
                }
                
                // é‡æ–°ç»‘å®šé•¿æŒ‰èœå•
                setupLongPressMenu(bubbleDiv, bubble);
            }
            
            // åˆ é™¤åç»­æ‰€æœ‰æ¶ˆæ¯
            const bubblestoDelete = chatHistory.slice(bubbleIndex + 1);
            
            // ä»UIåˆ é™¤
            bubblestoDelete.forEach(b => {
                const msgDiv = chatContainer.querySelector(`[data-bubble-id="${b.id}"]`);
                if (msgDiv) msgDiv.remove();
            });
            
            // ä»æ•°æ®åˆ é™¤
            chatHistory = chatHistory.slice(0, bubbleIndex + 1);
            pendingSummaryBubbles = pendingSummaryBubbles.filter(b => 
                !bubblestoDelete.find(deleted => deleted.id === b.id)
            );
            
            // ä¿å­˜
            saveChatHistory();
            
            showToast('æ­£åœ¨é‡æ–°ç”Ÿæˆ...');
            console.log('ğŸ”„ ç¼–è¾‘åé‡æ–°ç”Ÿæˆï¼Œåˆ é™¤äº†', bubblestoDelete.length, 'ä¸ªæ°”æ³¡');
            
            // è°ƒç”¨APIé‡æ–°ç”Ÿæˆ
            await callAPIForRegeneration();
        }
        
        // ========== é•¿æœŸè®°å¿†åŠŸèƒ½ ==========
        
        /**
         * æ›´æ–°è®°å¿†çŠ¶æ€æ˜¾ç¤º
         */
        function updateMemoryStatus() {
            const autoSummaryInterval = parseInt(localStorage.getItem('autoSummaryInterval')) || 50;
            const totalBubbles = chatHistory.length;
            const pendingBubbles = pendingSummaryBubbles.length;
            const eventsCount = longTermMemory.important_events?.length || 0;
            const lastSummaryAt = longTermMemory.metadata?.last_summary_at || 0;
            const lastUpdated = longTermMemory.metadata?.last_updated;
            
            // æ›´æ–°DOMï¼ˆå¦‚æœå…ƒç´ å­˜åœ¨ï¼‰
            const totalEl = document.getElementById('total-bubbles-count');
            const pendingEl = document.getElementById('pending-bubbles-count');
            const eventsEl = document.getElementById('events-count');
            const lastTimeEl = document.getElementById('last-summary-time');
            const untilNextEl = document.getElementById('bubbles-until-next');
            
            if (totalEl) totalEl.textContent = totalBubbles;
            if (pendingEl) pendingEl.textContent = pendingBubbles;
            if (eventsEl) eventsEl.textContent = eventsCount;
            
            if (lastTimeEl) {
                if (lastUpdated) {
                    const date = new Date(lastUpdated);
                    lastTimeEl.textContent = date.toLocaleString('zh-CN');
                } else {
                    lastTimeEl.textContent = 'ä»æœª';
                }
            }
            
            if (untilNextEl) {
                const remaining = autoSummaryInterval - pendingBubbles;
                if (remaining > 0) {
                    untilNextEl.textContent = remaining;
                } else {
                    untilNextEl.textContent = 'å·²è¾¾åˆ°ï¼Œå°†åœ¨ä¸‹æ¬¡å›å¤åè§¦å‘';
                }
            }
        }
        
        /**
         * ç”Ÿæˆè®°å¿†æ€»ç»“
         * @param {boolean} manual - æ˜¯å¦ä¸ºæ‰‹åŠ¨è§¦å‘
         */
        async function generateMemorySummary(manual = false) {
            // æ£€æŸ¥æ˜¯å¦æœ‰å¾…æ€»ç»“çš„å†…å®¹
            if (pendingSummaryBubbles.length === 0) {
                if (manual) {
                    alert('å½“å‰æ²¡æœ‰æ–°çš„å¯¹è¯éœ€è¦æ€»ç»“ï¼');
                }
                return;
            }
            
            // æ£€æŸ¥APIé…ç½®
            if (!config.baseurl || !config.apikey || !config.modelname) {
                alert('è¯·å…ˆé…ç½®APIï¼');
                return;
            }
            
            if (manual) {
                if (!confirm(`å°†æ€»ç»“æœ€è¿‘ ${pendingSummaryBubbles.length} ä¸ªæ°”æ³¡çš„å†…å®¹ï¼Œç”Ÿæˆé•¿æœŸè®°å¿†ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ`)) {
                    return;
                }
            }
            
            try {
                // æ˜¾ç¤ºåŠ è½½æç¤º
                const loadingMsg = manual ? 'æ­£åœ¨ç”Ÿæˆè®°å¿†æ€»ç»“ï¼Œè¯·ç¨å€™...' : 'åå°æ›´æ–°é•¿æœŸè®°å¿†...';
                showToast(loadingMsg);
                
                // ã€å…³é”®ä¼˜åŒ–ã€‘å‘åå»¶ä¼¸ï¼Œç¡®ä¿æœ€åä¸€æ¡æ¶ˆæ¯æ˜¯å®Œæ•´çš„
                let bubblesToSummarize = extendForward(pendingSummaryBubbles, chatHistory);
                console.log('ğŸ“ è®°å¿†ç”Ÿæˆï¼šåŸå§‹', pendingSummaryBubbles.length, 'æ¡ â†’ å»¶ä¼¸å', bubblesToSummarize.length, 'æ¡');
                
                // å‡†å¤‡å¯¹è¯å†…å®¹
                const conversationText = bubblesToSummarize.map(b => {
                    const time = new Date(b.timestamp).toLocaleString('zh-CN');
                    const speaker = b.role === 'user' ? config.userNickname : config.aiNickname;
                    return `[${time}] ${speaker}: ${b.content}`;
                }).join('\n\n');
                
                // è·å–å¯¹è¯æ—¶é—´èŒƒå›´
                const firstTimestamp = bubblesToSummarize[0]?.timestamp;
                const lastTimestamp = bubblesToSummarize[bubblesToSummarize.length - 1]?.timestamp;
                const timeRange = `${new Date(firstTimestamp).toLocaleString('zh-CN')} è‡³ ${new Date(lastTimestamp).toLocaleString('zh-CN')}`;
                
                // æ„å»ºå·²æœ‰è®°å¿†çš„è¯¦ç»†ä¸Šä¸‹æ–‡
                const existingMemoriesContext = longTermMemory.important_events.map(m => 
                    `[${m.memory_id}] ${m.title} (${m.type})
   å½“å‰é‡è¦åº¦: ${m.importance}åˆ†
   æåŠæ¬¡æ•°: ${m.mention_count}æ¬¡
   æœ€åæåŠ: ${new Date(m.last_mentioned).toLocaleString('zh-CN')}
   å†…å®¹é¢„è§ˆ: ${m.content.substring(0, 100)}...`
                ).join('\n\n');
                
                // æ„å»ºæ€»ç»“prompt
                const summaryPrompt = `ä½ çš„ä»»åŠ¡ï¼šä»å¯¹è¯ä¸­æå–æˆ–æ›´æ–°é•¿æœŸè®°å¿†ã€‚

ã€å¯¹è¯æ—¶é—´èŒƒå›´ã€‘
${timeRange}
æ°”æ³¡æ•°é‡ï¼š${bubblesToSummarize.length}ä¸ª

ã€å½“å‰å·²æœ‰çš„åŸºæœ¬ä¿¡æ¯ã€‘
${Object.keys(longTermMemory.basic_info).length > 0 ? JSON.stringify(longTermMemory.basic_info, null, 2) : 'æ— '}

ã€å½“å‰å·²æœ‰çš„æƒ…æ„Ÿå€¾å‘ã€‘
${longTermMemory.emotional_profile || 'æ— '}

ã€å½“å‰å·²æœ‰çš„é‡è¦äº‹ä»¶ã€‘
${existingMemoriesContext || 'æ— '}

ã€æ–°å¯¹è¯è®°å½•ã€‘
${conversationText}

ã€ä»»åŠ¡è¦æ±‚ã€‘
æ¯æ¬¡ç”Ÿæˆå¿…é¡»å®Œæˆä¸‰ä¸ªåˆ¤æ–­ï¼š

1. åŸºæœ¬ä¿¡æ¯æ›´æ–°åˆ¤æ–­
   - æ˜¯å¦æœ‰æ–°çš„åŸºæœ¬ä¿¡æ¯ï¼ˆå§“åã€å¹´é¾„ã€èŒä¸šã€å±…ä½åœ°ã€å¤–è²Œç‰¹å¾ã€å…´è¶£çˆ±å¥½ç­‰ï¼‰ï¼Ÿ
   - å¦‚æœæœ‰ï¼Œè¾“å‡ºéœ€è¦æ›´æ–°çš„å­—æ®µï¼›å¦‚æœæ— ï¼Œè¾“å‡ºnull

2. æƒ…æ„Ÿå€¾å‘æ›´æ–°åˆ¤æ–­
   - æ˜¯å¦éœ€è¦æ›´æ–°ç”¨æˆ·çš„æ€§æ ¼ç‰¹ç‚¹ã€æƒ…æ„Ÿå€¾å‘æè¿°ï¼Ÿ
   - å¦‚æœéœ€è¦ï¼Œè¾“å‡ºå®Œæ•´çš„æ–°æè¿°ï¼ˆ100-300å­—ï¼‰ï¼›å¦‚æœä¸éœ€è¦ï¼Œè¾“å‡ºnull

3. é‡è¦äº‹ä»¶å¤„ç†ï¼ˆåªç”Ÿæˆ0æˆ–1æ¡ï¼‰
   - ä¼˜å…ˆåˆ¤æ–­ï¼šæ˜¯å¦åœ¨å»¶ç»­/æ›´æ–°å·²æœ‰è®°å¿†ï¼Ÿ
     * å¦‚æœæ˜¯ï¼Œè¾“å‡º action: "update"
   - å…¶æ¬¡åˆ¤æ–­ï¼šæ˜¯å¦æœ‰å€¼å¾—è®°å½•çš„æ–°è¯é¢˜ï¼Ÿ
     * å¦‚æœæ˜¯ï¼Œè¾“å‡º action: "create"
   - æœ€åï¼šå¦‚æœéƒ½ä¸æ˜¯ï¼ˆæ—¥å¸¸å¯’æš„ã€æ— å…³ç´§è¦ï¼‰
     * è¾“å‡º action: "skip"

ã€é‡è¦äº‹ä»¶å¤„ç†è§„åˆ™ã€‘

ä¼˜å…ˆåŒ¹é…å·²æœ‰è®°å¿†ï¼åˆ¤æ–­æ ‡å‡†ï¼š
- è¯é¢˜æ˜¯å¦ç›¸å…³ï¼Ÿï¼ˆå¦‚ï¼šéƒ½åœ¨è®¨è®ºå¥åº·é—®é¢˜ã€å·¥ä½œé—®é¢˜ï¼‰
- æ—¶é—´æ˜¯å¦æ¥è¿‘ï¼Ÿï¼ˆ3å¤©å†…çš„åŒç±»è¯é¢˜ä¼˜å…ˆåŒ¹é…ï¼‰
- æ˜¯å¦æ˜¯äº‹ä»¶çš„å»¶ç»­ï¼Ÿï¼ˆå¦‚ï¼šé¢è¯•â†’ç­‰ç»“æœâ†’æ”¶åˆ°offerï¼‰

åªåœ¨ç¡®å®æ— æ³•åŒ¹é…æ—¶æ‰åˆ›å»ºæ–°è®°å¿†ï¼

ã€è¾“å‡ºæ ¼å¼ã€‘ï¼ˆçº¯JSONï¼Œæ— markdownä»£ç å—ï¼‰
{
  "basic_info_updates": {
    "èŒä¸š": "ç¨‹åºå‘˜",
    "å±…ä½åœ°": "åŒ—äº¬"
  } æˆ– null,
  
  "emotional_profile_update": "å®Œæ•´çš„æƒ…æ„Ÿå€¾å‘æè¿°" æˆ– null,
  
  "memory_action": {
    "action": "update" æˆ– "create" æˆ– "skip",
    
    // å¦‚æœ action æ˜¯ "update"
    "memory_id": "mem_003",
    "new_content": "å…·ä½“æ–°å¢å†…å®¹ï¼ˆå¸¦æ—¥æœŸï¼‰",
    "assistant_attitude": "å½“å‰æ€åº¦" æˆ– "æ—§æ€åº¦(æ—¥æœŸ) â†’ æ–°æ€åº¦(æ—¥æœŸ)",
    "new_importance": æ•°å­—,
    
    // å¦‚æœ action æ˜¯ "create"  
    "title": "3-6å­—ä¸»é¢˜",
    "type": "personal" æˆ– "relationship",
    "content": "å®Œæ•´å†…å®¹ï¼ˆå¸¦æ—¥æœŸï¼‰",
    "assistant_attitude": "æˆ‘çš„æ€åº¦",
    "importance": æ•°å­—,
    
    // å¦‚æœ action æ˜¯ "skip"
    "reason": "ç®€çŸ­è¯´æ˜"
  }
}

ã€é‡è¦åº¦è¯„åˆ†æ ‡å‡†ã€‘ä¸¥æ ¼æ‰§è¡Œï¼
10åˆ†ï¼šæ”¹å˜äººç”Ÿçš„é‡å¤§äº‹ä»¶ï¼ˆç»“å©šã€ç”Ÿå­ã€äº²äººç¦»ä¸–ï¼‰
9åˆ†ï¼šé‡å¤§è½¬æŠ˜ç‚¹ï¼ˆè¾èŒã€ç¡®è¯Šé‡ç—…ã€è¡¨ç™½æˆåŠŸï¼‰
8åˆ†ï¼šé‡è¦é‡Œç¨‹ç¢‘ï¼ˆå‡èŒã€æ¯•ä¸šã€ä¹°æˆ¿ï¼‰
7åˆ†ï¼šå€¼å¾—åº†ç¥çš„æˆå°±ï¼ˆè€ƒè¯•é€šè¿‡ã€é¡¹ç›®æˆåŠŸï¼‰
6åˆ†ï¼šéœ€è¦å…³æ³¨çš„é—®é¢˜ï¼ˆå¥åº·é—®é¢˜ã€çŸ›ç›¾å†²çªï¼‰
5åˆ†ï¼šä¸€èˆ¬é‡è¦äº‹é¡¹ï¼ˆè®¡åˆ’æ—…è¡Œã€ä¹°äº†é‡è¦ç‰©å“ï¼‰
4åˆ†ï¼šæ—¥å¸¸ä½†æœ‰æ„ä¹‰ï¼ˆè§äº†æœ‹å‹ã€çœ‹äº†å¥½ç”µå½±ï¼‰
3åˆ†ï¼šè½»åº¦å€¼å¾—è®°å½•ï¼ˆæ¢äº†å‘å‹ã€å°è¯•æ–°é¤å…ï¼‰
2åˆ†ï¼šæ—¥å¸¸çäº‹ï¼ˆè¿Ÿåˆ°ã€å¿˜å¸¦ä¸œè¥¿ï¼‰
1åˆ†ï¼šå®Œå…¨ä¸é‡è¦ï¼ˆå¤©æ°”ã€éšå£ä¸€è¯´ï¼‰

ã€å¸¸è§é”™è¯¯ç¤ºä¾‹ - é¿å…æ‰“åˆ†è™šé«˜ã€‘
âŒ "ä»Šå¤©æ—©ä¸Šè¿Ÿåˆ°äº†" â†’ ä¸è¦è¯„8åˆ†ï¼Œåº”è¯¥æ˜¯2åˆ†
âŒ "å¾ˆæƒ³ä½ " â†’ ä¸è¦è¯„9åˆ†ï¼Œæ—¥å¸¸è¡¨è¾¾æ„Ÿæƒ…æ˜¯4-5åˆ†
âŒ "åƒäº†å¥½åƒçš„ç«é”…" â†’ ä¸è¦è¯„7åˆ†ï¼Œåº”è¯¥æ˜¯3åˆ†
âŒ "æ¢äº†æ–°å‘å‹" â†’ ä¸è¦è¯„6åˆ†ï¼Œåº”è¯¥æ˜¯3åˆ†

ã€é¢‘ç‡æŠ˜æ‰£è§„åˆ™ã€‘
å¦‚æœæ˜¯æ›´æ–°å·²æœ‰è®°å¿†ï¼ŒæŸ¥çœ‹ mention_countï¼ˆæåŠæ¬¡æ•°ï¼‰ï¼š
- ç¬¬1æ¬¡ï¼šåŸºç¡€åˆ† + 2åˆ†ï¼ˆé¦–æ¬¡å¥–åŠ±ï¼‰
- ç¬¬2æ¬¡ï¼šåŸºç¡€åˆ†
- ç¬¬3-5æ¬¡ï¼šåŸºç¡€åˆ† - 1åˆ†
- ç¬¬6-10æ¬¡ï¼šåŸºç¡€åˆ† - 2åˆ†
- ç¬¬10æ¬¡ä»¥ä¸Šï¼šåŸºç¡€åˆ† - 3åˆ†ï¼ˆå·²æˆæ—¥å¸¸ï¼‰

ã€é¢‘ç‡æŠ˜æ‰£ä¸é€‚ç”¨ã€‘çš„æƒ…å†µï¼ˆæœ‰å®è´¨æ€§è¿›å±•ï¼‰ï¼š
- ç–¾ç—…æ²»ç–—è¿‡ç¨‹ï¼ˆæ¯æ¬¡éƒ½æ˜¯æ–°è¿›å±•ï¼‰
- é‡å¤§è®¡åˆ’æ¨è¿›ï¼ˆåˆ›ä¸šã€ç»“å©šç­¹å¤‡ã€ä¹°æˆ¿ï¼‰
- å­¦ä¸š/é¡¹ç›®è¿›å±•ï¼ˆè€ƒç ”ã€å†™è®ºæ–‡ã€å¼€å‘é¡¹ç›®ï¼‰
- å…³ç³»ä¿®å¤è¿‡ç¨‹ï¼ˆçŸ›ç›¾â†’æ²Ÿé€šâ†’å’Œè§£ï¼‰

ã€é¢‘ç‡æŠ˜æ‰£åº”ç”¨ã€‘çš„æƒ…å†µï¼ˆé‡å¤æŠ±æ€¨ï¼‰ï¼š
- é‡å¤æŠ±æ€¨ï¼ˆå¤©å¤©è¯´åˆ†æ‰‹ä½†ä¸è¡ŒåŠ¨ï¼‰
- å£å¤´æ‰¿è¯ºï¼ˆæ€»è¯´è¦å‡è‚¥/æˆ’çƒŸä½†æ²¡æ‰§è¡Œï¼‰
- æƒ…ç»ªå‘æ³„ï¼ˆæ¯å¤©æŠ±æ€¨åŒæ ·çš„äº‹ï¼‰

ã€assistant_attitudeè§„èŒƒã€‘
- è®°å½•ä½ ï¼ˆAIï¼‰å¯¹è¿™ä¸ªè®°å¿†çš„æƒ…æ„Ÿæ€åº¦
- å¦‚æœæœ¬æ¬¡æ˜¯ç¬¬ä¸€æ¬¡æåŠï¼šç›´æ¥å†™æ€åº¦ï¼ˆå¦‚"å…³å¿ƒ"ï¼‰
- å¦‚æœæ˜¯æ›´æ–°å·²æœ‰è®°å¿†ä¸”æ€åº¦æœ‰å˜åŒ–ï¼šç”¨"â†’"è¿æ¥å¹¶æ ‡æ³¨æ—¥æœŸ
  æ ¼å¼ï¼šæ—§æ€åº¦(MM/DD) â†’ æ–°æ€åº¦(MM/DD)
  ä¾‹å¦‚ï¼šå…³å¿ƒ(12/10) â†’ æ‹…å¿ƒ(12/22) â†’ æ”¾å¿ƒ(12/28)
- å¸¸è§æ€åº¦è¯ï¼šå…³å¿ƒã€æ‹…å¿ƒã€å¼€å¿ƒã€éš¾è¿‡ã€ç”Ÿæ°”ã€ç†è§£ã€å…±æƒ…ã€é¼“åŠ±ã€å®‰æ…°ã€æ”¯æŒã€éª„å‚²ã€é—æ†¾

ã€titleå‘½åè§„èŒƒã€‘
- 3-6ä¸ªæ±‰å­—
- æ ¼å¼ï¼šé¢†åŸŸ-å…·ä½“äº‹ä»¶
- ä¾‹å¦‚ï¼šå·¥ä½œ-å‡èŒã€å¥åº·-èƒƒç—…ã€æ„Ÿæƒ…-åµæ¶ã€ç”Ÿæ´»-æ¬å®¶
- é¿å…å¤ªå®½æ³›ï¼ˆå¦‚"å·¥ä½œ"ï¼‰æˆ–å¤ªå…·ä½“ï¼ˆå¦‚"2025å¹´12æœˆ10æ—¥è…¹ç—›"ï¼‰

ã€å†…å®¹æ ¼å¼è§„èŒƒã€‘
- æ¯å¥è¯åæ ‡æ³¨æ—¥æœŸï¼š(MM/DD) æˆ– (YYYY/MM/DD)
- ç®€æ´è¡¨è¾¾ï¼Œä¸è¶…è¿‡200å­—
- ä¾‹å¦‚ï¼šè…¹ç—›æ¯”è¾ƒä¸¥é‡ï¼ˆ12/10ï¼‰ã€‚å»åŒ»é™¢åšäº†æ£€æŸ¥ï¼ˆ12/22ï¼‰ã€‚ç¡®è¯Šä¸ºæ…¢æ€§èƒƒç‚ï¼ˆ12/28ï¼‰ã€‚

ã€è¾“å‡ºæ ¼å¼ã€‘ï¼ˆçº¯JSONï¼Œä¸è¦markdownä»£ç å—æ ‡è®°ï¼‰
{
  "basic_info_updates": {
    "èŒä¸š": "ç¨‹åºå‘˜"
  } æˆ– null,
  
  "emotional_profile_update": "å®Œæ•´çš„æƒ…æ„Ÿå€¾å‘æè¿°" æˆ– null,
  
  "memory_action": {
    "action": "update" æˆ– "create" æˆ– "skip",
    
    // å¦‚æœ action æ˜¯ "update"
    "memory_id": "mem_003",
    "new_content": "å…·ä½“æ–°å¢å†…å®¹ï¼ˆå¸¦æ—¥æœŸï¼‰",
    "assistant_attitude": "å½“å‰æ€åº¦" æˆ– "æ—§æ€åº¦(æ—¥æœŸ) â†’ æ–°æ€åº¦(æ—¥æœŸ)",
    "new_importance": æ•°å­—,
    
    // å¦‚æœ action æ˜¯ "create"  
    "title": "3-6å­—ä¸»é¢˜",
    "type": "personal" æˆ– "relationship",
    "content": "å®Œæ•´å†…å®¹ï¼ˆå¸¦æ—¥æœŸï¼‰",
    "assistant_attitude": "æˆ‘çš„æ€åº¦",
    "importance": æ•°å­—,
    
    // å¦‚æœ action æ˜¯ "skip"
    "reason": "ç®€çŸ­è¯´æ˜"
  }
}`;
                
                // è°ƒç”¨API
                const response = await fetch(config.baseurl + '/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${config.apikey}`
                    },
                    body: JSON.stringify({
                        model: config.modelname,
                        messages: [
                            { role: 'system', content: 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è®°å¿†æ•´ç†åŠ©æ‰‹ï¼Œæ“…é•¿æå–å’Œæ€»ç»“å¯¹è¯ä¸­çš„å…³é”®ä¿¡æ¯ã€‚è¯·ä¸¥æ ¼æŒ‰ç…§è¦æ±‚è¾“å‡ºçº¯JSONæ ¼å¼ã€‚' },
                            { role: 'user', content: summaryPrompt }
                        ],
                        temperature: 0.3
                    })
                });
                
                const data = await response.json();
                
                if (data.choices && data.choices[0]) {
                    let aiResponse = data.choices[0].message.content.trim();
                    
                    // ç§»é™¤å¯èƒ½çš„markdownä»£ç å—æ ‡è®°
                    aiResponse = aiResponse.replace(/^```json\n?/i, '').replace(/\n?```$/i, '');
                    
                    // è§£æJSON
                    const result = JSON.parse(aiResponse);
                    
                    console.log('ğŸ§  AIè¿”å›ç»“æœ:', result);
                    
                    // 1. å¤„ç†åŸºæœ¬ä¿¡æ¯æ›´æ–°
                    if (result.basic_info_updates) {
                        for (const [key, value] of Object.entries(result.basic_info_updates)) {
                            longTermMemory.basic_info[key] = value;
                        }
                        console.log('ğŸ“ æ›´æ–°åŸºæœ¬ä¿¡æ¯:', result.basic_info_updates);
                    }
                    
                    // 2. å¤„ç†æƒ…æ„Ÿå€¾å‘æ›´æ–°
                    if (result.emotional_profile_update) {
                        longTermMemory.emotional_profile = result.emotional_profile_update;
                        console.log('ğŸ’­ æ›´æ–°æƒ…æ„Ÿå€¾å‘');
                    }
                    
                    // 3. å¤„ç†é‡è¦äº‹ä»¶
                    const memoryAction = result.memory_action;
                    
                    if (memoryAction.action === "update") {
                        // æ›´æ–°å·²æœ‰è®°å¿†
                        const memory = longTermMemory.important_events.find(m => m.memory_id === memoryAction.memory_id);
                        if (memory) {
                            memory.content += " " + memoryAction.new_content;
                            memory.last_mentioned = lastTimestamp;
                            memory.mention_count++;
                            memory.assistant_attitude = memoryAction.assistant_attitude;
                            memory.importance = memoryAction.new_importance;
                            console.log('ğŸ”„ æ›´æ–°è®°å¿†:', memoryAction.memory_id, memory.title);
                        } else {
                            console.warn('âš ï¸ æœªæ‰¾åˆ°è¦æ›´æ–°çš„è®°å¿†:', memoryAction.memory_id);
                        }
                        
                    } else if (memoryAction.action === "create") {
                        // åˆ›å»ºæ–°è®°å¿†
                        const newMemory = {
                            memory_id: "mem_" + String(longTermMemory.metadata.next_memory_id).padStart(3, '0'),
                            type: memoryAction.type,
                            title: memoryAction.title,
                            created_at: firstTimestamp,
                            last_mentioned: lastTimestamp,
                            mention_count: 1,
                            content: memoryAction.content,
                            assistant_attitude: memoryAction.assistant_attitude,
                            importance: memoryAction.importance
                        };
                        
                        longTermMemory.important_events.push(newMemory);
                        longTermMemory.metadata.next_memory_id++;
                        
                        console.log('âœ¨ åˆ›å»ºæ–°è®°å¿†:', newMemory.memory_id, newMemory.title);
                        
                    } else if (memoryAction.action === "skip") {
                        console.log('â­ï¸ è·³è¿‡è®°å¿†ç”Ÿæˆ:', memoryAction.reason);
                    }
                    
                    // æŒ‰é‡è¦åº¦æ’åºï¼Œä¿ç•™æœ€é‡è¦çš„Næ¡
                    const maxEvents = parseInt(localStorage.getItem('maxImportantEvents')) || 10;
                    longTermMemory.important_events.sort((a, b) => b.importance - a.importance);
                    if (longTermMemory.important_events.length > maxEvents) {
                        const removed = longTermMemory.important_events.splice(maxEvents);
                        console.log('ğŸ—‘ï¸ ç§»é™¤ä½é‡è¦åº¦è®°å¿†:', removed.map(m => m.title).join(', '));
                    }
                    
                    // æ›´æ–°å…ƒæ•°æ®
                    longTermMemory.metadata = {
                        total_messages: chatHistory.length,
                        last_summary_at: chatHistory.length,
                        last_updated: new Date().toISOString(),
                        version: 2,
                        next_memory_id: longTermMemory.metadata.next_memory_id
                    };
                    
                    // æ¸…ç©ºå¾…æ€»ç»“ç¼“å†²åŒº
                    pendingSummaryBubbles = [];
                    
                    // ä¿å­˜
                    saveChatHistory();
                    
                    // æ›´æ–°UI
                    updateMemoryStatus();
                    
                    // å›å¡«åŸºæœ¬ä¿¡æ¯åˆ°è¾“å…¥æ¡†
                    fillBasicInfoInputs();
                    
                    if (manual) {
                        showToast('âœ… è®°å¿†æ€»ç»“å®Œæˆï¼');
                        alert(`è®°å¿†æ€»ç»“æˆåŠŸï¼\n\né‡è¦äº‹ä»¶æ•°ï¼š${longTermMemory.important_events?.length || 0} æ¡`);
                    } else {
                        showToast('âœ… é•¿æœŸè®°å¿†å·²æ›´æ–°');
                    }
                    
                    console.log('ğŸ§  é•¿æœŸè®°å¿†å·²æ›´æ–°:', longTermMemory);
                } else {
                    throw new Error('APIè¿”å›æ ¼å¼é”™è¯¯');
                }
                
            } catch (error) {
                console.error('âŒ ç”Ÿæˆè®°å¿†å¤±è´¥:', error);
                if (manual) {
                    alert('ç”Ÿæˆè®°å¿†å¤±è´¥ï¼š' + error.message);
                }
            }
        }
        
        /**
         * æ£€æŸ¥æ˜¯å¦éœ€è¦è‡ªåŠ¨ç”Ÿæˆè®°å¿†
         */
        function checkAutoSummary() {
            const autoSummaryInterval = parseInt(localStorage.getItem('autoSummaryInterval')) || 50;
            
            if (pendingSummaryBubbles.length >= autoSummaryInterval) {
                console.log('ğŸ§  è¾¾åˆ°è‡ªåŠ¨æ€»ç»“æ¡ä»¶ï¼Œå¼€å§‹ç”Ÿæˆè®°å¿†...');
                // å¼‚æ­¥æ‰§è¡Œï¼Œä¸é˜»å¡ä¸»æµç¨‹
                setTimeout(() => generateMemorySummary(false), 1000);
            }
        }
        
        /**
         * å›å¡«åŸºæœ¬ä¿¡æ¯åˆ°è¾“å…¥æ¡†ï¼ˆä»é•¿æœŸè®°å¿†ä¸­è¯»å–ï¼‰
         */
        function fillBasicInfoInputs() {
            const nameEl = document.getElementById('memory-name');
            const ageEl = document.getElementById('memory-age');
            const occupationEl = document.getElementById('memory-occupation');
            const locationEl = document.getElementById('memory-location');
            const appearanceEl = document.getElementById('memory-appearance');
            const interestsEl = document.getElementById('memory-interests');
            
            if (nameEl && longTermMemory.basic_info?.å§“å) {
                nameEl.value = longTermMemory.basic_info.å§“å;
            }
            if (ageEl && longTermMemory.basic_info?.å¹´é¾„) {
                ageEl.value = longTermMemory.basic_info.å¹´é¾„;
            }
            if (occupationEl && longTermMemory.basic_info?.èŒä¸š) {
                occupationEl.value = longTermMemory.basic_info.èŒä¸š;
            }
            if (locationEl && longTermMemory.basic_info?.å±…ä½åœ°) {
                locationEl.value = longTermMemory.basic_info.å±…ä½åœ°;
            }
            if (appearanceEl && longTermMemory.basic_info?.å¤–è²Œç‰¹å¾) {
                appearanceEl.value = longTermMemory.basic_info.å¤–è²Œç‰¹å¾;
            }
            if (interestsEl && longTermMemory.basic_info?.å…´è¶£çˆ±å¥½) {
                interestsEl.value = longTermMemory.basic_info.å…´è¶£çˆ±å¥½;
            }
        }
        
        /**
         * ä¿å­˜åŸºæœ¬ä¿¡æ¯
         */
        function saveBasicInfo() {
            const name = document.getElementById('memory-name').value.trim();
            const age = document.getElementById('memory-age').value.trim();
            const occupation = document.getElementById('memory-occupation').value.trim();
            const location = document.getElementById('memory-location').value.trim();
            const appearance = document.getElementById('memory-appearance').value.trim();
            const interests = document.getElementById('memory-interests').value.trim();
            
            // æ›´æ–°é•¿æœŸè®°å¿†çš„åŸºæœ¬ä¿¡æ¯
            if (name) longTermMemory.basic_info.å§“å = name;
            if (age) longTermMemory.basic_info.å¹´é¾„ = age;
            if (occupation) longTermMemory.basic_info.èŒä¸š = occupation;
            if (location) longTermMemory.basic_info.å±…ä½åœ° = location;
            if (appearance) longTermMemory.basic_info.å¤–è²Œç‰¹å¾ = appearance;
            if (interests) longTermMemory.basic_info.å…´è¶£çˆ±å¥½ = interests;
            
            // å¦‚æœæœ‰ä»»ä½•ä¿¡æ¯è¢«å¡«å†™ï¼Œæ›´æ–°å…ƒæ•°æ®
            if (name || age || occupation || location || appearance || interests) {
                if (!longTermMemory.metadata.last_updated) {
                    longTermMemory.metadata.last_updated = new Date().toISOString();
                }
            }
            
            saveChatHistory();
            updateMemoryStatus();
            
            showToast('âœ… åŸºæœ¬ä¿¡æ¯å·²ä¿å­˜');
        }
        
        /**
         * ç¼–è¾‘è®°å¿†ï¼ˆæ‰“å¼€ç¼–è¾‘æ¨¡æ€çª—å£ï¼‰
         */
        function editMemory() {
            const modal = document.getElementById('memory-edit-modal');
            
            // å¡«å……åŸºæœ¬ä¿¡æ¯
            const basicInfoEditor = document.getElementById('basic-info-editor');
            const basicInfoFields = [
                { key: 'å§“å', placeholder: 'ä¾‹å¦‚ï¼šå°æ˜' },
                { key: 'å¹´é¾„', placeholder: 'ä¾‹å¦‚ï¼š25' },
                { key: 'èŒä¸š', placeholder: 'ä¾‹å¦‚ï¼šç¨‹åºå‘˜' },
                { key: 'å±…ä½åœ°', placeholder: 'ä¾‹å¦‚ï¼šåŒ—äº¬' },
                { key: 'æ€§åˆ«', placeholder: 'ä¾‹å¦‚ï¼šç”·/å¥³' },
                { key: 'å¤–è²Œç‰¹å¾', placeholder: 'ä¾‹å¦‚ï¼šé«˜ä¸ªå­ã€çŸ­å‘' },
                { key: 'å…´è¶£çˆ±å¥½', placeholder: 'ä¾‹å¦‚ï¼šç¼–ç¨‹ã€æ¸¸æˆ' }
            ];
            
            basicInfoEditor.innerHTML = basicInfoFields.map(field => {
                const value = longTermMemory.basic_info[field.key] || '';
                return `
                    <div class="basic-info-item">
                        <label>${field.key}ï¼š</label>
                        <input type="text" data-key="${field.key}" value="${value}" placeholder="${field.placeholder}">
                    </div>
                `;
            }).join('');
            
            // å¡«å……æƒ…æ„Ÿå€¾å‘
            document.getElementById('emotional-profile-editor').value = longTermMemory.emotional_profile || '';
            
            // å¡«å……é‡è¦äº‹ä»¶
            renderEventsEditor();
            
            // æ˜¾ç¤ºæ¨¡æ€çª—å£
            modal.style.display = 'flex';
        }
        
        /**
         * æ¸²æŸ“è®°å¿†ç‰‡æ®µå†å²
         */
        
        /**
         * æ¸²æŸ“äº‹ä»¶ç¼–è¾‘å™¨
         */
        function renderEventsEditor() {
            const eventsEditor = document.getElementById('events-editor');
            const events = longTermMemory.important_events || [];
            
            if (events.length === 0) {
                eventsEditor.innerHTML = '<p style="color: #999; font-size: 14px;">æš‚æ— é‡è¦äº‹ä»¶</p>';
                return;
            }
            
            eventsEditor.innerHTML = events.map((event, index) => {
                const eventType = event.type || 'personal';
                const createdDate = new Date(event.created_at).toLocaleDateString('zh-CN');
                const lastMentioned = new Date(event.last_mentioned).toLocaleDateString('zh-CN');
                
                return `
                <div class="event-item" data-index="${index}">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; gap: 10px;">
                        <div style="flex: 1; display: flex; align-items: center; gap: 8px;">
                            <strong style="color: #999; font-size: 12px;">${event.memory_id}</strong>
                            <input type="text" value="${event.title}" onchange="updateEventTitle(${index}, this.value)" placeholder="äº‹ä»¶ä¸»é¢˜" style="flex: 1; padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; font-weight: 500;">
                        </div>
                        <div style="font-size: 12px; color: #999; white-space: nowrap;">
                            æåŠ ${event.mention_count} æ¬¡
                        </div>
                    </div>
                    <div class="event-item-header">
                        <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                            <div>
                                <label style="font-size: 12px; color: #666;">ç±»å‹ï¼š</label>
                                <select onchange="updateEventType(${index}, this.value)" style="padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                                    <option value="personal" ${eventType === 'personal' ? 'selected' : ''}>ğŸ‘¤ ä¸ªäºº</option>
                                    <option value="relationship" ${eventType === 'relationship' ? 'selected' : ''}>â¤ï¸ æ„Ÿæƒ…</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size: 12px; color: #666;">åˆ›å»ºï¼š</label>
                                <span style="font-size: 12px;">${createdDate}</span>
                            </div>
                            <div>
                                <label style="font-size: 12px; color: #666;">æœ€åæåŠï¼š</label>
                                <span style="font-size: 12px;">${lastMentioned}</span>
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <div class="event-item-importance">
                                <label>é‡è¦åº¦ï¼š</label>
                                <input type="number" min="1" max="10" value="${event.importance}" onchange="updateEventImportance(${index}, this.value)">
                            </div>
                            <button class="event-item-delete" onclick="deleteEvent(${index})">åˆ é™¤</button>
                        </div>
                    </div>
                    <div style="margin-top: 8px;">
                        <label style="font-size: 12px; color: #666; display: block; margin-bottom: 4px;">å†…å®¹ï¼š</label>
                        <textarea rows="3" placeholder="è®°å¿†å†…å®¹ï¼ˆå¸¦æ—¥æœŸæ ‡æ³¨ï¼‰" onchange="updateEventContent(${index}, this.value)" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; box-sizing: border-box;">${event.content || ''}</textarea>
                    </div>
                    <div style="margin-top: 8px;">
                        <label style="font-size: 12px; color: #666; display: block; margin-bottom: 4px;">AIæ€åº¦ï¼š</label>
                        <input type="text" value="${event.assistant_attitude || ''}" onchange="updateEventAttitude(${index}, this.value)" placeholder="ä¾‹å¦‚ï¼šå…³å¿ƒã€æ‹…å¿ƒ" style="width: 100%; padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; box-sizing: border-box;">
                    </div>
                </div>
            `;
            }).join('');
        }
        
        /**
         * æ›´æ–°äº‹ä»¶ç±»å‹
         */
        function updateEventType(index, type) {
            if (longTermMemory.important_events[index]) {
                longTermMemory.important_events[index].type = type;
            }
        }
        
        /**
         * æ›´æ–°äº‹ä»¶æ ‡é¢˜
         */
        function updateEventTitle(index, title) {
            if (longTermMemory.important_events[index]) {
                longTermMemory.important_events[index].title = title;
            }
        }
        
        /**
         * æ›´æ–°äº‹ä»¶é‡è¦åº¦
         */
        function updateEventImportance(index, importance) {
            if (longTermMemory.important_events[index]) {
                longTermMemory.important_events[index].importance = parseInt(importance) || 5;
            }
        }
        
        /**
         * æ›´æ–°äº‹ä»¶å†…å®¹
         */
        function updateEventContent(index, content) {
            if (longTermMemory.important_events[index]) {
                longTermMemory.important_events[index].content = content;
            }
        }
        
        /**
         * æ›´æ–°äº‹ä»¶AIæ€åº¦
         */
        function updateEventAttitude(index, attitude) {
            if (longTermMemory.important_events[index]) {
                longTermMemory.important_events[index].assistant_attitude = attitude;
            }
        }
        
        /**
         * åˆ é™¤äº‹ä»¶
         */
        function deleteEvent(index) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªäº‹ä»¶å—ï¼Ÿ')) {
                longTermMemory.important_events.splice(index, 1);
                renderEventsEditor();
            }
        }
        
        /**
         * æ·»åŠ æ–°äº‹ä»¶
         */
        function addNewEvent() {
            const now = new Date().toISOString();
            const newEvent = {
                memory_id: "mem_" + String(longTermMemory.metadata.next_memory_id).padStart(3, '0'),
                type: 'personal',
                title: 'æ–°äº‹ä»¶',
                created_at: now,
                last_mentioned: now,
                mention_count: 1,
                content: '',
                assistant_attitude: '',
                importance: 5
            };
            
            if (!longTermMemory.important_events) {
                longTermMemory.important_events = [];
            }
            
            longTermMemory.important_events.push(newEvent);
            longTermMemory.metadata.next_memory_id++;
            renderEventsEditor();
        }
        
        /**
         * ä¿å­˜è®°å¿†ç¼–è¾‘
         */
        function saveMemoryEdit() {
            // ä¿å­˜åŸºæœ¬ä¿¡æ¯
            const basicInfoInputs = document.querySelectorAll('#basic-info-editor input');
            basicInfoInputs.forEach(input => {
                const key = input.getAttribute('data-key');
                const value = input.value.trim();
                if (value) {
                    longTermMemory.basic_info[key] = value;
                } else {
                    delete longTermMemory.basic_info[key];
                }
            });
            
            // ä¿å­˜æƒ…æ„Ÿå€¾å‘
            longTermMemory.emotional_profile = document.getElementById('emotional-profile-editor').value.trim();
            
            // æ›´æ–°å…ƒæ•°æ®
            longTermMemory.metadata.last_updated = new Date().toISOString();
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            saveChatHistory();
            updateMemoryStatus();
            
            // å…³é—­æ¨¡æ€çª—å£
            closeMemoryEdit();
            
            showToast('âœ… è®°å¿†å·²ä¿å­˜');
        }
        
        /**
         * å…³é—­è®°å¿†ç¼–è¾‘æ¨¡æ€çª—å£
         */
        function closeMemoryEdit() {
            const modal = document.getElementById('memory-edit-modal');
            modal.style.display = 'none';
        }
        
        /**
         * æ¸…ç©ºè®°å¿†
         */
        function clearMemory() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰é•¿æœŸè®°å¿†å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                return;
            }
            
            longTermMemory = {
                basic_info: {},
                emotional_profile: "",
                important_events: [],
                metadata: {
                    total_messages: 0,
                    last_summary_at: 0,
                    last_updated: null,
                    version: 2,
                    next_memory_id: 1
                }
            };
            
            pendingSummaryBubbles = [];
            
            saveChatHistory();
            updateMemoryStatus();
            
            alert('âœ… é•¿æœŸè®°å¿†å·²æ¸…ç©ºï¼');
        }
        
        // ========== æ‰¹é‡ç”ŸæˆåŠŸèƒ½ ==========
        
        /**
         * æ˜¾ç¤ºæ‰¹é‡ç”Ÿæˆå¯¹è¯æ¡†
         */
        function showBatchGenerateDialog() {
            const dialog = document.getElementById('batch-generate-dialog');
            const totalBubbles = chatHistory.length;
            const alreadySummarized = longTermMemory.metadata?.last_summary_at || 0;
            const pendingBubbles = pendingSummaryBubbles.length;
            const interval = parseInt(localStorage.getItem('autoSummaryInterval')) || 50;
            
            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            document.getElementById('batch-total-bubbles').textContent = totalBubbles;
            document.getElementById('batch-already-summarized').textContent = alreadySummarized;
            document.getElementById('batch-pending-bubbles').textContent = pendingBubbles;
            document.getElementById('batch-interval').textContent = interval;
            
            // è®¡ç®—é»˜è®¤çš„APIè°ƒç”¨æ¬¡æ•°ï¼ˆä»…å¾…æ€»ç»“éƒ¨åˆ†ï¼‰
            const defaultApiCalls = Math.ceil(pendingBubbles / interval);
            document.getElementById('batch-api-calls').textContent = defaultApiCalls;
            document.getElementById('batch-estimated-time').textContent = Math.ceil(defaultApiCalls * 0.5); // å‡è®¾æ¯æ¬¡30ç§’
            
            // ç›‘å¬å•é€‰æŒ‰é’®å˜åŒ–
            const radios = document.querySelectorAll('input[name="batch-mode"]');
            radios.forEach(radio => {
                radio.onchange = () => updateBatchEstimate();
            });
            
            // ç›‘å¬æœ€è¿‘Næ¡è¾“å…¥æ¡†å˜åŒ–
            const recentCountInput = document.getElementById('batch-recent-count');
            recentCountInput.oninput = () => {
                if (document.querySelector('input[name="batch-mode"]:checked').value === 'recent') {
                    updateBatchEstimate();
                }
            };
            
            // é‡ç½®è¿›åº¦
            document.getElementById('batch-progress').style.display = 'none';
            document.getElementById('batch-start-btn').disabled = false;
            
            dialog.style.display = 'flex';
        }
        
        /**
         * æ›´æ–°æ‰¹é‡ç”Ÿæˆä¼°ç®—
         */
        function updateBatchEstimate() {
            const mode = document.querySelector('input[name="batch-mode"]:checked').value;
            const interval = parseInt(localStorage.getItem('autoSummaryInterval')) || 50;
            const totalBubbles = chatHistory.length;
            const alreadySummarized = longTermMemory.metadata?.last_summary_at || 0;
            const pendingBubbles = pendingSummaryBubbles.length;
            
            let bubblesCount = 0;
            
            switch (mode) {
                case 'pending':
                    bubblesCount = pendingBubbles;
                    break;
                case 'all':
                    bubblesCount = totalBubbles;
                    break;
                case 'recent':
                    const recentCount = parseInt(document.getElementById('batch-recent-count').value) || 500;
                    bubblesCount = Math.min(recentCount, totalBubbles);
                    break;
            }
            
            const apiCalls = Math.ceil(bubblesCount / interval);
            const estimatedMinutes = Math.ceil(apiCalls * 0.5);
            
            document.getElementById('batch-api-calls').textContent = apiCalls;
            document.getElementById('batch-estimated-time').textContent = estimatedMinutes;
        }
        
        /**
         * å…³é—­æ‰¹é‡ç”Ÿæˆå¯¹è¯æ¡†
         */
        function closeBatchGenerateDialog() {
            const dialog = document.getElementById('batch-generate-dialog');
            dialog.style.display = 'none';
        }
        
        /**
         * å¼€å§‹æ‰¹é‡ç”Ÿæˆ
         */
        async function startBatchGenerate() {
            const mode = document.querySelector('input[name="batch-mode"]:checked').value;
            const interval = parseInt(localStorage.getItem('autoSummaryInterval')) || 50;
            
            // ç¡®å®šè¦å¤„ç†çš„æ°”æ³¡èŒƒå›´
            let bubblesToProcess = [];
            
            switch (mode) {
                case 'pending':
                    // ä»…å¤„ç†å¾…æ€»ç»“çš„
                    bubblesToProcess = [...pendingSummaryBubbles];
                    break;
                    
                case 'all':
                    // æ¸…ç©ºç°æœ‰è®°å¿†ï¼Œä»å¤´å¼€å§‹
                    if (!confirm('æ­¤æ“ä½œå°†æ¸…ç©ºç°æœ‰è®°å¿†å¹¶é‡æ–°ç”Ÿæˆã€‚ç¡®å®šç»§ç»­å—ï¼Ÿ')) {
                        return;
                    }
                    longTermMemory = {
                        basic_info: {},
                        emotional_profile: "",
                        important_events: [],
                        metadata: {
                            total_messages: 0,
                            last_summary_at: 0,
                            last_updated: null,
                            version: 1
                        }
                    };
                    bubblesToProcess = [...chatHistory];
                    break;
                    
                case 'recent':
                    // ä»æœ€è¿‘Næ¡å¼€å§‹
                    const recentCount = parseInt(document.getElementById('batch-recent-count').value) || 500;
                    const startIndex = Math.max(0, chatHistory.length - recentCount);
                    
                    // æ¸…ç©ºç°æœ‰è®°å¿†
                    if (!confirm(`æ­¤æ“ä½œå°†æ¸…ç©ºç°æœ‰è®°å¿†ï¼Œå¹¶ä»æœ€è¿‘ ${recentCount} æ¡é‡æ–°ç”Ÿæˆã€‚ç¡®å®šç»§ç»­å—ï¼Ÿ`)) {
                        return;
                    }
                    longTermMemory = {
                        basic_info: {},
                        emotional_profile: "",
                        important_events: [],
                        metadata: {
                            total_messages: 0,
                            last_summary_at: 0,
                            last_updated: null,
                            version: 1
                        }
                    };
                    bubblesToProcess = chatHistory.slice(startIndex);
                    break;
            }
            
            if (bubblesToProcess.length === 0) {
                alert('æ²¡æœ‰éœ€è¦å¤„ç†çš„æ°”æ³¡ï¼');
                return;
            }
            
            // æ˜¾ç¤ºè¿›åº¦
            const progressDiv = document.getElementById('batch-progress');
            const progressBar = document.getElementById('batch-progress-bar');
            const progressText = document.getElementById('batch-progress-text');
            const statusText = document.getElementById('batch-current-status');
            const startBtn = document.getElementById('batch-start-btn');
            
            progressDiv.style.display = 'block';
            startBtn.disabled = true;
            startBtn.textContent = 'ç”Ÿæˆä¸­...';
            
            // åˆ†æ‰¹å¤„ç†
            const totalBatches = Math.ceil(bubblesToProcess.length / interval);
            let successCount = 0;
            let failCount = 0;
            
            for (let i = 0; i < totalBatches; i++) {
                const start = i * interval;
                const end = Math.min(start + interval, bubblesToProcess.length);
                const batch = bubblesToProcess.slice(start, end);
                
                // æ›´æ–°è¿›åº¦
                const progress = ((i + 1) / totalBatches * 100).toFixed(1);
                progressBar.style.width = progress + '%';
                progressText.textContent = `${i + 1} / ${totalBatches}`;
                statusText.textContent = `æ­£åœ¨å¤„ç†ç¬¬ ${start + 1}-${end} ä¸ªæ°”æ³¡...`;
                
                try {
                    // ä¸´æ—¶å°†batchæ”¾å…¥pendingSummaryBubbles
                    pendingSummaryBubbles = batch;
                    
                    // è°ƒç”¨ç”Ÿæˆå‡½æ•°
                    await generateMemorySummary(false);
                    
                    successCount++;
                    
                    // çŸ­æš‚å»¶è¿Ÿï¼Œé¿å…APIé™æµ
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                } catch (error) {
                    console.error(`âŒ æ‰¹æ¬¡ ${i + 1} ç”Ÿæˆå¤±è´¥:`, error);
                    failCount++;
                }
            }
            
            // å®Œæˆ
            progressBar.style.width = '100%';
            statusText.textContent = `å®Œæˆï¼æˆåŠŸ: ${successCount}ï¼Œå¤±è´¥: ${failCount}`;
            startBtn.textContent = 'âœ… ç”Ÿæˆå®Œæˆ';
            
            // æ¸…ç©ºå¾…æ€»ç»“ç¼“å†²åŒºï¼ˆå› ä¸ºå·²ç»å…¨éƒ¨å¤„ç†ï¼‰
            pendingSummaryBubbles = [];
            saveChatHistory();
            updateMemoryStatus();
            fillBasicInfoInputs();
            
            // 3ç§’åè‡ªåŠ¨å…³é—­
            setTimeout(() => {
                closeBatchGenerateDialog();
                if (failCount === 0) {
                    showToast('âœ… æ‰¹é‡ç”Ÿæˆå®Œæˆï¼');
                } else {
                    alert(`æ‰¹é‡ç”Ÿæˆå®Œæˆï¼\næˆåŠŸ: ${successCount}\nå¤±è´¥: ${failCount}`);
                }
            }, 3000);
        }
        
        // ========== é•¿æœŸè®°å¿†å¯¼å…¥å¯¼å‡º ==========
        
        /**
         * å¯¼å‡ºé•¿æœŸè®°å¿†
         */
        function exportMemory() {
            if (!longTermMemory.metadata?.last_updated) {
                alert('å½“å‰è¿˜æ²¡æœ‰ç”Ÿæˆé•¿æœŸè®°å¿†ï¼');
                return;
            }
            
            const memoryData = {
                version: '1.0',
                exported_at: new Date().toISOString(),
                memory: longTermMemory
            };
            
            const dataStr = JSON.stringify(memoryData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `long_term_memory_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
            showToast('âœ… è®°å¿†å·²å¯¼å‡º');
        }
        
        /**
         * å¯¼å…¥è®°å¿†æ–‡ä»¶é€‰æ‹©å¤„ç†
         */
        let importedMemoryData = null;
        
        document.getElementById('import-memory-file').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.type !== "application/json") {
                alert('è¯·é€‰æ‹©JSONæ–‡ä»¶ï¼');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // éªŒè¯æ–‡ä»¶æ ¼å¼
                    if (!data.memory || !data.memory.metadata) {
                        alert('æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·é€‰æ‹©æœ‰æ•ˆçš„é•¿æœŸè®°å¿†æ–‡ä»¶ï¼');
                        return;
                    }
                    
                    importedMemoryData = data.memory;
                    showImportMemoryDialog(data.memory);
                    
                } catch (error) {
                    alert('æ–‡ä»¶è§£æå¤±è´¥ï¼š' + error.message);
                }
            };
            
            reader.readAsText(file);
            
            // é‡ç½®æ–‡ä»¶é€‰æ‹©ï¼Œå…è®¸é‡å¤é€‰æ‹©åŒä¸€æ–‡ä»¶
            event.target.value = '';
        });
        
        /**
         * æ˜¾ç¤ºå¯¼å…¥è®°å¿†å¯¹è¯æ¡†
         */
        function showImportMemoryDialog(memory) {
            const dialog = document.getElementById('import-memory-dialog');
            
            // å¡«å……æ–‡ä»¶ä¿¡æ¯
            const basicInfoCount = Object.keys(memory.basic_info || {}).length;
            const eventsCount = (memory.important_events || []).length;
            const lastUpdated = memory.metadata?.last_updated 
                ? new Date(memory.metadata.last_updated).toLocaleString('zh-CN')
                : 'æœªçŸ¥';
            
            document.getElementById('import-basic-info-count').textContent = basicInfoCount;
            document.getElementById('import-events-count').textContent = eventsCount;
            document.getElementById('import-last-updated').textContent = lastUpdated;
            
            // ç›‘å¬å¯¼å…¥æ¨¡å¼å˜åŒ–
            const radios = document.querySelectorAll('input[name="import-mode"]');
            const mergeWarning = document.getElementById('merge-warning');
            
            radios.forEach(radio => {
                radio.onchange = () => {
                    if (radio.value === 'merge') {
                        mergeWarning.style.display = 'block';
                    } else {
                        mergeWarning.style.display = 'none';
                    }
                };
            });
            
            // åˆå§‹çŠ¶æ€
            mergeWarning.style.display = 'none';
            
            dialog.style.display = 'flex';
        }
        
        /**
         * å…³é—­å¯¼å…¥è®°å¿†å¯¹è¯æ¡†
         */
        function closeImportMemoryDialog() {
            const dialog = document.getElementById('import-memory-dialog');
            dialog.style.display = 'none';
            importedMemoryData = null;
        }
        
        /**
         * ç¡®è®¤å¯¼å…¥è®°å¿†
         */
        async function confirmImportMemory() {
            if (!importedMemoryData) {
                alert('æ²¡æœ‰å¯å¯¼å…¥çš„æ•°æ®ï¼');
                return;
            }
            
            const mode = document.querySelector('input[name="import-mode"]:checked').value;
            const confirmBtn = document.getElementById('import-memory-confirm-btn');
            
            if (mode === 'replace') {
                // è¦†ç›–æ¨¡å¼ï¼šç›´æ¥æ›¿æ¢
                if (!confirm('ç¡®å®šè¦ç”¨å¯¼å…¥çš„è®°å¿†è¦†ç›–å½“å‰è®°å¿†å—ï¼Ÿå½“å‰è®°å¿†å°†ä¸¢å¤±ï¼')) {
                    return;
                }
                
                longTermMemory = importedMemoryData;
                saveChatHistory();
                updateMemoryStatus();
                fillBasicInfoInputs();
                
                closeImportMemoryDialog();
                showToast('âœ… è®°å¿†å·²å¯¼å…¥');
                
            } else if (mode === 'merge') {
                // åˆå¹¶æ¨¡å¼ï¼šè°ƒç”¨APIæ™ºèƒ½åˆå¹¶
                if (!config.baseurl || !config.apikey) {
                    alert('è¯·å…ˆé…ç½®APIï¼');
                    return;
                }
                
                confirmBtn.disabled = true;
                confirmBtn.textContent = 'åˆå¹¶ä¸­...';
                
                try {
                    const mergePrompt = `è¯·æ™ºèƒ½åˆå¹¶ä»¥ä¸‹ä¸¤ä»½é•¿æœŸè®°å¿†ï¼Œå»é™¤é‡å¤ä¿¡æ¯ï¼Œä¿ç•™æ‰€æœ‰æœ‰ä»·å€¼çš„å†…å®¹ï¼š

ã€å½“å‰è®°å¿†ã€‘
${JSON.stringify(longTermMemory, null, 2)}

ã€å¯¼å…¥çš„è®°å¿†ã€‘
${JSON.stringify(importedMemoryData, null, 2)}

è¦æ±‚ï¼š
1. basic_info: åˆå¹¶åŸºæœ¬ä¿¡æ¯ï¼Œä¼˜å…ˆä¿ç•™æ›´å®Œæ•´çš„ä¿¡æ¯
2. emotional_profile: åˆå¹¶ä¸¤ä»½æƒ…æ„Ÿå€¾å‘æè¿°ï¼Œå½¢æˆæ›´å…¨é¢çš„æ€»ç»“ï¼ˆ100-300å­—ï¼‰
3. important_events: åˆå¹¶é‡è¦äº‹ä»¶åˆ—è¡¨ï¼Œå»é™¤é‡å¤ï¼ŒæŒ‰é‡è¦åº¦æ’åºï¼Œä¿ç•™æœ€é‡è¦çš„${localStorage.getItem('maxImportantEvents') || 10}æ¡

è¾“å‡ºæ ¼å¼ï¼ˆçº¯JSONï¼Œä¸è¦markdownä»£ç å—ï¼‰ï¼š
{
  "basic_info": {...},
  "emotional_profile": "...",
  "important_events": [...]
}`;

                    const response = await fetch(config.baseurl + '/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${config.apikey}`
                        },
                        body: JSON.stringify({
                            model: config.modelname,
                            messages: [
                                { role: 'system', content: 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è®°å¿†æ•´ç†åŠ©æ‰‹ã€‚' },
                                { role: 'user', content: mergePrompt }
                            ],
                            temperature: 0.3
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.choices && data.choices[0]) {
                        let aiResponse = data.choices[0].message.content.trim();
                        
                        // ç§»é™¤å¯èƒ½çš„markdownä»£ç å—æ ‡è®°
                        aiResponse = aiResponse.replace(/^```json\n?/i, '').replace(/\n?```$/i, '');
                        
                        // è§£æJSON
                        const mergedMemory = JSON.parse(aiResponse);
                        
                        // æ›´æ–°é•¿æœŸè®°å¿†
                        longTermMemory.basic_info = mergedMemory.basic_info || longTermMemory.basic_info;
                        longTermMemory.emotional_profile = mergedMemory.emotional_profile || longTermMemory.emotional_profile;
                        longTermMemory.important_events = mergedMemory.important_events || longTermMemory.important_events;
                        longTermMemory.metadata.last_updated = new Date().toISOString();
                        
                        saveChatHistory();
                        updateMemoryStatus();
                        fillBasicInfoInputs();
                        
                        closeImportMemoryDialog();
                        showToast('âœ… è®°å¿†å·²æ™ºèƒ½åˆå¹¶');
                        
                    } else {
                        throw new Error('APIè¿”å›æ ¼å¼é”™è¯¯');
                    }
                    
                } catch (error) {
                    console.error('âŒ åˆå¹¶å¤±è´¥:', error);
                    alert('åˆå¹¶å¤±è´¥ï¼š' + error.message);
                    confirmBtn.disabled = false;
                    confirmBtn.textContent = 'âœ… ç¡®è®¤å¯¼å…¥';
                }
            }
        }
        
        // ====================================

        /**
         * åœ¨ç•Œé¢ä¸Šæ˜¾ç¤ºä¸€æ¡æ¶ˆæ¯
         * @param {string} text - æ¶ˆæ¯å†…å®¹
         * @param {string} role - æ¶ˆæ¯è§’è‰² ('user' æˆ– 'ai')
         * @param {number} status - æ¶ˆæ¯çŠ¶æ€ (1=å•å‹¾, 2=åŒå‹¾, 0=æ— å‹¾)
         * @param {string} timestamp - å¯é€‰çš„æ—¶é—´æˆ³ï¼Œå¦‚æœä¸æä¾›åˆ™ä½¿ç”¨å½“å‰æ—¶é—´
         * @returns {string} è¿”å›ä½¿ç”¨çš„æ—¶é—´æˆ³
         */
        /**
         * æ˜¾ç¤ºä¸€æ¡æ¶ˆæ¯ï¼ˆæ°”æ³¡ï¼‰
         * @param {string} text - æ¶ˆæ¯å†…å®¹
         * @param {string} role - 'user' æˆ– 'ai' / 'assistant'
         * @param {number} status - å¯¹å‹¾çŠ¶æ€ (0=æ— , 1=å•å‹¾, 2=åŒå‹¾)
         * @param {string} timestamp - æ—¶é—´æˆ³ï¼ˆå¯é€‰ï¼‰
         * @param {boolean} saveToHistory - æ˜¯å¦ä¿å­˜åˆ°chatHistoryï¼ˆé»˜è®¤trueï¼‰
         * @returns {object} è¿”å›åˆ›å»ºçš„æ°”æ³¡å¯¹è±¡
         */
        function displayMessage(text, role, status = 0, timestamp = null, saveToHistory = true, existingId = null, skipScroll = false, quoteInfo = null, targetContainer = null) {
            // ç”Ÿæˆæ—¶é—´æˆ³
            const fullTimestamp = timestamp || new Date().toISOString();
            // ç”Ÿæˆå”¯ä¸€ID
            const bubbleId = existingId || ('bubble_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9));
            
            // å¤„ç†å¼•ç”¨ä¿¡æ¯
            let quotedText = null;
            let quotedSender = null;
            let mainText = text;
            
            // å¦‚æœä¼ å…¥äº†quoteInfoå‚æ•°,ä½¿ç”¨å®ƒ
            if (quoteInfo) {
                quotedSender = quoteInfo.sender;
                quotedText = quoteInfo.content;
                mainText = text;
                
                // ä¸ºäº†ä¿æŒå‘åå…¼å®¹,ä¹Ÿä¿å­˜å¼•ç”¨æ ¼å¼åˆ°æ–‡æœ¬ä¸­(ç”¨äºAPIå’Œå†å²è®°å½•)
                text = `[å¼•ç”¨: "${quotedSender}: ${quotedText.substring(0, 50)}${quotedText.length > 50 ? '...' : ''}"]\n\n${text}`;
            } else {
                // å¦‚æœæ²¡æœ‰quoteInfo,æ£€æµ‹æ–‡æœ¬ä¸­æ˜¯å¦åŒ…å«æ—§æ ¼å¼çš„å¼•ç”¨
                const quoteMatch = text.match(/^\[å¼•ç”¨: "(.+?): (.+?)"\]\n\n([\s\S]+)$/);
                if (quoteMatch) {
                    quotedSender = quoteMatch[1];
                    quotedText = quoteMatch[2];
                    mainText = quoteMatch[3];
                }
            }
            
            // åˆ›å»ºæ°”æ³¡å¯¹è±¡ (ä¿å­˜åŸå§‹å¸¦å¼•ç”¨çš„æ–‡æœ¬)
            const bubble = {
                id: bubbleId,
                role: role,
                content: text, // ä¿å­˜åŸå§‹æ–‡æœ¬
                timestamp: fullTimestamp
            };
            
            // ä¿å­˜åˆ°chatHistory
            if (saveToHistory) {
                chatHistory.push(bubble);
                pendingSummaryBubbles.push(bubble); // åŒæ—¶åŠ å…¥å¾…æ€»ç»“é˜Ÿåˆ—
                saveChatHistory();
            }
            
            // === æ¸²æŸ“UI ===
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', role);
            messageDiv.dataset.bubbleId = bubble.id; // ä¿å­˜æ°”æ³¡ID
            
            // æ·»åŠ å¤´åƒ
            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'message-avatar';
            if (role === 'user') {
                if (config.userAvatar) {
                    const img = document.createElement('img');
                    img.src = config.userAvatar;
                    img.style.width = '100%';
                    img.style.height = '100%';
                    img.style.objectFit = 'cover';
                    img.style.borderRadius = '6px';
                    avatarDiv.appendChild(img);
                } else {
                    const defaultDiv = document.createElement('div');
                    defaultDiv.className = 'default-avatar user';
                    defaultDiv.textContent = config.userNickname.substring(0, 1);
                    avatarDiv.appendChild(defaultDiv);
                }
            } else {
                if (config.aiAvatar) {
                    const img = document.createElement('img');
                    img.src = config.aiAvatar;
                    img.style.width = '100%';
                    img.style.height = '100%';
                    img.style.objectFit = 'cover';
                    img.style.borderRadius = '6px';
                    avatarDiv.appendChild(img);
                } else {
                    const defaultDiv = document.createElement('div');
                    defaultDiv.className = 'default-avatar ai';
                    defaultDiv.textContent = config.aiNickname.substring(0, 1);
                    avatarDiv.appendChild(defaultDiv);
                }
            }

            // åˆ›å»ºå†…å®¹å®¹å™¨(åŒ…å«å¼•ç”¨å’Œæ°”æ³¡)
            const contentWrapper = document.createElement('div');
            contentWrapper.className = 'message-content-wrapper';
            
            const bubbleDiv = document.createElement('div');
            bubbleDiv.classList.add('bubble');
            
            // æ·»åŠ ä¸»è¦æ–‡æœ¬(ä¸åŒ…å«å¼•ç”¨)
            const mainTextNode = document.createTextNode(mainText);
            bubbleDiv.appendChild(mainTextNode);
            
            const metaDiv = document.createElement('div');
            metaDiv.classList.add('message-meta');
            
            // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
            const time = new Date(fullTimestamp);
            const timeStr = time.getHours().toString().padStart(2, '0') + ':' + 
                         time.getMinutes().toString().padStart(2, '0');
            
            const timeSpan = document.createElement('span');
            timeSpan.textContent = timeStr;
            metaDiv.appendChild(timeSpan);
            
            // ç”¨æˆ·æ¶ˆæ¯æ˜¾ç¤ºå¯¹å‹¾
            if (role === 'user') {
                const checkmark = document.createElement('span');
                checkmark.classList.add('checkmark');
                if (status === 2) {
                    checkmark.classList.add('double');
                    checkmark.textContent = 'âœ“âœ“';
                } else if (status === 1) {
                    checkmark.textContent = 'âœ“';
                }
                metaDiv.appendChild(checkmark);
                messageDiv.dataset.status = status;
            }
            
            bubbleDiv.appendChild(metaDiv);
            contentWrapper.appendChild(bubbleDiv);
            
            // ã€ä¿®æ”¹ã€‘å¦‚æœæœ‰å¼•ç”¨ï¼Œæ·»åŠ åˆ°contentWrapperï¼ˆæ°”æ³¡å¤–ä¸‹æ–¹ï¼‰
            if (quotedText && quotedSender) {
                const quotedDiv = document.createElement('div');
                quotedDiv.classList.add('quoted-message');
                
                const senderSpan = document.createElement('span');
                senderSpan.classList.add('quote-sender');
                senderSpan.textContent = quotedSender + 'ï¼š';
                
                quotedDiv.appendChild(senderSpan);
                quotedDiv.appendChild(document.createTextNode(quotedText));
                
                contentWrapper.appendChild(quotedDiv); // æ·»åŠ åˆ°contentWrapperï¼Œåœ¨bubbleDivå¤–
            }
            
            messageDiv.appendChild(avatarDiv);
            messageDiv.appendChild(contentWrapper);
            
            // ä½¿ç”¨ä¼ å…¥çš„å®¹å™¨æˆ–é»˜è®¤çš„chatContainer
            const container = targetContainer || chatContainer;
            container.appendChild(messageDiv);
            
            // æ·»åŠ é•¿æŒ‰èœå•
            setupLongPressMenu(bubbleDiv, bubble);
            
            // é™¤éskipScroll=trueï¼Œå¦åˆ™æ¯æ¡æ¶ˆæ¯éƒ½æ»šåŠ¨ï¼ˆè¿™æ ·AIæ¶ˆæ¯è·³å‡ºæ¥æ—¶èƒ½çœ‹åˆ°ï¼‰
            if (!skipScroll && !targetContainer) { // å¦‚æœæ˜¯ä¸´æ—¶å®¹å™¨ï¼Œä¸æ»šåŠ¨
                scrollToBottom();
            }
            
            return bubble;
        }
        
        /**
         * æ›´æ–°æœ€åä¸€æ¡ç”¨æˆ·æ¶ˆæ¯çš„å¯¹å‹¾çŠ¶æ€
         * @param {number} status - 1=å•å‹¾, 2=åŒå‹¾
         */
        function updateLastMessageStatus(status) {
            const userMessages = chatContainer.querySelectorAll('.message.user');
            if (userMessages.length === 0) return;
            
            const lastMessage = userMessages[userMessages.length - 1];
            const checkmark = lastMessage.querySelector('.checkmark');
            
            if (checkmark) {
                if (status === 2) {
                    checkmark.classList.add('double');
                    checkmark.textContent = 'âœ“âœ“';
                } else if (status === 1) {
                    checkmark.textContent = 'âœ“';
                }
                lastMessage.dataset.status = status;
            }
        }
        
        /**
         * æ˜¾ç¤º"å¯¹æ–¹æ­£åœ¨è¾“å…¥ä¸­..."
         */
        function showTypingIndicator() {
            const chatNameElement = document.getElementById('chat-name');
            if (chatNameElement) {
                chatNameElement.dataset.originalName = chatNameElement.textContent;
                chatNameElement.innerHTML = '<span class="typing-indicator">å¯¹æ–¹æ­£åœ¨è¾“å…¥ä¸­...</span>';
            }
        }
        
        /**
         * éšè—"å¯¹æ–¹æ­£åœ¨è¾“å…¥ä¸­..."ï¼Œæ¢å¤èŠå¤©å¯¹è±¡åç§°
         */
        function hideTypingIndicator() {
            const chatNameElement = document.getElementById('chat-name');
            if (chatNameElement && chatNameElement.dataset.originalName) {
                chatNameElement.textContent = chatNameElement.dataset.originalName;
            }
        }
        /**
         * æ¸…ç† API å“åº”æ–‡æœ¬ï¼Œå»é™¤æ—¶é—´æˆ³ç­‰å¤šä½™ä¿¡æ¯
         * @param {string} text - åŸå§‹æ–‡æœ¬
         * @returns {string} æ¸…ç†åçš„æ–‡æœ¬
         */
        function cleanApiResponse(text) {
            if (!text) return "";
            
            // ç§»é™¤å¼€å¤´çš„æ—¶é—´æˆ³ï¼š[2024/12/20 21:39] æˆ– [2024/12/20 21:39 æ˜ŸæœŸäº”]
            // åŒ¹é…æ ¼å¼ï¼š[å¹´/æœˆ/æ—¥ æ—¶:åˆ†] æˆ– [å¹´/æœˆ/æ—¥ æ—¶:åˆ† æ˜ŸæœŸX]
            const timestampRegex = /^\s*\[\d{4}\/\d{2}\/\d{2}\s+\d{2}:\d{2}(?:\s+æ˜ŸæœŸ[ä¸€äºŒä¸‰å››äº”å…­æ—¥])?\]\s*/;
            
            // ç§»é™¤æ—¶é—´æˆ³
            let cleaned = text.replace(timestampRegex, '');
            
            // å¦‚æœè¿˜æœ‰å¤šä½™çš„ç©ºç™½ï¼Œå†æ¸…ç†ä¸€æ¬¡
            cleaned = cleaned.trim();
            
            //console.log('ğŸ§¹ æ¸…ç†å‰:', text.substring(0, 50));
            //console.log('ğŸ§¹ æ¸…ç†å:', cleaned.substring(0, 50));
            
            return cleaned;
        }
        /**
         * å¤„ç† AI çš„å®Œæ•´å“åº”ï¼Œå¹¶æ ¹æ® '\n\n' é€æ¡æ˜¾ç¤ºæ¶ˆæ¯ã€‚
         * åŒæ—¶å°†å®Œæ•´çš„AIå›å¤è®¡å…¥ chatHistoryã€‚
         * @param {string} fullAiText - ä» AI API æ¥æ”¶åˆ°çš„å®Œæ•´æ–‡æœ¬ã€‚
         */
        function processAndDisplaySegments(fullAiText) {
            // 1. å®šä¹‰æ¶ˆæ¯åˆ†éš”ç¬¦å’Œé—´éš”æ—¶é—´
            const separator = '\n\n';
            const delay = 500; // æ¯æ¡æ¶ˆæ¯ä¹‹é—´çš„é—´éš”ï¼Œå•ä½ï¼šæ¯«ç§’ (0.5 ç§’)
            
            // ç”ŸæˆAIæ¶ˆæ¯çš„æ—¶é—´æˆ³ï¼ˆæ‰€æœ‰åˆ†æ®µä½¿ç”¨åŒä¸€ä¸ªæ—¶é—´ï¼‰
            const aiTimestamp = new Date().toISOString();

            // 2. æ ¹æ® '\n\n' åˆ†å‰²å®Œæ•´çš„å“åº”æ–‡æœ¬
            const messageSegments = fullAiText.split(separator).filter(seg => seg.trim());

            // 3. ã€å…³é”®ä¿®æ”¹ã€‘å…ˆåŒæ­¥å°†æ‰€æœ‰åˆ†æ®µåŠ å…¥chatHistory
            const bubbles = []; // ä¿å­˜æ‰€æœ‰æ°”æ³¡å¯¹è±¡ï¼Œç”¨äºåç»­UIæ˜¾ç¤º
            messageSegments.forEach((segment, index) => {
                // æ¸…ç†å¯èƒ½çš„æ—¶é—´æˆ³
                let cleanSegment = cleanApiResponse(segment);
                cleanSegment = cleanSegment.trim();

                if (cleanSegment.length > 0) {
                    // ç«‹å³åŠ å…¥chatHistoryï¼Œä½†è·³è¿‡UIæ¸²æŸ“ï¼ˆsaveToHistory=true, skipScroll=trueï¼‰
                    // å¹¶ä¸”ä¸ç«‹å³æ¸²æŸ“åˆ°é¡µé¢ï¼ˆæˆ‘ä»¬ç¨åå¼‚æ­¥æ¸²æŸ“ï¼‰
                    const bubble = {
                        content: cleanSegment,
                        timestamp: aiTimestamp,
                        index: index
                    };
                    bubbles.push(bubble);
                    
                    // åªåŠ å…¥chatHistoryï¼Œä¸æ¸²æŸ“UI
                    chatHistory.push({
                        id: 'bubble_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        role: 'assistant',
                        content: cleanSegment,
                        timestamp: aiTimestamp
                    });
                    pendingSummaryBubbles.push(chatHistory[chatHistory.length - 1]);
                }
            });
            
            // ä¿å­˜åˆ°localStorage
            saveChatHistory();
            
            console.log('âœ… æ‰€æœ‰AIåˆ†æ®µå·²åŠ å…¥chatHistoryï¼Œå…±', bubbles.length, 'æ¡');

            // 4. ã€å…³é”®ä¿®æ”¹ã€‘chatHistoryå·²å®Œæ•´ï¼Œç«‹å³é‡ç½®çŠ¶æ€å¹¶å¤„ç†ä¸‹ä¸€æ‰¹
            isWaitingForAI = false;
            
            // æ£€æŸ¥æ˜¯å¦éœ€è¦è‡ªåŠ¨ç”Ÿæˆè®°å¿†
            checkAutoSummary();
            
            // ç«‹å³æ£€æŸ¥æ˜¯å¦æœ‰å¾…å‘é€çš„æ¶ˆæ¯
            if (pendingUserMessages.length > 0) {
                if (hasReachedWaitTime) {
                    // é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯å·²ç»ç­‰å¤Ÿ7ç§’ â†’ ç«‹å³å‘é€
                    console.log('ğŸ“¬ å‘ç°å¾…å‘é€æ¶ˆæ¯', pendingUserMessages.length, 'æ¡ï¼Œä¸”å·²åˆ°æ—¶é—´ï¼Œç«‹å³å‘é€');
                    hasReachedWaitTime = false;
                    sendBatchMessages();
                } else {
                    // é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯è¿˜æœªåˆ°7ç§’ â†’ ç»§ç»­è®¡æ—¶
                    console.log('ğŸ“¬ å‘ç°å¾…å‘é€æ¶ˆæ¯', pendingUserMessages.length, 'æ¡ï¼Œä½†æœªåˆ°æ—¶é—´ï¼Œç»§ç»­è®¡æ—¶');
                    startBatchTimer();
                }
            } else {
                hasReachedWaitTime = false;
            }

            // 5. ã€UIæ˜¾ç¤ºã€‘å¼‚æ­¥é€æ¡æ˜¾ç¤ºæ¶ˆæ¯ï¼ˆçº¯è§†è§‰æ•ˆæœï¼Œä¸å½±å“é€»è¾‘ï¼‰
            bubbles.forEach((bubble, index) => {
                setTimeout(() => {
                    // åˆ›å»ºå¹¶æ˜¾ç¤ºæ¶ˆæ¯UIï¼ˆä¸å†ä¿®æ”¹chatHistoryï¼‰
                    displayMessageUI(bubble.content, 'assistant', aiTimestamp);
                    
                    // è§¦å‘æ¶ˆæ¯é€šçŸ¥ï¼ˆåªåœ¨ç¬¬ä¸€æ¡æ¶ˆæ¯æ—¶è§¦å‘ï¼Œä¸”ä¸åœ¨èŠå¤©é¡µé¢æ—¶ï¼‰
                    if (index === 0) {
                        const currentPage = document.querySelector('.page.active');
                        if (currentPage && currentPage.id !== 'chat-page') {
                            const characterName = config.aiNickname || 'AI èŠå¤©å¯¹è±¡';
                            const avatarData = config.aiAvatar || null;
                            showMessageNotification(currentCharacterId, characterName, bubble.content, avatarData);
                        }
                    }
                }, index * delay);
            });
        }
        
        /**
         * ä»…æ˜¾ç¤ºæ¶ˆæ¯UIï¼Œä¸ä¿®æ”¹chatHistory
         * ç”¨äºåˆ†æ®µæ˜¾ç¤ºAIæ¶ˆæ¯æ—¶çš„è§†è§‰æ•ˆæœ
         */
        function displayMessageUI(text, role, timestamp) {
            const fullTimestamp = timestamp || new Date().toISOString();
            
            // æŸ¥æ‰¾å¯¹åº”çš„bubbleï¼ˆä»chatHistoryä¸­æ‰¾åˆ°åŒ¹é…çš„ï¼‰
            const bubble = chatHistory.find(b => 
                b.content === text && 
                b.role === role && 
                b.timestamp === fullTimestamp &&
                !document.querySelector(`[data-bubble-id="${b.id}"]`) // è¿˜æ²¡æ¸²æŸ“è¿‡
            );
            
            if (!bubble) {
                console.error('âŒ æ‰¾ä¸åˆ°å¯¹åº”çš„bubble');
                return;
            }
            
            // æ¸²æŸ“UIï¼ˆå¤ç”¨displayMessageçš„UIæ¸²æŸ“é€»è¾‘ï¼Œä½†ä¸ä¿å­˜åˆ°chatHistoryï¼‰
            displayMessage(text, role, 0, timestamp, false, bubble.id, false);
        }
        
        // ========== æ‰¹é‡å‘é€åŠŸèƒ½ ==========
        /**
         * å¼€å§‹æ‰¹é‡å‘é€è®¡æ—¶å™¨
         */
        function startBatchTimer() {
            // æ¸…é™¤ä¹‹å‰çš„è®¡æ—¶å™¨
            if (batchSendTimer) {
                clearTimeout(batchSendTimer);
            }
            
            // é‡ç½®"å·²åˆ°æ—¶é—´"æ ‡è®°
            hasReachedWaitTime = false;
            
            // è·å–ç­‰å¾…æ—¶é—´ï¼ˆç§’ï¼‰
            const waitTime = parseInt(localStorage.getItem('batchWaitTime')) || 7;
            
            console.log('â° å¯åŠ¨è®¡æ—¶å™¨ï¼Œç­‰å¾…', waitTime, 'ç§’...');
            
            // å¯åŠ¨æ–°è®¡æ—¶å™¨
            batchSendTimer = setTimeout(() => {
                console.log('â° è®¡æ—¶å™¨åˆ°æœŸ');
                sendBatchMessages();
            }, waitTime * 1000);
        }
        
        /**
         * å–æ¶ˆæ‰¹é‡å‘é€è®¡æ—¶å™¨
         */
        function cancelBatchTimer() {
            if (batchSendTimer) {
                clearTimeout(batchSendTimer);
                batchSendTimer = null;
                console.log('â° è®¡æ—¶å™¨å·²å–æ¶ˆ');
            }
        }
        
        /**
         * å‘é€æ‰¹é‡æ¶ˆæ¯ï¼ˆè®¡æ—¶å™¨åˆ°æœŸæ—¶è°ƒç”¨ï¼‰
         */
        async function sendBatchMessages() {
            // æ ‡è®°å·²åˆ°è¾¾ç­‰å¾…æ—¶é—´
            hasReachedWaitTime = true;
            
            if (pendingUserMessages.length === 0) {
                console.log('ğŸ“­ æ²¡æœ‰å¾…å‘é€çš„æ¶ˆæ¯');
                hasReachedWaitTime = false;
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦æ­£åœ¨ç­‰å¾…AIå›å¤
            if (isWaitingForAI) {
                console.log('â³ å·²åˆ°7ç§’ä½†æ­£åœ¨ç­‰å¾…AIå›å¤ï¼Œä¿æŒhasReachedWaitTime=true');
                // ä¸é‡å¯è®¡æ—¶å™¨ï¼Œä¿æŒhasReachedWaitTime=true
                // ç­‰AIå›å¤å®Œæˆåä¼šæ£€æŸ¥è¿™ä¸ªæ ‡è®°
                return;
            }
            
            // ä¸¤ä¸ªæ¡ä»¶éƒ½æ»¡è¶³ï¼šå·²åˆ°æ—¶é—´ AND ä¸åœ¨ç­‰å¾…AI
            console.log('ğŸ“¤ å‘é€æ‰¹é‡æ¶ˆæ¯ï¼Œå…±', pendingUserMessages.length, 'æ¡');
            
            // é‡ç½®æ ‡è®°
            hasReachedWaitTime = false;
            
            // æ ‡è®°æ­£åœ¨ç­‰å¾…AI
            isWaitingForAI = true;
            
            // å°†æ‰€æœ‰å¾…å‘é€æ¶ˆæ¯çš„çŠ¶æ€æ›´æ–°ä¸ºåŒå‹¾
            pendingUserMessages.forEach(bubbleId => {
                const messageDiv = chatContainer.querySelector(`[data-bubble-id="${bubbleId}"]`);
                if (messageDiv) {
                    const checkmark = messageDiv.querySelector('.checkmark');
                    if (checkmark) {
                        checkmark.classList.add('double');
                        checkmark.textContent = 'âœ“âœ“';
                    }
                    messageDiv.dataset.status = '2';
                }
            });
            
            // æ˜¾ç¤º"å¯¹æ–¹æ­£åœ¨è¾“å…¥ä¸­..."
            showTypingIndicator();
            
            // ã€å…³é”®ä¿®å¤ã€‘ä¿å­˜å¾…å‘é€é˜Ÿåˆ—çš„å‰¯æœ¬ï¼Œç”¨äºAPIè°ƒç”¨æ—¶è¯†åˆ«ç­‰å¾…æœŸé—´çš„æ¶ˆæ¯
            const currentBatchIds = [...pendingUserMessages];
            
            // æ¸…ç©ºå¾…å‘é€é˜Ÿåˆ—
            pendingUserMessages = [];
            
            // è°ƒç”¨APIï¼Œä¼ å…¥å½“å‰æ‰¹æ¬¡çš„æ¶ˆæ¯ID
            await callAPIToGenerate(currentBatchIds);
        }
        
        /**
         * æ™ºèƒ½æå–ç›¸å…³è®°å¿†
         * @param {Array} memories - æ‰€æœ‰è®°å¿†
         * @param {string} userMessage - ç”¨æˆ·æ¶ˆæ¯
         * @param {Array} recentBubbles - æœ€è¿‘çš„å¯¹è¯æ°”æ³¡
         * @returns {Array} ç›¸å…³è®°å¿†åˆ—è¡¨ï¼ˆ1-5æ¡ï¼‰
         */
        function extractRelevantMemories(memories, userMessage, recentBubbles) {
            if (!memories || memories.length === 0) return [];
            
            console.log('ğŸ§  å¼€å§‹æ™ºèƒ½è®°å¿†æå–');
            console.log('ğŸ“Š æ€»è®°å¿†æ•°:', memories.length);
            console.log('ğŸ’¬ ç”¨æˆ·æ¶ˆæ¯:', userMessage.substring(0, 50));
            
            const result = [];
            const now = Date.now();
            
            // æ£€æµ‹ç”¨æˆ·æƒ…ç»ªï¼ˆæ˜¯å¦åœ¨æŠ±æ€¨è®°å¿†ä¸å‡†ç¡®ï¼‰
            const isComplaining = /æˆ‘éƒ½è¯´äº†|ä½ è®°ä¸å¾—|å¿˜äº†å—|ä¸è®°å¾—|åˆšæ‰è¯´è¿‡/.test(userMessage);
            const hasEmphasis = /ï¼|!/.test(userMessage);
            const isEmotional = isComplaining || hasEmphasis;
            
            if (isEmotional) {
                console.log('ğŸ˜¤ æ£€æµ‹åˆ°æƒ…ç»ªå¼ºåº¦ï¼Œæ‰©å¤§æœç´¢èŒƒå›´');
            }
            
            // è§£æç”¨æˆ·æåˆ°çš„æ—¶é—´
            const timeRange = parseTimeReference(userMessage, now);
            if (timeRange) {
                console.log('ğŸ“… æ£€æµ‹åˆ°æ—¶é—´å¼•ç”¨:', timeRange.description);
            }
            
            // ===== ç¬¬ä¸€å±‚ï¼šæ—¶é—´ç­›é€‰ =====
            let candidates = [];
            
            if (timeRange && !isEmotional) {
                // ç”¨æˆ·æ˜ç¡®æåˆ°æ—¶é—´ï¼Œç­›é€‰è¯¥æ—¶é—´æ®µçš„è®°å¿†
                candidates = memories.filter(m => {
                    const created = new Date(m.created_at).getTime();
                    const lastMentioned = new Date(m.last_mentioned).getTime();
                    // åˆ›å»ºæ—¶é—´æˆ–æœ€åæåŠæ—¶é—´åœ¨èŒƒå›´å†…
                    return (created >= timeRange.start && created <= timeRange.end) ||
                           (lastMentioned >= timeRange.start && lastMentioned <= timeRange.end);
                });
                console.log(`ğŸ“… æ—¶é—´æ®µç­›é€‰: ${candidates.length}æ¡è®°å¿†`);
            } else if (isEmotional && timeRange) {
                // æƒ…ç»ªå¼ºï¼Œæ‰©å¤§æ—¶é—´èŒƒå›´ï¼ˆå‰åå„å»¶é•¿50%ï¼‰
                const duration = timeRange.end - timeRange.start;
                const expandedStart = timeRange.start - duration * 0.5;
                const expandedEnd = timeRange.end + duration * 0.5;
                
                candidates = memories.filter(m => {
                    const created = new Date(m.created_at).getTime();
                    const lastMentioned = new Date(m.last_mentioned).getTime();
                    return (created >= expandedStart && created <= expandedEnd) ||
                           (lastMentioned >= expandedStart && lastMentioned <= expandedEnd);
                });
                console.log(`ğŸ˜¤ æƒ…ç»ªæ¨¡å¼ï¼šæ‰©å¤§æ—¶é—´èŒƒå›´ï¼Œç­›é€‰åˆ° ${candidates.length}æ¡`);
            } else {
                // æ²¡æœ‰æ—¶é—´å¼•ç”¨ï¼ŒæŒ‰æœ€è¿‘æ—¶é—´ç­›é€‰
                const threeDaysAgo = now - 3 * 24 * 60 * 60 * 1000;
                const sevenDaysAgo = now - 7 * 24 * 60 * 60 * 1000;
                
                // æœ€è¿‘3å¤©å¿…é€‰
                const veryRecent = memories.filter(m => 
                    new Date(m.last_mentioned).getTime() >= threeDaysAgo
                );
                candidates.push(...veryRecent);
                console.log(`â° æœ€è¿‘3å¤©: ${veryRecent.length}æ¡`);
                
                // å¦‚æœä¸å¤Ÿ5æ¡ï¼ŒåŠ å…¥3-7å¤©çš„
                if (candidates.length < 5) {
                    const recent = memories.filter(m => {
                        const time = new Date(m.last_mentioned).getTime();
                        return time >= sevenDaysAgo && time < threeDaysAgo;
                    });
                    candidates.push(...recent);
                    console.log(`â° 3-7å¤©: ${recent.length}æ¡`);
                }
            }
            
            // ===== ç¬¬äºŒå±‚ï¼šå†…å®¹åŒ¹é… =====
            // æå–å…³é”®è¯
            const keywords = extractKeywords(userMessage, recentBubbles);
            console.log(`ğŸ” æå–å…³é”®è¯: ${keywords.join(', ')}`);
            
            if (keywords.length > 0) {
                // å¯¹å€™é€‰è®°å¿†è¿›è¡Œå†…å®¹åŒ¹é…è¯„åˆ†
                const scored = candidates.map(m => {
                    let matchScore = 0;
                    const titleLower = m.title.toLowerCase();
                    const contentLower = m.content.toLowerCase();
                    
                    keywords.forEach(kw => {
                        const kwLower = kw.toLowerCase();
                        // titleåŒ¹é… â†’ å¿…é€‰
                        if (titleLower.includes(kwLower)) {
                            matchScore += 100;  // æé«˜åˆ†ï¼Œä¿è¯è¢«é€‰ä¸­
                        }
                        // contentåŒ¹é…
                        if (contentLower.includes(kwLower)) {
                            matchScore += 1;
                        }
                    });
                    
                    return { memory: m, matchScore };
                });
                
                // åˆ†ç¦»ï¼štitleå‘½ä¸­çš„ï¼ˆå¿…é€‰ï¼‰å’Œ contentå‘½ä¸­çš„
                const titleMatched = scored.filter(x => x.matchScore >= 100);
                const contentMatched = scored.filter(x => x.matchScore > 0 && x.matchScore < 100);
                
                console.log(`âœ… TitleåŒ¹é…ï¼ˆå¿…é€‰ï¼‰: ${titleMatched.length}æ¡`);
                console.log(`ğŸ“ ContentåŒ¹é…: ${contentMatched.length}æ¡`);
                
                // å…ˆåŠ å…¥titleåŒ¹é…çš„
                result.push(...titleMatched.map(x => x.memory));
                
                // å†åŠ å…¥contentåŒ¹é…åº¦é«˜çš„ï¼ˆæŒ‰åˆ†æ•°æ’åºï¼‰
                contentMatched.sort((a, b) => b.matchScore - a.matchScore);
                
                // è¡¥å……åˆ°3-5æ¡ï¼ˆä½†ä¸è¶…è¿‡5æ¡ï¼‰
                const remaining = Math.min(5 - result.length, contentMatched.length);
                if (remaining > 0) {
                    result.push(...contentMatched.slice(0, remaining).map(x => x.memory));
                }
                
                // å¦‚æœåœ¨éæ—¶é—´ç­›é€‰æ¨¡å¼ä¸‹ï¼Œè¿˜è¦æœç´¢æ‰€æœ‰è®°å¿†çš„content
                if (!timeRange && result.length < 3) {
                    console.log('ğŸ” å€™é€‰ä¸è¶³ï¼Œæœç´¢å…¨éƒ¨è®°å¿†...');
                    const allMemoriesMatched = memories
                        .filter(m => !result.find(r => r.memory_id === m.memory_id))  // æ’é™¤å·²é€‰
                        .map(m => {
                            let score = 0;
                            const titleLower = m.title.toLowerCase();
                            const contentLower = m.content.toLowerCase();
                            
                            keywords.forEach(kw => {
                                const kwLower = kw.toLowerCase();
                                if (titleLower.includes(kwLower)) score += 100;
                                if (contentLower.includes(kwLower)) score += 1;
                            });
                            
                            return { memory: m, score };
                        })
                        .filter(x => x.score > 0)
                        .sort((a, b) => b.score - a.score);
                    
                    const toAdd = Math.min(3 - result.length, allMemoriesMatched.length);
                    if (toAdd > 0) {
                        result.push(...allMemoriesMatched.slice(0, toAdd).map(x => x.memory));
                        console.log(`ğŸ“š å…¨åº“æœç´¢ï¼š+${toAdd}æ¡`);
                    }
                }
            }
            
            // ===== ç¬¬ä¸‰å±‚ï¼šé²æ£’æ€§å…œåº• =====
            // ä¿®å¤3: å¦‚æœå®Œå…¨æ²¡æœ‰åŒ¹é…åˆ°ï¼Œè¿”å›æ‰€æœ‰è®°å¿†ï¼ˆæŒ‰æ—¶é—´æ’åºï¼‰
            if (result.length === 0) {
                console.log('âš ï¸ å…³é”®è¯æ— åŒ¹é…ï¼Œè¿”å›å…¨éƒ¨è®°å¿†ï¼ˆæŒ‰æ—¶é—´æ’åºï¼‰');
                const allByTime = [...memories].sort((a, b) => 
                    new Date(b.last_mentioned) - new Date(a.last_mentioned)
                );
                result.push(...allByTime);
            }
            
            // å»é‡å¹¶æŒ‰æ—¶é—´æ’åº
            const unique = [...new Map(result.map(m => [m.memory_id, m])).values()];
            unique.sort((a, b) => new Date(b.last_mentioned) - new Date(a.last_mentioned));
            
            // å¦‚æœæ˜¯å…œåº•æƒ…å†µï¼ˆè¿”å›äº†å…¨éƒ¨è®°å¿†ï¼‰ï¼Œä¸é™åˆ¶æ•°é‡ï¼›å¦åˆ™æœ€å¤š5æ¡
            const maxReturn = result.length === memories.length ? memories.length : 5;
            const final = unique.slice(0, maxReturn);
            
            console.log(`âœ… æœ€ç»ˆè¿”å› ${final.length} æ¡è®°å¿†:`);
            final.forEach((m, i) => {
                console.log(`   ${i + 1}. ${m.title}`);
            });
            
            return final;
        }
        
        /**
         * è§£ææ—¶é—´å¼•ç”¨
         */
        function parseTimeReference(text, now) {
            const today = new Date(now);
            today.setHours(0, 0, 0, 0);
            
            // æ˜¨å¤©
            if (/æ˜¨å¤©|æ˜¨æ—¥/.test(text)) {
                const start = new Date(today);
                start.setDate(start.getDate() - 1);
                const end = new Date(start);
                end.setHours(23, 59, 59, 999);
                return { start: start.getTime(), end: end.getTime(), description: 'æ˜¨å¤©' };
            }
            
            // å‰å¤©
            if (/å‰å¤©/.test(text)) {
                const start = new Date(today);
                start.setDate(start.getDate() - 2);
                const end = new Date(start);
                end.setHours(23, 59, 59, 999);
                return { start: start.getTime(), end: end.getTime(), description: 'å‰å¤©' };
            }
            
            // ä¸Šå‘¨/ä¸Šæ˜ŸæœŸ
            if (/ä¸Šå‘¨|ä¸Šæ˜ŸæœŸ|ä¸Šç¤¼æ‹œ/.test(text)) {
                const start = new Date(today);
                start.setDate(start.getDate() - 14);  // 2å‘¨å‰
                const end = new Date(today);
                end.setDate(end.getDate() - 7);  // 1å‘¨å‰
                return { start: start.getTime(), end: end.getTime(), description: 'ä¸Šå‘¨' };
            }
            
            // ä¸Šä¸ªæœˆ
            if (/ä¸Šä¸ªæœˆ|ä¸Šæœˆ/.test(text)) {
                const start = new Date(today);
                start.setMonth(start.getMonth() - 1);
                start.setDate(1);
                const end = new Date(start);
                end.setMonth(end.getMonth() + 1);
                end.setDate(0);
                end.setHours(23, 59, 59, 999);
                return { start: start.getTime(), end: end.getTime(), description: 'ä¸Šä¸ªæœˆ' };
            }
            
            // ä»Šå¹´Xæœˆ
            const monthMatch = text.match(/ä»Šå¹´\s*([0-9ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+)\s*æœˆ/);
            if (monthMatch) {
                const monthNum = parseChineseNumber(monthMatch[1]);
                if (monthNum >= 1 && monthNum <= 12) {
                    const start = new Date(today.getFullYear(), monthNum - 1, 1);
                    const end = new Date(today.getFullYear(), monthNum, 0, 23, 59, 59, 999);
                    return { start: start.getTime(), end: end.getTime(), description: `ä»Šå¹´${monthNum}æœˆ` };
                }
            }
            
            // å…·ä½“æ—¥æœŸ XX/XX æˆ– XXæœˆXXæ—¥
            const dateMatch = text.match(/(\d{1,2})[\/æœˆ](\d{1,2})/);
            if (dateMatch) {
                const month = parseInt(dateMatch[1]);
                const day = parseInt(dateMatch[2]);
                if (month >= 1 && month <= 12 && day >= 1 && day <= 31) {
                    const year = today.getFullYear();
                    const start = new Date(year, month - 1, day, 0, 0, 0, 0);
                    const end = new Date(year, month - 1, day, 23, 59, 59, 999);
                    return { start: start.getTime(), end: end.getTime(), description: `${month}æœˆ${day}æ—¥` };
                }
            }
            
            return null;
        }
        
        /**
         * è§£æä¸­æ–‡æ•°å­—
         */
        function parseChineseNumber(str) {
            const map = {
                'ä¸€': 1, 'äºŒ': 2, 'ä¸‰': 3, 'å››': 4, 'äº”': 5,
                'å…­': 6, 'ä¸ƒ': 7, 'å…«': 8, 'ä¹': 9, 'å': 10,
                'åä¸€': 11, 'åäºŒ': 12
            };
            return map[str] || parseInt(str) || 0;
        }
        
        /**
         * æå–å…³é”®è¯ï¼ˆç»¼åˆç‰ˆ - å¤šç­–ç•¥èåˆï¼‰
         */
        function extractKeywords(userMessage, recentBubbles) {
            // ä¿®å¤1: ä½¿ç”¨æœ€è¿‘5æ¡ç”¨æˆ·æ¶ˆæ¯ï¼ˆè€Œä¸æ˜¯3æ¡ï¼‰
            const recentUserMsgs = recentBubbles
                .filter(b => b.role === 'user')
                .slice(-5)  // æ”¹ä¸º5æ¡
                .map(b => b.content)
                .join(' ');
            
            const text = userMessage + ' ' + recentUserMsgs;
            const keywords = [];
            
            console.log('ğŸ“ æå–å…³é”®è¯çš„æ–‡æœ¬é•¿åº¦:', text.length, 'å­—');
            
            // === ç­–ç•¥1ï¼šåè¯åç¼€æ¨¡å¼ ===
            const nounPattern = /([\u4e00-\u9fa5]{1,3}[å­å„¿è€…äººå¸ˆç”Ÿå‘˜é•¿å®¶æ‰‹ç‰©å“æ–™çº¸ä¹¦ç¬”æœºå™¨è™«]+)/g;
            const nouns = text.match(nounPattern) || [];
            keywords.push(...nouns);
            
            // === ç­–ç•¥2ï¼šä¸“æœ‰åè¯ï¼ˆè‹±æ–‡ï¼‰ ===
            const properNouns = text.match(/[A-Z][a-zA-Z]+/g) || [];
            keywords.push(...properNouns);
            
            // === ç­–ç•¥3ï¼šç®€å•åˆ†è¯ï¼ˆæŒ‰æ ‡ç‚¹å’Œç©ºæ ¼ï¼‰ ===
            const segments = text.split(/[\sï¼Œã€‚ï¼ï¼Ÿã€ï¼›ï¼š""''ï¼ˆï¼‰ã€ã€‘ã€Šã€‹]+/);
            segments.forEach(seg => {
                if (seg.length >= 2 && seg.length <= 6) {
                    // æ’é™¤çº¯æ—¶é—´è¯å’Œè™šè¯
                    if (/^(ä»Šå¤©|æ˜å¤©|æ˜¨å¤©|ä»Šæ™š|ç°åœ¨|åˆšæ‰|ä¹‹å|ä»¥å‰|ä¸Šæ¬¡|ä¸‹æ¬¡|æœ€è¿‘|ä¸€ç›´|æ²¡æœ‰|å¯ä»¥|åº”è¯¥|è¿™ä¸ª|é‚£ä¸ª|ä»€ä¹ˆ|æ€ä¹ˆ)$/.test(seg)) {
                        return;
                    }
                    keywords.push(seg);
                }
            });
            
            // === ç­–ç•¥4ï¼šé«˜ä»·å€¼å•å­—ï¼ˆåè¯æ€§ï¼‰ ===
            const valuableChars = text.match(/[ä¿¡çº¸ä¹¦ç¬”æœºå™¨è½¦æˆ¿é’±é‡‘é“¶é“œé“é’¢æœ¨æ°´ç«åœŸå±±çŸ³ç‰å®ç è´å¸ç¥¨å¡è¯ç…§ç‰‡ç”»å›¾ç« å°å°ç¯æ¤…æ¡ŒæŸœæ¶ç®±åŒ…è¢‹ç›’ç“¶ç½å£¶æ¯ç¢—ç›˜ç¢Ÿå‹ºç­·]/g) || [];
            keywords.push(...valuableChars);
            
            // === ç­–ç•¥5ï¼šè¿ç»­2-3å­—çš„ä¸­æ–‡è¯ï¼ˆè¡¥å……ï¼‰ ===
            const chineseWords = text.match(/[\u4e00-\u9fa5]{2,3}/g) || [];
            chineseWords.forEach(w => {
                // åªä¿ç•™ä¸åœ¨åœç”¨è¯åˆ—è¡¨çš„
                if (!/^(æˆ‘ä»¬|ä½ ä»¬|ä»–ä»¬|ä»Šå¤©|æ˜å¤©|æ˜¨å¤©|ä»Šæ™š|ç°åœ¨|åˆšæ‰|ä¹‹å|ä»¥å‰|ä¸Šæ¬¡|ä¸‹æ¬¡|æœ€è¿‘|ä¸€ç›´|æ²¡æœ‰|å¯ä»¥|åº”è¯¥|è¿™ä¸ª|é‚£ä¸ª|ä»€ä¹ˆ|æ€ä¹ˆ|ä¸ºä»€ä¹ˆ|ä¸æ˜¯|è§‰å¾—|çŸ¥é“|ç»§ç»­|ä¹‹å‰)$/.test(w)) {
                    keywords.push(w);
                }
            });
            
            // å»é‡å¹¶ç»Ÿè®¡é¢‘ç‡
            const freq = {};
            keywords.forEach(k => {
                const clean = k.trim();
                if (clean.length > 0 && clean.length <= 6) {
                    freq[clean] = (freq[clean] || 0) + 1;
                }
            });
            
            // ä¿®å¤2: å»é™¤é‡å è¯ï¼ˆåªä¿ç•™æœ€é•¿çš„ï¼‰
            const allWords = Object.keys(freq);
            const filtered = allWords.filter(word => {
                // æ£€æŸ¥æ˜¯å¦è¢«å…¶ä»–æ›´é•¿çš„è¯åŒ…å«
                return !allWords.some(other => 
                    other !== word && 
                    other.length > word.length && 
                    other.includes(word)
                );
            });
            
            console.log(`ğŸ” å»é‡å å‰: ${allWords.length}ä¸ªè¯`);
            console.log(`âœ‚ï¸ å»é‡å å: ${filtered.length}ä¸ªè¯`);
            
            // é‡æ–°æ’åºï¼šå…ˆæŒ‰é¢‘ç‡ï¼Œå†æŒ‰é•¿åº¦
            const sorted = filtered.sort((a, b) => {
                if (freq[b] !== freq[a]) return freq[b] - freq[a];
                return b.length - a.length;
            });
            
            const result = sorted.slice(0, 8);
            console.log('ğŸ¯ æœ€ç»ˆå…³é”®è¯:', result.join(', '));
            
            return result;
        }
        
        /**
         * è°ƒç”¨APIç”Ÿæˆå›å¤ï¼ˆä»generateBtn.onclickä¸­æå–ï¼‰
         * @param {Array} currentBatchIds - å½“å‰æ‰¹æ¬¡çš„æ¶ˆæ¯IDæ•°ç»„ï¼Œç”¨äºè¯†åˆ«ç­‰å¾…æœŸé—´å‘é€çš„æ¶ˆæ¯
         */
        async function callAPIToGenerate(currentBatchIds = []) {
            // å¯åŠ¨APIè¶…æ—¶è®¡æ—¶å™¨
            const timeoutSeconds = parseInt(localStorage.getItem('apiTimeout')) || 60;
            console.log('â° å¯åŠ¨APIè¶…æ—¶è®¡æ—¶å™¨:', timeoutSeconds, 'ç§’');
            
            apiTimeoutTimer = setTimeout(() => {
                console.error('â° APIè¯·æ±‚è¶…æ—¶ï¼ˆ', timeoutSeconds, 'ç§’ï¼‰');
                
                // é‡ç½®çŠ¶æ€
                isWaitingForAI = false;
                hasReachedWaitTime = false;
                hideTypingIndicator();
                
                // æ˜¾ç¤ºè¶…æ—¶æ¶ˆæ¯
                const errorBubble = document.createElement('div');
                errorBubble.classList.add('message', 'ai');
                const bubble = document.createElement('div');
                bubble.classList.add('bubble');
                bubble.style.color = '#d32f2f';
                bubble.textContent = `â° API è¯·æ±‚è¶…æ—¶ï¼ˆ${timeoutSeconds}ç§’æœªå“åº”ï¼‰ã€‚è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•ã€‚`;
                errorBubble.appendChild(bubble);
                chatContainer.appendChild(errorBubble);
                scrollToBottom();
                
                // æ£€æŸ¥é˜Ÿåˆ—ï¼Œå¦‚æœæœ‰æ¶ˆæ¯å¯èƒ½éœ€è¦é‡è¯•
                if (pendingUserMessages.length > 0) {
                    if (hasReachedWaitTime) {
                        console.log('ğŸ“¬ è¶…æ—¶åå‘ç°å¾…å‘é€æ¶ˆæ¯ï¼Œå‡†å¤‡é‡è¯•');
                        setTimeout(() => sendBatchMessages(), 100);
                    } else {
                        console.log('ğŸ“¬ è¶…æ—¶åå‘ç°å¾…å‘é€æ¶ˆæ¯ï¼Œé‡å¯è®¡æ—¶å™¨');
                        startBatchTimer();
                    }
                }
            }, timeoutSeconds * 1000);

            // B. è·å–ç”¨æˆ·è®¾ç½®çš„ä¸Šä¸‹æ–‡çª—å£å¤§å° (N)
            const contextSizeKey = 'contextWindowSize'; 
            const N = parseInt(localStorage.getItem(contextSizeKey)) || 50; 
            
            // C. æˆªå–æœ€åNä¸ªæ°”æ³¡
            let recentBubbles = chatHistory.slice(-N);
            
            // ã€å…³é”®ä¼˜åŒ–ã€‘å‘å‰å›æº¯ï¼Œç¡®ä¿ç¬¬ä¸€æ¡æ¶ˆæ¯æ˜¯å®Œæ•´çš„
            recentBubbles = extendBackward(recentBubbles, chatHistory);
            
            console.log('ğŸ“Š å‡†å¤‡å‘é€çš„æ°”æ³¡æ•°é‡:', recentBubbles.length);
            console.log('ğŸ“Š å½“å‰æ‰¹æ¬¡ID:', currentBatchIds);
            console.log('ğŸ“Š å®Œæ•´chatHistoryé•¿åº¦:', chatHistory.length);
            console.log('ğŸ“Š chatHistoryæœ€å5æ¡ID:', chatHistory.slice(-5).map(b => b.id));
            console.log('ğŸ“Š recentBubblesçš„ID:', recentBubbles.map(b => b.id));
            
            // ã€å…³é”®ä¿®æ”¹ã€‘åœ¨åˆå¹¶å‰ï¼Œæ ‡è®°ç­‰å¾…æœŸé—´çš„useræ¶ˆæ¯ï¼ˆä½†ä¸åŠ å‰ç¼€ï¼Œç•™åˆ°åˆå¹¶æ—¶å¤„ç†ï¼‰
            const pendingBubbleIds = new Set(currentBatchIds);
            console.log('ğŸ” pendingBubbleIds:', Array.from(pendingBubbleIds));
            
            recentBubbles = recentBubbles.map(bubble => {
                if (bubble.role === 'user' && pendingBubbleIds.has(bubble.id)) {
                    // è¿™æ˜¯ç­‰å¾…æœŸé—´å‘é€çš„æ¶ˆæ¯ï¼ŒåŠ æ ‡è®°ï¼ˆä½†ä¸ä¿®æ”¹contentï¼‰
                    console.log('âœ… æ ‡è®°ä¸ºisPending:', bubble.id, bubble.content.substring(0, 20));
                    return {
                        ...bubble,
                        isPending: true
                    };
                }
                return bubble;
            });
            
            console.log('ğŸ“Š æœ€å5ä¸ªæ°”æ³¡:', recentBubbles.slice(-5).map(b => ({
                role: b.role,
                isPending: b.isPending,
                content: b.content.substring(0, 50) + '...'
            })));
            
            // D. è½¬æ¢ä¸ºAPIæ ¼å¼ï¼ˆä¿®æ”¹åˆå¹¶é€»è¾‘ï¼Œä¸åˆå¹¶å¸¦isPendingæ ‡è®°çš„æ¶ˆæ¯ï¼‰
            let apiMessages = convertToAPIFormatWithPending(recentBubbles);
            console.log('ğŸ’° Tokenä¼˜åŒ–:', recentBubbles.length, 'ä¸ªæ°”æ³¡ â†’', apiMessages.length, 'æ¡APIæ¶ˆæ¯');
            console.log('ğŸ“Š åˆå¹¶åçš„æ¶ˆæ¯:', apiMessages.map(m => ({
                role: m.role,
                content: m.content.substring(0, 50) + '...'
            })));
            
            // E. ç¡®ä¿æœ€åä¸€æ¡æ˜¯userï¼ˆåº”è¯¥å·²ç»æ˜¯äº†ï¼Œå› ä¸ºç­‰å¾…æœŸé—´çš„æ¶ˆæ¯è¢«ç§»åˆ°äº†åé¢ï¼‰
            if (apiMessages.length > 0 && apiMessages[apiMessages.length - 1].role !== 'user') {
                console.error('âŒ è­¦å‘Šï¼šæœ€åä¸€æ¡æ¶ˆæ¯ä¸æ˜¯userï¼');
            }

            // E. æ„å»ºæœ€ç»ˆçš„ Messages åˆ—è¡¨
            let finalSystemPrompt = config.systemPrompt;
            
            // æ·»åŠ é•¿æœŸè®°å¿†åˆ°ç³»ç»Ÿæç¤º
            if (longTermMemory && longTermMemory.metadata) {
                let memoryPrompt = '\n\n=== é•¿æœŸè®°å¿† ===\n\n';
                
                // æ·»åŠ åŸºæœ¬ä¿¡æ¯
                if (longTermMemory.basic_info && Object.keys(longTermMemory.basic_info).length > 0) {
                    memoryPrompt += 'ä»¥ä¸‹æ˜¯ç”¨æˆ·çš„åŸºæœ¬ä¿¡æ¯ï¼Œä½ ä½œä¸ºç”¨æˆ·çš„çˆ±äººåº”è¯¥æ·±æ·±ç‰¢è®°ï¼Œå¹¶ä¸”è´´è¿‘ç”¨æˆ·çš„å–œå¥½ï¼Œç…§é¡¾ç”¨æˆ·æ‰€æœ‰éœ€æ±‚ï¼š\n';
                    for (const [key, value] of Object.entries(longTermMemory.basic_info)) {
                        memoryPrompt += `${key}: ${value}\n`;
                    }
                    memoryPrompt += '\n';
                }
                
                // æ·»åŠ æƒ…æ„Ÿå€¾å‘
                if (longTermMemory.emotional_profile) {
                    memoryPrompt += `æ€§æ ¼: ${longTermMemory.emotional_profile}\n\n`;
                }
                
                // æ·»åŠ äººé™…å…³ç³»
                if (longTermMemory.relationships) {
                    memoryPrompt += `äººé™…å…³ç³»: ${longTermMemory.relationships}\n\n`;
                }
                
                // æ·»åŠ æ‰€æœ‰è®°å¿†ï¼ˆæŒ‰last_mentionedå€’åºï¼‰
                if (longTermMemory.important_events && longTermMemory.important_events.length > 0) {
                    // æŒ‰last_mentionedå€’åºæ’åºï¼ˆæœ€è¿‘çš„åœ¨å‰ï¼‰
                    const sortedMemories = [...longTermMemory.important_events].sort((a, b) => 
                        new Date(b.last_mentioned) - new Date(a.last_mentioned)
                    );
                    
                    memoryPrompt += 'ä»¥ä¸‹æ˜¯ä½ å’Œç”¨æˆ·äº¤äº’æ—¶ï¼Œä½ äº§ç”Ÿçš„è®°å¿†ç‰‡æ®µå’Œä½ å¯¹äºäº‹ä»¶çš„æƒ…ç»ªï¼Œä½ åº”è¯¥æ·±æ·±è®°ä½å¹¶ä¸”åŸºäºä»¥ä¸Šäº‹å®å¯¹ç”¨æˆ·çš„æœ€æ–°æ¶ˆæ¯è¿›è¡Œå›å¤ï¼ˆè¶Šé å‰çš„è®°å¿†è¶Šé‡è¦ï¼‰ï¼š\n\n';
                    
                    sortedMemories.forEach((m, i) => {
                        const date = new Date(m.last_mentioned).toLocaleDateString('zh-CN');
                        memoryPrompt += `${i + 1}. ${m.title}ï¼ˆ${date}`;
                        if (m.mention_count) {
                            memoryPrompt += `ï¼ŒæåŠ${m.mention_count}æ¬¡`;
                        }
                        memoryPrompt += `ï¼‰\n`;
                        memoryPrompt += `${m.content}\n`;
                        if (m.assistant_attitude) {
                            memoryPrompt += `ä½ çš„æ€åº¦: ${m.assistant_attitude}\n`;
                        }
                        memoryPrompt += '\n';
                    });
                }
                
                memoryPrompt += '=== è®°å¿†ç»“æŸ ===\n';
                finalSystemPrompt += memoryPrompt;
            }
            
            // æ·»åŠ å½“å‰æ—¶é—´ä¿¡æ¯åˆ°ç³»ç»Ÿæç¤º
            const now = new Date();
            const currentTimeStr = now.toLocaleString('zh-CN', {
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit', weekday: 'long', hour12: false
            });
            finalSystemPrompt += `\n\n[å½“å‰æ—¶é—´]: ${currentTimeStr}`;
            
            // ä¸ºæ¯æ¡æ¶ˆæ¯æ·»åŠ æ—¶é—´ä¿¡æ¯
            const messagesWithTime = apiMessages.map(msg => {
                if (msg.timestamp) {
                    const time = new Date(msg.timestamp);
                    const timeStr = time.toLocaleString('zh-CN', {
                        year: 'numeric', month: '2-digit', day: '2-digit',
                        hour: '2-digit', minute: '2-digit', hour12: false
                    });
                    return {
                        role: msg.role,
                        content: `[${timeStr}] ${msg.content}`
                    };
                } else {
                    return {
                        role: msg.role,
                        content: msg.content
                    };
                }
            });
            
            const messages = [
                { role: "system", content: finalSystemPrompt },
                ...messagesWithTime 
            ];
            
            // ã€è°ƒè¯•æ—¥å¿—ã€‘è¾“å‡ºå‘é€ç»™APIçš„æ¶ˆæ¯
            console.log('ğŸ“¤ å‡†å¤‡å‘é€APIè¯·æ±‚');
            console.log('ğŸ“Š æ¶ˆæ¯æ•°é‡:', messages.length);
            console.log('ğŸ” ç¬¬ä¸€æ¡æ¶ˆæ¯è§’è‰²:', messages[1]?.role);
            console.log('ğŸ” æœ€åä¸€æ¡æ¶ˆæ¯è§’è‰²:', messages[messages.length - 1]?.role);
            console.log('ğŸ“‹ æœ€å5æ¡æ¶ˆæ¯:', messages.slice(-5).map(m => ({
                role: m.role,
                content: m.content.substring(0, 50) + '...'
            })));
            console.log('ğŸ“ å®Œæ•´chatHistoryé•¿åº¦:', chatHistory.length);
            console.log('ğŸ“ æœ€å3æ¡chatHistory:', chatHistory.slice(-3).map(b => ({
                role: b.role,
                content: b.content.substring(0, 30) + '...',
                timestamp: b.timestamp
            })));
            
            // ã€å…³é”®æ£€æŸ¥ã€‘APIè¦æ±‚æœ€åä¸€æ¡æ¶ˆæ¯å¿…é¡»æ˜¯user
            const lastMessage = messages[messages.length - 1];
            if (lastMessage.role !== 'user') {
                console.error('âŒ é”™è¯¯ï¼šæœ€åä¸€æ¡æ¶ˆæ¯ä¸æ˜¯userè§’è‰²ï¼role =', lastMessage.role);
                console.error('è¿™ä¼šå¯¼è‡´APIè¿”å›ç©ºçš„choicesæ•°ç»„');
            }
            
            const requestBody = {
                model: config.modelname,
                messages: messages,
                max_tokens: 5000,
                temperature: 1.2
            };

            const apiUrl = config.baseurl.endsWith('/v1') ? 
                           `${config.baseurl}/chat/completions` : 
                           `${config.baseurl}/v1/chat/completions`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${config.apikey}`
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API è¯·æ±‚å¤±è´¥: ${response.status} - ${errorText}`);
                }

                const data = await response.json();
                
                // æ¸…é™¤è¶…æ—¶è®¡æ—¶å™¨
                if (apiTimeoutTimer) {
                    clearTimeout(apiTimeoutTimer);
                    apiTimeoutTimer = null;
                    console.log('âœ… APIå“åº”æˆåŠŸï¼Œå·²æ¸…é™¤è¶…æ—¶è®¡æ—¶å™¨');
                }
                
                // å®‰å…¨è®¿é—®APIæ•°æ®
                if (!data || !data.choices || !data.choices[0] || 
                    !data.choices[0].message || !data.choices[0].message.content) {
                    throw new Error('APIè¿”å›æ•°æ®æ ¼å¼ä¸æ­£ç¡®: ' + JSON.stringify(data).substring(0, 200));
                }
                
                let aiResponseText = data.choices[0].message.content.trim();
                console.log("ã€APIåŸå§‹è¾“å‡ºã€‘:", encodeURI(aiResponseText).substring(0, 50));
                aiResponseText = cleanApiResponse(aiResponseText);
                console.log("ã€APIæ¸…ç†åè¾“å‡ºã€‘:", encodeURI(aiResponseText).substring(0, 50));
                
                // éšè—"å¯¹æ–¹æ­£åœ¨è¾“å…¥ä¸­..."
                hideTypingIndicator();
                
                // è°ƒç”¨å‡½æ•°æ¥å¤„ç†å¹¶é€æ¡æ˜¾ç¤ºæ¶ˆæ¯
                processAndDisplaySegments(aiResponseText);

            } catch (error) {
                console.error("API è°ƒç”¨å‡ºé”™:", error);
                
                // æ¸…é™¤è¶…æ—¶è®¡æ—¶å™¨
                if (apiTimeoutTimer) {
                    clearTimeout(apiTimeoutTimer);
                    apiTimeoutTimer = null;
                    console.log('âŒ APIè°ƒç”¨å‡ºé”™ï¼Œå·²æ¸…é™¤è¶…æ—¶è®¡æ—¶å™¨');
                }
                
                // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
                const errorMessage = document.createElement('div');
                errorMessage.classList.add('message', 'assistant');
                const errorBubble = document.createElement('div');
                errorBubble.classList.add('bubble');
                errorBubble.textContent = `[é”™è¯¯] æ— æ³•è·å–å›å¤ã€‚è¯·æ£€æŸ¥æ‚¨çš„è®¾ç½®å’Œç½‘ç»œè¿æ¥ã€‚è¯¦ç»†é”™è¯¯ï¼š${error.message}`;
                errorMessage.appendChild(errorBubble);
                chatContainer.appendChild(errorMessage);
                scrollToBottom();
                
                hideTypingIndicator();
                isWaitingForAI = false;
                
                // æ£€æŸ¥é˜Ÿåˆ—ï¼Œå¦‚æœæœ‰æ¶ˆæ¯å¯èƒ½éœ€è¦é‡è¯•
                if (pendingUserMessages.length > 0) {
                    if (hasReachedWaitTime) {
                        console.log('ğŸ“¬ é”™è¯¯åå‘ç°å¾…å‘é€æ¶ˆæ¯ï¼Œå‡†å¤‡é‡è¯•');
                        setTimeout(() => sendBatchMessages(), 100);
                    } else {
                        console.log('ğŸ“¬ é”™è¯¯åå‘ç°å¾…å‘é€æ¶ˆæ¯ï¼Œé‡å¯è®¡æ—¶å™¨');
                        startBatchTimer();
                    }
                }
            }
        }
        // ====================================

        /**
         * ç‚¹å‡»ç”ŸæˆæŒ‰é’®ï¼Œè°ƒç”¨ API
         */
        /**
         * ç‚¹å‡»å‘é€æŒ‰é’®
         */
        /**
         * å‘é€æ¶ˆæ¯
         */
        async function generateResponse() {
            let userMessage = userInput.value.trim();
            if (!userMessage) return;

            // æ£€æŸ¥é…ç½®
            if (!config.baseurl || !config.apikey) {
                showConfigReminder();
                return;
            }
            
            // ä¿å­˜å¼•ç”¨ä¿¡æ¯
            let quoteInfo = null;
            if (currentQuote) {
                const senderName = currentQuote.role === 'user' ? config.userNickname : config.aiNickname;
                quoteInfo = {
                    sender: senderName,
                    content: currentQuote.content
                };
            }

            // 1. æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯(å¦‚æœæœ‰å¼•ç”¨,ä¼ é€’å¼•ç”¨ä¿¡æ¯)
            const bubble = displayMessage(userMessage, 'user', 1, null, true, null, false, quoteInfo);
            
            // 2. æ¸…é™¤å¼•ç”¨é¢„è§ˆ
            if (currentQuote) {
                clearQuote();
            }
            
            // 3. æ¸…ç©ºè¾“å…¥æ¡†
            userInput.value = '';
            
            // 4. å°†æ­¤æ°”æ³¡IDåŠ å…¥å¾…å‘é€é˜Ÿåˆ—
            pendingUserMessages.push(bubble.id);
            console.log('ğŸ“ æ·»åŠ åˆ°é˜Ÿåˆ—:', bubble.id, 'å½“å‰é˜Ÿåˆ—é•¿åº¦:', pendingUserMessages.length);
            
            // 5. å¯åŠ¨/é‡å¯è®¡æ—¶å™¨
            startBatchTimer();
        }
        
        /**
         *æ»šåŠ¨åˆ°èŠå¤©å†…å®¹åº•éƒ¨ï¼ˆåŒ requestAnimationFrame ç¡®ä¿æ¸²æŸ“å®Œæˆï¼‰
         
        /**
         * æ»šåŠ¨åˆ°èŠå¤©å†…å®¹åº•éƒ¨
         */
        function scrollToBottom() {
            const activePage = document.querySelector('.page.active');
            const contentArea = activePage ? activePage.querySelector('.content') : null;
            
            if (contentArea && contentArea.scrollHeight > 0) {
                // ä½¿ç”¨requestAnimationFrameç¡®ä¿DOMå·²æ¸²æŸ“ï¼Œç„¶åç«‹å³æ»šåŠ¨
                requestAnimationFrame(() => {
                    contentArea.scrollTop = contentArea.scrollHeight;
                });
            }
        }
        
        /**
         * å…¨å±€è¯Šæ–­å‡½æ•° - åœ¨consoleä¸­è°ƒç”¨æ¥æ£€æŸ¥å¸ƒå±€
         */
        window.debugLayout = function() {
            console.log('========== å¸ƒå±€è¯Šæ–­æŠ¥å‘Š ==========');
            
            const body = document.body;
            const appContainer = document.getElementById('app-container');
            const activePage = document.querySelector('.page.active');
            const contentArea = activePage ? activePage.querySelector('.content') : null;
            const chatContainer = document.getElementById('chat-container');
            
            console.log('ğŸ“± Body:', {
                height: body.style.height,
                computedHeight: window.getComputedStyle(body).height,
                overflow: window.getComputedStyle(body).overflow
            });
            
            console.log('ğŸ“¦ Appå®¹å™¨:', {
                height: appContainer.style.height,
                width: appContainer.style.width,
                computedHeight: window.getComputedStyle(appContainer).height,
                display: window.getComputedStyle(appContainer).display
            });
            
            console.log('ğŸ“„ æ´»è·ƒé¡µé¢:', {
                id: activePage ? activePage.id : 'æ— ',
                height: activePage ? window.getComputedStyle(activePage).height : 'æ— ',
                display: activePage ? window.getComputedStyle(activePage).display : 'æ— ',
                flexGrow: activePage ? window.getComputedStyle(activePage).flexGrow : 'æ— '
            });
            
            console.log('ğŸ“‹ Contentå®¹å™¨:', {
                found: !!contentArea,
                height: contentArea ? window.getComputedStyle(contentArea).height : 'æ— ',
                scrollHeight: contentArea ? contentArea.scrollHeight : 'æ— ',
                clientHeight: contentArea ? contentArea.clientHeight : 'æ— ',
                offsetHeight: contentArea ? contentArea.offsetHeight : 'æ— ',
                display: contentArea ? window.getComputedStyle(contentArea).display : 'æ— ',
                overflow: contentArea ? window.getComputedStyle(contentArea).overflow : 'æ— ',
                flexGrow: contentArea ? window.getComputedStyle(contentArea).flexGrow : 'æ— ',
                minHeight: contentArea ? window.getComputedStyle(contentArea).minHeight : 'æ— '
            });
            
            console.log('ğŸ’¬ Chatå®¹å™¨:', {
                height: chatContainer ? window.getComputedStyle(chatContainer).height : 'æ— ',
                scrollHeight: chatContainer ? chatContainer.scrollHeight : 'æ— ',
                childCount: chatContainer ? chatContainer.children.length : 'æ— '
            });
            
            console.log('================================');
            console.log('ğŸ’¡ æç¤º: è°ƒç”¨ window.scrollToBottom() æ¥æ‰‹åŠ¨æ»šåŠ¨');
        };
        
        console.log('âœ… è°ƒè¯•å·¥å…·å·²åŠ è½½ï¼Œåœ¨consoleä¸­è¾“å…¥ debugLayout() æ¥æ£€æŸ¥å¸ƒå±€');
        
        
        // ==================== å¤šè§’è‰²èŠå¤©åˆ—è¡¨åŠŸèƒ½ ====================
        
        let charactersList = [];  // è§’è‰²åˆ—è¡¨
        let currentCharacterId = null;  // å½“å‰æ´»è·ƒçš„è§’è‰²ID
        
        // åŠ è½½è§’è‰²åˆ—è¡¨
        function loadCharactersList() {
            const saved = localStorage.getItem('charactersList');
            if (saved) {
                try {
                    charactersList = JSON.parse(saved);
                } catch (e) {
                    console.error('åŠ è½½è§’è‰²åˆ—è¡¨å¤±è´¥:', e);
                    charactersList = [];
                }
            }
        }
        
        // ä¿å­˜è§’è‰²åˆ—è¡¨
        function saveCharactersList() {
            localStorage.setItem('charactersList', JSON.stringify(charactersList));
        }
        
        // æ›´æ–°èŠå¤©é¡µé¢çš„å¤´åƒæ˜¾ç¤º
        function updateChatPageAvatars() {
            // æ›´æ–°èŠå¤©é¡µé¢å¤´åƒåŒºåŸŸ(å¦‚æœæœ‰çš„è¯)
            const chatAvatarElements = document.querySelectorAll('#chat-page .message-avatar');
            // è¿™ä¸ªå‡½æ•°ä¸»è¦æ˜¯ä¸ºäº†ä¿æŒä¸€è‡´æ€§,å®é™…å¤´åƒåœ¨displayMessageä¸­æ¸²æŸ“
            console.log('ğŸ’¡ èŠå¤©é¡µé¢å¤´åƒå°†åœ¨ä¸‹æ¬¡å‘é€æ¶ˆæ¯æ—¶æ›´æ–°');
        }
        
        // è·å–é»˜è®¤çš„é•¿æœŸè®°å¿†å¯¹è±¡
        function getDefaultLongTermMemory() {
            return {
                basic_info: {},
                emotional_profile: "",
                relationships: "",  // æ–°å¢ï¼šäººé™…å…³ç³»
                important_events: [],
                metadata: {
                    total_messages: 0,
                    last_summary_at: 0,
                    last_updated: null,
                    version: 3,  // ç‰ˆæœ¬å·å‡çº§åˆ°3
                    next_memory_id: 1
                }
            };
        }
        
        // è·å–é»˜è®¤é…ç½®
        function getDefaultCharacterConfig(isFirst) {
            if (isFirst || charactersList.length === 0) {
                // ç¬¬ä¸€ä¸ªè§’è‰²ä½¿ç”¨ç¡¬ç¼–ç é»˜è®¤å€¼
                return {
                    systemPrompt: '',
                    aiNickname: 'AIåŠ©æ‰‹',
                    userNickname: 'æˆ‘',
                    aiAvatar: null,
                    userAvatar: null,
                    maxContextMessages: 50,
                    batchWaitTime: 7,
                    autoSummaryInterval: 50,
                    maxImportantEvents: 10
                };
            } else {
                // ä»ç¬¬ä¸€ä¸ªè§’è‰²å¤åˆ¶é…ç½®
                const firstCharId = charactersList[0].id;
                const firstConfig = localStorage.getItem(`char_${firstCharId}_config`);
                if (firstConfig) {
                    const parsed = JSON.parse(firstConfig);
                    return {
                        systemPrompt: '',  // ç³»ç»Ÿæç¤ºè¯éœ€è¦ç”¨æˆ·å¡«å†™
                        aiNickname: '',    // è§’è‰²æ˜µç§°éœ€è¦ç”¨æˆ·å¡«å†™
                        userNickname: '',  // ç”¨æˆ·æ˜µç§°éœ€è¦ç”¨æˆ·å¡«å†™
                        aiAvatar: null,    // å¤´åƒéœ€è¦ç”¨æˆ·ä¸Šä¼ 
                        userAvatar: null,  // å¤´åƒéœ€è¦ç”¨æˆ·ä¸Šä¼ 
                        maxContextMessages: parsed.maxContextMessages,
                        batchWaitTime: parsed.batchWaitTime,
                        autoSummaryInterval: parsed.autoSummaryInterval,
                        maxImportantEvents: parsed.maxImportantEvents
                    };
                }
                return getDefaultCharacterConfig(true);
            }
        }
        
        // ä¿å­˜å½“å‰è§’è‰²çš„æ‰€æœ‰æ•°æ®
        function saveCurrentCharacterData() {
            if (!currentCharacterId) return;
            
            console.log('ğŸ’¾ ä¿å­˜è§’è‰²æ•°æ®:', currentCharacterId);
            
            // ä¿å­˜é…ç½®
            const currentConfig = {
                systemPrompt: config.systemPrompt,
                aiNickname: config.aiNickname,
                userNickname: config.userNickname,
                aiAvatar: config.aiAvatar,
                userAvatar: config.userAvatar,
                maxContextMessages: config.maxContextMessages,
                batchWaitTime: config.batchWaitTime,
                autoSummaryInterval: config.autoSummaryInterval,
                maxImportantEvents: config.maxImportantEvents
            };
            localStorage.setItem(`char_${currentCharacterId}_config`, JSON.stringify(currentConfig));
            
            // ä¿å­˜èŠå¤©è®°å½•
            localStorage.setItem(`char_${currentCharacterId}_chatHistory`, JSON.stringify(chatHistory));
            
            // ä¿å­˜é•¿æœŸè®°å¿†
            localStorage.setItem(`char_${currentCharacterId}_longTermMemory`, JSON.stringify(longTermMemory));
            
            // ä¿å­˜å¾…æ€»ç»“æ¶ˆæ¯
            localStorage.setItem(`char_${currentCharacterId}_pendingSummaryBubbles`, JSON.stringify(pendingSummaryBubbles));
        }
        
        // æ¸…é™¤å½“å‰è§’è‰²çš„è¿è¡Œæ—¶çŠ¶æ€
        function clearRuntimeState() {
            console.log('ğŸ§¹ æ¸…é™¤è¿è¡Œæ—¶çŠ¶æ€');
            
            // æ¸…é™¤è®¡æ—¶å™¨
            if (batchSendTimer) {
                clearTimeout(batchSendTimer);
                batchSendTimer = null;
            }
            if (apiTimeoutTimer) {
                clearTimeout(apiTimeoutTimer);
                apiTimeoutTimer = null;
            }
            
            // é‡ç½®çŠ¶æ€
            pendingUserMessages = [];
            isWaitingForAI = false;
            hasReachedWaitTime = false;
            
            // ã€ä¿®å¤ã€‘é‡ç½®æ‡’åŠ è½½çŠ¶æ€
            currentLoadedStart = 0;
            isLoadingMore = false;
            
            // ã€ä¿®å¤ã€‘æ¸…é™¤æ»šåŠ¨ç›‘å¬æ ‡è®°ï¼Œå…è®¸æ–°è§’è‰²é‡æ–°ç»‘å®š
            const chatPage = document.getElementById('chat-page');
            if (chatPage) {
                const scrollContainer = chatPage.querySelector('.content');
                if (scrollContainer) {
                    scrollContainer.dataset.scrollListenerBound = 'false';
                }
            }
            
            // æ¸…é™¤è¾“å…¥ä¸­æç¤º
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }
        
        // åŠ è½½è§’è‰²çš„æ‰€æœ‰æ•°æ®
        function loadCharacterData(characterId) {
            console.log('ğŸ“‚ åŠ è½½è§’è‰²æ•°æ®:', characterId);
            
            const character = charactersList.find(c => c.id === characterId);
            if (!character) {
                console.error('è§’è‰²ä¸å­˜åœ¨:', characterId);
                return;
            }
            
            currentCharacterId = characterId;
            
            // åŠ è½½é…ç½®
            const savedConfig = localStorage.getItem(`char_${characterId}_config`);
            if (savedConfig) {
                const charConfig = JSON.parse(savedConfig);
                config.systemPrompt = charConfig.systemPrompt || '';
                config.aiNickname = charConfig.aiNickname || 'AIåŠ©æ‰‹';
                config.userNickname = charConfig.userNickname || 'æˆ‘';
                config.aiAvatar = charConfig.aiAvatar || null;
                config.userAvatar = charConfig.userAvatar || null;
                config.maxContextMessages = charConfig.maxContextMessages || 50;
                config.batchWaitTime = charConfig.batchWaitTime || 7;
                config.autoSummaryInterval = charConfig.autoSummaryInterval || 50;
                config.maxImportantEvents = charConfig.maxImportantEvents || 10;
                
                console.log('ğŸ“ å·²åŠ è½½é…ç½® - AIæ˜µç§°:', config.aiNickname, 'ç”¨æˆ·æ˜µç§°:', config.userNickname);
                
                // æ›´æ–°è®¾ç½®é¡µé¢çš„å¤´åƒé¢„è§ˆ
                renderAvatar(document.getElementById('ai-avatar-preview-settings'), config.aiAvatar, 'ai', config.aiNickname.substring(0, 1));
                renderAvatar(document.getElementById('user-avatar-preview-settings'), config.userAvatar, 'user', config.userNickname.substring(0, 1));
                document.getElementById('ai-avatar-remove-btn-settings').style.display = config.aiAvatar ? 'inline-block' : 'none';
                document.getElementById('user-avatar-remove-btn-settings').style.display = config.userAvatar ? 'inline-block' : 'none';
            } else {
                // å¦‚æœæ²¡æœ‰é…ç½®,ä½¿ç”¨é»˜è®¤é…ç½®
                console.warn('âš ï¸ æœªæ‰¾åˆ°è§’è‰²é…ç½®,ä½¿ç”¨é»˜è®¤å€¼:', characterId);
                const defaultConfig = getDefaultCharacterConfig(false);
                config.systemPrompt = defaultConfig.systemPrompt;
                config.aiNickname = defaultConfig.aiNickname;
                config.userNickname = defaultConfig.userNickname;
                config.aiAvatar = defaultConfig.aiAvatar;
                config.userAvatar = defaultConfig.userAvatar;
                config.maxContextMessages = defaultConfig.maxContextMessages;
                config.batchWaitTime = defaultConfig.batchWaitTime;
                config.autoSummaryInterval = defaultConfig.autoSummaryInterval;
                config.maxImportantEvents = defaultConfig.maxImportantEvents;
                
                // æ›´æ–°è®¾ç½®é¡µé¢çš„å¤´åƒé¢„è§ˆ
                renderAvatar(document.getElementById('ai-avatar-preview-settings'), config.aiAvatar, 'ai', config.aiNickname.substring(0, 1));
                renderAvatar(document.getElementById('user-avatar-preview-settings'), config.userAvatar, 'user', config.userNickname.substring(0, 1));
                document.getElementById('ai-avatar-remove-btn-settings').style.display = config.aiAvatar ? 'inline-block' : 'none';
                document.getElementById('user-avatar-remove-btn-settings').style.display = config.userAvatar ? 'inline-block' : 'none';
            }
            
            // åŠ è½½èŠå¤©è®°å½•
            const savedHistory = localStorage.getItem(`char_${characterId}_chatHistory`);
            chatHistory = savedHistory ? JSON.parse(savedHistory) : [];
            
            // åŠ è½½é•¿æœŸè®°å¿†
            const savedMemory = localStorage.getItem(`char_${characterId}_longTermMemory`);
            longTermMemory = savedMemory ? JSON.parse(savedMemory) : getDefaultLongTermMemory();
            
            // åŠ è½½å¾…æ€»ç»“æ¶ˆæ¯
            const savedPending = localStorage.getItem(`char_${characterId}_pendingSummaryBubbles`);
            pendingSummaryBubbles = savedPending ? JSON.parse(savedPending) : [];
            
            // æ›´æ–°èŠå¤©é¡µé¢UI
            const chatNameElement = document.getElementById('chat-name');
            if (chatNameElement) {
                chatNameElement.textContent = config.aiNickname;
                console.log('âœ… èŠå¤©æ¡†æ ‡é¢˜å·²æ›´æ–°ä¸º:', config.aiNickname);
            }
            
            // æ›´æ–°èŠå¤©é¡µé¢çš„å¤´åƒ
            updateChatPageAvatars();
            
            console.log('âœ… è§’è‰²æ•°æ®åŠ è½½å®Œæˆ');
        }
        
        // åˆ‡æ¢åˆ°æŒ‡å®šè§’è‰²
        function switchToCharacter(characterId) {
            console.log('ğŸ”„ åˆ‡æ¢è§’è‰²:', currentCharacterId, '->', characterId);
            
            // 1. ä¿å­˜å½“å‰è§’è‰²æ•°æ®
            if (currentCharacterId && currentCharacterId !== characterId) {
                saveCurrentCharacterData();
                clearRuntimeState();
            }
            
            // 2. åŠ è½½æ–°è§’è‰²æ•°æ®
            loadCharacterData(characterId);
            
            // 3. ã€ä¿®å¤ã€‘ä½¿ç”¨æ‡’åŠ è½½é‡æ–°æ¸²æŸ“èŠå¤©ç•Œé¢
            loadHistoryUI();
        }
        
        // æ¸²æŸ“è§’è‰²åˆ—è¡¨
        function renderCharactersList() {
            const container = document.getElementById('characters-list-container');
            
            if (charactersList.length === 0) {
                container.innerHTML = `
                    <div class="character-empty-list">
                        <div style="font-size: 64px; margin-bottom: 16px; opacity: 0.3;">ğŸ’¬</div>
                        <div>æš‚æ— èŠå¤©</div>
                        <div style="font-size: 13px; margin-top: 8px;">ç‚¹å‡»å³ä¸Šè§’"+"æ·»åŠ è§’è‰²</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            charactersList.forEach(character => {
                const savedHistory = localStorage.getItem(`char_${character.id}_chatHistory`);
                const history = savedHistory ? JSON.parse(savedHistory) : [];
                const lastMsg = history.length > 0 ? history[history.length - 1] : null;
                
                const savedConfig = localStorage.getItem(`char_${character.id}_config`);
                const charConfig = savedConfig ? JSON.parse(savedConfig) : {};
                const userNick = charConfig.userNickname || 'æˆ‘';
                const aiAvatar = charConfig.aiAvatar;
                const aiNickname = charConfig.aiNickname || 'AI';
                
                const preview = lastMsg 
                    ? (lastMsg.role === 'user' ? `${userNick}: ` : '') + lastMsg.content.substring(0, 30)
                    : 'å¼€å§‹èŠå¤©...';
                
                const item = document.createElement('div');
                item.className = 'character-list-item';
                item.onclick = () => openCharacterChat(character.id);
                
                // åˆ›å»ºå¤´åƒå®¹å™¨
                const avatarContainer = document.createElement('div');
                avatarContainer.className = 'character-list-avatar';
                
                if (aiAvatar) {
                    const img = document.createElement('img');
                    img.src = aiAvatar;
                    img.style.width = '100%';
                    img.style.height = '100%';
                    img.style.objectFit = 'cover';
                    img.style.borderRadius = '6px';
                    avatarContainer.appendChild(img);
                } else {
                    const defaultDiv = document.createElement('div');
                    defaultDiv.className = 'default-avatar ai';
                    defaultDiv.textContent = aiNickname.substring(0, 1);
                    avatarContainer.appendChild(defaultDiv);
                }
                
                const infoDiv = document.createElement('div');
                infoDiv.className = 'character-list-info';
                infoDiv.innerHTML = `
                    <div class="character-list-name">${aiNickname}</div>
                    <div class="character-list-preview">${preview}</div>
                `;
                
                item.appendChild(avatarContainer);
                item.appendChild(infoDiv);
                container.appendChild(item);
            });
        }
        
        // æ‰“å¼€è§’è‰²èŠå¤©
        function openCharacterChat(characterId) {
            switchToCharacter(characterId);
            showPage('chat-page');
        }
        
        // è¿”å›èŠå¤©åˆ—è¡¨
        document.getElementById('back-to-chat-list-btn').onclick = function() {
            if (currentCharacterId) {
                saveCurrentCharacterData();
                clearRuntimeState();
            }
            renderCharactersList();
            showPage('chat-list-page');
        };
        
        // åŠ å·èœå•
        document.getElementById('add-character-menu-btn').onclick = function(e) {
            e.stopPropagation();
            document.getElementById('character-add-menu').classList.toggle('active');
        };
        
        document.addEventListener('click', function(e) {
            const menu = document.getElementById('character-add-menu');
            const btn = document.getElementById('add-character-menu-btn');
            if (menu && !menu.contains(e.target) && e.target !== btn) {
                menu.classList.remove('active');
            }
        });
        
        // æ–°å»ºè§’è‰²æ¨¡æ€æ¡†
        function openNewCharacterModal() {
            document.getElementById('character-add-menu').classList.remove('active');
            document.getElementById('new-character-modal').classList.add('active');
        }
        
        function closeNewCharacterModal() {
            document.getElementById('new-character-modal').classList.remove('active');
            document.getElementById('new-character-name').value = '';
            document.getElementById('new-character-ai-nickname').value = '';
            document.getElementById('new-character-user-nickname').value = '';
            document.getElementById('new-character-prompt').value = '';
            
            // æ¸…é™¤ä¸´æ—¶å¤´åƒ
            tempNewCharacterAvatar = null;
            const preview = document.getElementById('new-character-avatar-preview');
            preview.innerHTML = '<div class="default-avatar ai">AI</div>';
        }
        
        function confirmCreateCharacter() {
            const characterName = document.getElementById('new-character-name').value.trim();
            const aiNickname = document.getElementById('new-character-ai-nickname').value.trim();
            const userNickname = document.getElementById('new-character-user-nickname').value.trim();
            const systemPrompt = document.getElementById('new-character-prompt').value.trim();
            
            // éªŒè¯å¿…å¡«å­—æ®µ
            if (!characterName) {
                alert('âŒ è¯·è¾“å…¥è§’è‰²å§“å');
                return;
            }
            if (!aiNickname) {
                alert('âŒ è¯·è¾“å…¥è§’è‰²æ˜µç§°');
                return;
            }
            if (!userNickname) {
                alert('âŒ è¯·è¾“å…¥ç”¨æˆ·æ˜µç§°');
                return;
            }
            
            const newId = `char_${Date.now()}`;
            const isFirst = charactersList.length === 0;
            
            // åˆ›å»ºè§’è‰²åŸºæœ¬ä¿¡æ¯
            const character = {
                id: newId,
                name: characterName,
                createdAt: new Date().toISOString()
            };
            
            // è·å–é»˜è®¤é…ç½®
            const defaultConfig = getDefaultCharacterConfig(isFirst);
            defaultConfig.systemPrompt = systemPrompt;
            defaultConfig.aiNickname = aiNickname;
            defaultConfig.userNickname = userNickname;
            defaultConfig.aiAvatar = tempNewCharacterAvatar; // ä½¿ç”¨ä¸Šä¼ çš„å¤´åƒ
            
            console.log('ğŸ’¾ ä¿å­˜è§’è‰²é…ç½®:', defaultConfig);
            
            // ä¿å­˜åˆ°localStorage
            charactersList.push(character);
            saveCharactersList();
            localStorage.setItem(`char_${newId}_config`, JSON.stringify(defaultConfig));
            localStorage.setItem(`char_${newId}_chatHistory`, JSON.stringify([]));
            localStorage.setItem(`char_${newId}_longTermMemory`, JSON.stringify(getDefaultLongTermMemory()));
            localStorage.setItem(`char_${newId}_pendingSummaryBubbles`, JSON.stringify([]));
            
            closeNewCharacterModal();
            renderCharactersList();
            
            // ç«‹å³åˆ‡æ¢åˆ°æ–°åˆ›å»ºçš„è§’è‰²
            switchToCharacter(newId);
            showPage('chat-page');
            
            console.log('âœ… è§’è‰²åˆ›å»ºæˆåŠŸå¹¶å·²åˆ‡æ¢:', newId, 'å§“å:', characterName, 'æ˜µç§°:', aiNickname);
        }
        
        // å¯¼å…¥è§’è‰²æ¨¡æ€æ¡†
        function openImportCharacterModal() {
            document.getElementById('character-add-menu').classList.remove('active');
            document.getElementById('import-character-modal').classList.add('active');
        }
        
        function closeImportCharacterModal() {
            document.getElementById('import-character-modal').classList.remove('active');
            document.getElementById('import-character-data').value = '';
        }
        
        function confirmImportCharacter() {
            const data = document.getElementById('import-character-data').value.trim();
            
            if (!data) {
                alert('è¯·è¾“å…¥è§’è‰²æ•°æ®');
                return;
            }
            
            try {
                const imported = JSON.parse(data);
                
                if (!imported.name || !imported.aiNickname || !imported.userNickname) {
                    throw new Error('ç¼ºå°‘å¿…è¦å­—æ®µ: name, aiNickname, userNickname');
                }
                
                const newId = `char_${Date.now()}`;
                const isFirst = charactersList.length === 0;
                
                const character = {
                    id: newId,
                    name: imported.name,
                    avatar: imported.avatar || 'ğŸ¤–',
                    createdAt: new Date().toISOString()
                };
                
                const defaultConfig = getDefaultCharacterConfig(isFirst);
                defaultConfig.systemPrompt = imported.systemPrompt || '';
                defaultConfig.aiNickname = imported.aiNickname;
                defaultConfig.userNickname = imported.userNickname;
                
                charactersList.push(character);
                saveCharactersList();
                localStorage.setItem(`char_${newId}_config`, JSON.stringify(defaultConfig));
                localStorage.setItem(`char_${newId}_chatHistory`, JSON.stringify([]));
                localStorage.setItem(`char_${newId}_longTermMemory`, JSON.stringify(getDefaultLongTermMemory()));
                localStorage.setItem(`char_${newId}_pendingSummaryBubbles`, JSON.stringify([]));
                
                closeImportCharacterModal();
                renderCharactersList();
                
                // ç«‹å³åˆ‡æ¢åˆ°å¯¼å…¥çš„è§’è‰²
                switchToCharacter(newId);
                showPage('chat-page');
                
                console.log('âœ… è§’è‰²å¯¼å…¥æˆåŠŸå¹¶å·²åˆ‡æ¢:', newId);
            } catch (e) {
                alert('å¯¼å…¥å¤±è´¥: ' + e.message);
            }
        }
        
        document.getElementById('import-character-file').onchange = function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    document.getElementById('import-character-data').value = event.target.result;
                };
                reader.readAsText(file);
            }
        };
        
        // æœç´¢åŠŸèƒ½
        document.getElementById('character-search-input').oninput = function(e) {
            const keyword = e.target.value.toLowerCase();
            document.querySelectorAll('.character-list-item').forEach(item => {
                const name = item.querySelector('.character-list-name').textContent.toLowerCase();
                item.style.display = name.includes(keyword) ? 'flex' : 'none';
            });
        };
        
        // é‡å†™saveChatHistory,ä½¿å…¶ä¿å­˜åˆ°å½“å‰è§’è‰²
        const originalSaveChatHistory = saveChatHistory;
        saveChatHistory = function() {
            if (currentCharacterId) {
                saveCurrentCharacterData();
            } else {
                originalSaveChatHistory();
            }
        };
        
        // åˆå§‹åŒ–
        loadCharactersList();
        
        // ==================== å¤´åƒä¸Šä¼ åŠŸèƒ½ ====================
        
        // æ–°å»ºè§’è‰²çš„å¤´åƒä¸Šä¼ 
        document.getElementById('new-character-avatar-input').onchange = async function(e) {
            const file = e.target.files[0];
            if (file) {
                try {
                    const avatarData = await processAvatarImage(file);
                    tempNewCharacterAvatar = avatarData;
                    
                    const preview = document.getElementById('new-character-avatar-preview');
                    const img = document.createElement('img');
                    img.src = avatarData;
                    img.style.width = '100%';
                    img.style.height = '100%';
                    img.style.objectFit = 'cover';
                    img.style.borderRadius = '6px';
                    preview.innerHTML = '';
                    preview.appendChild(img);
                } catch (error) {
                    alert(error);
                }
            }
        };
        
        // è®¾ç½®é¡µé¢ - AIå¤´åƒä¸Šä¼ 
        document.getElementById('ai-avatar-input-settings').onchange = async function(e) {
            const file = e.target.files[0];
            if (file) {
                try {
                    const avatarData = await processAvatarImage(file);
                    config.aiAvatar = avatarData;
                    
                    renderAvatar(document.getElementById('ai-avatar-preview-settings'), avatarData, 'ai', config.aiNickname.substring(0, 1));
                    document.getElementById('ai-avatar-remove-btn-settings').style.display = 'inline-block';
                    
                    // ä¿å­˜åˆ°å½“å‰è§’è‰²
                    if (currentCharacterId) {
                        saveCurrentCharacterData();
                    }
                } catch (error) {
                    alert(error);
                }
            }
        };
        
        // è®¾ç½®é¡µé¢ - ç”¨æˆ·å¤´åƒä¸Šä¼ 
        document.getElementById('user-avatar-input-settings').onchange = async function(e) {
            const file = e.target.files[0];
            if (file) {
                try {
                    const avatarData = await processAvatarImage(file);
                    config.userAvatar = avatarData;
                    
                    renderAvatar(document.getElementById('user-avatar-preview-settings'), avatarData, 'user', config.userNickname.substring(0, 1));
                    document.getElementById('user-avatar-remove-btn-settings').style.display = 'inline-block';
                    
                    // ä¿å­˜åˆ°å½“å‰è§’è‰²
                    if (currentCharacterId) {
                        saveCurrentCharacterData();
                    }
                } catch (error) {
                    alert(error);
                }
            }
        };
        
        // ç§»é™¤AIå¤´åƒ
        function removeAIAvatar() {
            config.aiAvatar = null;
            renderAvatar(document.getElementById('ai-avatar-preview-settings'), null, 'ai', config.aiNickname.substring(0, 1));
            document.getElementById('ai-avatar-remove-btn-settings').style.display = 'none';
            if (currentCharacterId) {
                saveCurrentCharacterData();
            }
        }
        
        // ç§»é™¤ç”¨æˆ·å¤´åƒ
        function removeUserAvatar() {
            config.userAvatar = null;
            renderAvatar(document.getElementById('user-avatar-preview-settings'), null, 'user', config.userNickname.substring(0, 1));
            document.getElementById('user-avatar-remove-btn-settings').style.display = 'none';
            if (currentCharacterId) {
                saveCurrentCharacterData();
            }
        }
        
        // æ‹‰é»‘å¥½å‹(æš‚æœªå®ç°)
        function blockCharacter() {
            alert('æ‹‰é»‘åŠŸèƒ½æš‚æœªå¼€æ”¾');
        }
        
        // åˆ é™¤å¥½å‹
        function deleteCharacter() {
            if (!currentCharacterId) {
                alert('æœªé€‰æ‹©è§’è‰²');
                return;
            }
            
            const character = charactersList.find(c => c.id === currentCharacterId);
            if (!character) {
                alert('è§’è‰²ä¸å­˜åœ¨');
                return;
            }
            
            const characterName = character.name || config.aiNickname || 'è¯¥è§’è‰²';
            
            // äºŒæ¬¡ç¡®è®¤
            const confirmed = confirm(
                `ç¡®å®šè¦åˆ é™¤"${characterName}"å—?\n\n` +
                `æ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤:\n` +
                `â€¢ æ‰€æœ‰èŠå¤©è®°å½•\n` +
                `â€¢ é•¿æœŸè®°å¿†æ•°æ®\n` +
                `â€¢ è§’è‰²é…ç½®ä¿¡æ¯\n\n` +
                `æ­¤æ“ä½œæ— æ³•æ’¤é”€!`
            );
            
            if (!confirmed) {
                return;
            }
            
            // å†æ¬¡ç¡®è®¤
            const doubleConfirmed = confirm(`æœ€åç¡®è®¤:çœŸçš„è¦åˆ é™¤"${characterName}"çš„æ‰€æœ‰æ•°æ®å—?`);
            if (!doubleConfirmed) {
                return;
            }
            
            console.log('ğŸ—‘ï¸ å¼€å§‹åˆ é™¤è§’è‰²:', currentCharacterId);
            
            // ä»è§’è‰²åˆ—è¡¨ä¸­ç§»é™¤
            charactersList = charactersList.filter(c => c.id !== currentCharacterId);
            saveCharactersList();
            
            // åˆ é™¤localStorageä¸­çš„æ‰€æœ‰æ•°æ®
            localStorage.removeItem(`char_${currentCharacterId}_config`);
            localStorage.removeItem(`char_${currentCharacterId}_chatHistory`);
            localStorage.removeItem(`char_${currentCharacterId}_longTermMemory`);
            localStorage.removeItem(`char_${currentCharacterId}_pendingSummaryBubbles`);
            
            console.log('âœ… è§’è‰²å·²åˆ é™¤:', currentCharacterId);
            
            // æ¸…ç©ºå½“å‰çŠ¶æ€
            currentCharacterId = null;
            chatHistory = [];
            longTermMemory = getDefaultLongTermMemory();
            pendingSummaryBubbles = [];
            clearRuntimeState();
            
            // è¿”å›è§’è‰²åˆ—è¡¨é¡µé¢
            showPage('chat-list-page');
            renderCharactersList();
            
            alert(`å·²åˆ é™¤"${characterName}"çš„æ‰€æœ‰æ•°æ®`);
        }
        
        // ==================== åº•éƒ¨å¯¼èˆªæ åŠŸèƒ½ ====================
        
        /**
         * åˆå§‹åŒ–åº•éƒ¨å¯¼èˆªæ 
         */
        function initializeBottomNav() {
            const navItems = document.querySelectorAll('.nav-item');
            
            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    const targetPage = item.getAttribute('data-page');
                    switchBottomNavPage(targetPage);
                });
            });
        }
        
        /**
         * åˆ‡æ¢åº•éƒ¨å¯¼èˆªé¡µé¢
         */
        function switchBottomNavPage(pageName) {
            const pageMap = {
                'chat-list': 'chat-list-page',
                'contacts': 'contacts-page',
                'discover': 'discover-page',
                'me': 'me-page'
            };
            
            const targetPageId = pageMap[pageName];
            if (!targetPageId) return;
            
            // æ˜¾ç¤ºç›®æ ‡é¡µé¢
            showPage(targetPageId);
            
            // æ›´æ–°æ‰€æœ‰åº•éƒ¨å¯¼èˆªæ çš„activeçŠ¶æ€
            document.querySelectorAll('.bottom-nav').forEach(nav => {
                nav.querySelectorAll('.nav-item').forEach(item => {
                    if (item.getAttribute('data-page') === pageName) {
                        item.classList.add('active');
                    } else {
                        item.classList.remove('active');
                    }
                });
            });
        }
        
        // ==================== å…¨å±€æ¶ˆæ¯é€šçŸ¥åŠŸèƒ½ ====================
        
        let notificationTimeout = null;
        
        /**
         * åˆå§‹åŒ–æ¶ˆæ¯é€šçŸ¥
         */
        function initializeMessageNotification() {
            const notification = document.getElementById('message-notification');
            
            // ç‚¹å‡»é€šçŸ¥è·³è½¬åˆ°å¯¹åº”èŠå¤©
            notification.addEventListener('click', function(e) {
                // å¦‚æœç‚¹å‡»çš„æ˜¯å…³é—­æŒ‰é’®ï¼Œåªå…³é—­é€šçŸ¥
                if (e.target.classList.contains('message-notification-close')) {
                    hideMessageNotification();
                    return;
                }
                
                // å¦åˆ™è·³è½¬åˆ°èŠå¤©é¡µé¢
                if (currentCharacterId) {
                    showPage('chat-page');
                    hideMessageNotification();
                }
            });
        }
        
        /**
         * æ˜¾ç¤ºæ¶ˆæ¯é€šçŸ¥
         * @param {string} characterId - è§’è‰²ID
         * @param {string} characterName - è§’è‰²åç§°
         * @param {string} message - æ¶ˆæ¯å†…å®¹
         * @param {string} avatarData - å¤´åƒæ•°æ®
         */
        function showMessageNotification(characterId, characterName, message, avatarData) {
            // å¦‚æœå½“å‰åœ¨èŠå¤©é¡µé¢ï¼Œä¸æ˜¾ç¤ºé€šçŸ¥
            const currentPage = document.querySelector('.page.active');
            if (currentPage && currentPage.id === 'chat-page') {
                return;
            }
            
            const notification = document.getElementById('message-notification');
            const avatarEl = document.getElementById('notification-avatar');
            const nameEl = document.getElementById('notification-name');
            const textEl = document.getElementById('notification-text');
            
            // è®¾ç½®å¤´åƒ
            if (avatarData) {
                avatarEl.innerHTML = `<img src="${avatarData}" style="width: 40px; height: 40px; border-radius: 6px; object-fit: cover;">`;
            } else {
                const firstLetter = characterName.substring(0, 1);
                avatarEl.innerHTML = `<div class="default-avatar ai" style="width: 40px; height: 40px; border-radius: 6px; font-size: 16px;">${firstLetter}</div>`;
            }
            
            // è®¾ç½®å†…å®¹
            nameEl.textContent = characterName;
            textEl.textContent = message;
            
            // æ˜¾ç¤ºé€šçŸ¥
            notification.classList.remove('hiding');
            notification.classList.add('show');
            
            // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
            if (notificationTimeout) {
                clearTimeout(notificationTimeout);
            }
            
            // 3ç§’åè‡ªåŠ¨éšè—
            notificationTimeout = setTimeout(() => {
                hideMessageNotification();
            }, 3000);
        }
        
        /**
         * éšè—æ¶ˆæ¯é€šçŸ¥
         */
        function hideMessageNotification() {
            const notification = document.getElementById('message-notification');
            notification.classList.add('hiding');
            
            setTimeout(() => {
                notification.classList.remove('show', 'hiding');
            }, 300);
            
            if (notificationTimeout) {
                clearTimeout(notificationTimeout);
                notificationTimeout = null;
            }
        }
        
        
    </script>

</body>
</html>
